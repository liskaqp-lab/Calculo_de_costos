<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadora de Precios - Productos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { 
      font-family: 'Inter', sans-serif; 
      box-sizing: border-box;
    }
    .card-shadow { box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
    .gradient-bg { background: linear-gradient(135deg, #65C1C0 0%, #6767AD 100%); }
    .orange-gradient { background: linear-gradient(135deg, #EA5F0B 0%, #F4BA3B 100%); }
    .modal-open { display: flex !important; }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.5); }

    /* Estados activos para estrategia (consistentes con la paleta) */
    .estrategia-activa { transform: scale(1.02); box-shadow: 0 8px 20px rgba(103,103,173,.25); }
    .btn-10.estrategia-activa { background: #ecfdf5; border-color: #10b981; }
    .btn-30.estrategia-activa { background: #eff6ff; border-color: #3b82f6; }
    .btn-130.estrategia-activa { background: #faf5ff; border-color: #8b5cf6; }
      /* Estado seleccionado para "Personalizado" */
    #customStrategy.estrategia-activa { background: #fffbeb; border-color: #f59e0b; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.25); }
  </style>
</head>
<body class="gradient-bg min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-6xl">
    <!-- Header -->
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold text-white drop-shadow">Calculadora de Precios Universal</h1>
      <p class="text-white/90 mt-2">Calcula precios autom√°ticamente con estrategias de ganancia</p>
    </div>

    <!-- Configuraci√≥n General -->
    <div class="bg-white rounded-2xl p-4 sm:p-8 card-shadow mb-8">
      <div class="flex items-center mb-6">
        <span class="text-2xl mr-3">‚öôÔ∏è</span>
        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Configuraci√≥n General</h2>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 sm:gap-8">
        <!-- Moneda -->
        <div class="bg-gradient-to-br from-yellow-50 to-amber-50 rounded-xl p-4 sm:p-6 border border-yellow-300">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center mr-3 shrink-0">
              <span class="text-white text-lg">üí±</span>
            </div>
            <div class="min-w-0">
              <h3 class="text-base sm:text-lg font-semibold text-gray-800">Moneda de Trabajo</h3>
              <p class="text-xs sm:text-sm text-yellow-700">Selecciona tu moneda principal</p>
            </div>
          </div>
          <select id="monedaSelector" class="w-full p-3 sm:p-4 border-2 border-yellow-400 rounded-xl focus:ring-2 focus:ring-yellow-500 text-center font-semibold text-base sm:text-lg bg-white shadow-sm transition-all">
            <option value="Q">üá¨üáπ Quetzales (Q)</option>
            <option value="$">üá∫üá∏ D√≥lares ($)</option>
            <option value="‚Ç¨">üá™üá∫ Euros (‚Ç¨)</option>
          </select>
        </div>

        <!-- Impuestos -->
        <div class="bg-gradient-to-br from-slate-50 to-gray-100 rounded-xl p-4 sm:p-6 border border-slate-300">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-3">
            <div class="flex items-center min-w-0">
              <div class="w-10 h-10 bg-slate-600 rounded-lg flex items-center justify-center mr-3 shrink-0">
                <span class="text-white text-lg">üè∑Ô∏è</span>
              </div>
              <div class="min-w-0">
                <h3 class="text-base sm:text-lg font-semibold text-gray-800">Impuestos</h3>
                <p class="text-xs sm:text-sm text-slate-700">Configura los impuestos aplicables</p>
              </div>
            </div>
            <button id="toggleFormularioImpuestos" class="px-3 sm:px-4 py-2 bg-slate-600 text-white rounded-lg hover:bg-slate-700 transition-colors text-xs sm:text-sm font-medium shadow-sm shrink-0">
              + Agregar
            </button>
          </div>

          <!-- Form Impuesto -->
          <div id="formularioImpuestos" class="hidden bg-white p-3 sm:p-4 rounded-lg border border-gray-300 mb-4 shadow-sm">
            <p class="text-xs sm:text-sm text-gray-700 mb-4 font-medium">üí° Ejemplos: IVA Espa√±a 21%, GST Canad√° 5%, ISR M√©xico 16%</p>
            <div class="space-y-4">
              <div>
                <label class="block text-xs sm:text-sm font-medium text-gray-800 mb-2">Nombre del impuesto</label>
                <input type="text" id="nombreImpuestoPersonalizado" placeholder="Ej: IVA, GST, ISR" class="w-full p-2 sm:p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
              </div>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs sm:text-sm font-medium text-gray-800 mb-2">Porcentaje (%)</label>
                  <div class="relative">
                    <input type="number" id="porcentajeImpuestoPersonalizado" placeholder="0.0" step="0.1" min="0" class="w-full pl-3 pr-8 py-2 sm:py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 text-sm">
                    <span class="absolute right-3 top-2 sm:top-3 text-gray-600 font-semibold text-sm">%</span>
                  </div>
                </div>
                <div class="flex items-end">
                  <button id="btnAgregarImpuesto" class="w-full p-2 sm:p-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors font-medium text-sm">
                    ‚úì Confirmar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Lista Impuestos -->
          <div id="listaImpuestosPersonalizados" class="space-y-2 mb-4 hidden"></div>

          <!-- Resumen Impuestos -->
          <div id="resumenImpuestosPersonalizados" class="bg-gradient-to-r from-teal-500 to-blue-500 text-white p-4 rounded-lg shadow-md">
            <div class="flex justify-between items-center">
              <div class="flex items-center">
                <span class="text-2xl mr-2">üìä</span>
                <span class="font-semibold">Total de Impuestos</span>
              </div>
              <span id="totalImpuestosPersonalizados" class="text-2xl font-bold">0.0%</span>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- Contenedor de Productos Adicionales -->
    <div id="productosCompletosContainer" class="space-y-8"></div>

    <!-- Agregar producto -->
    <div class="text-center mb-8 mt-8">
      <button id="btnAddProduct" class="px-8 py-4 orange-gradient text-white rounded-2xl hover:shadow-xl transition-all duration-300 font-bold text-lg shadow-lg transform hover:scale-105">
        + Agregar Nuevo Producto
      </button>
      <p class="text-white/90 mt-2">Productos agregados: <span id="productCount" class="font-bold">0</span></p>
      <p class="text-white/90 mt-1">Cada tarjeta incluye su propia selecci√≥n de estrategia</p>
    </div>

    <!-- Punto de Equilibrio -->
    <div class="bg-white rounded-2xl p-8 card-shadow mb-8">
      <div class="flex items-center mb-6">
        <span class="text-3xl mr-3">‚öñÔ∏è</span>
        <div>
          <h2 class="text-2xl font-bold text-gray-800">Punto de Equilibrio</h2>
          <p class="text-gray-500">An√°lisis basado en tus costos y productos</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h3 class="text-lg font-semibold text-amber-800 mb-4">üìä Datos Calculados Autom√°ticamente</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-amber-700 mb-2">Costos fijos mensuales</label>
              <div class="w-full p-3 bg-gray-100 border border-amber-200 rounded-lg text-amber-800 font-semibold">
                <span class="moneda">Q</span> <span id="costosFijosEquilibrioDisplay">3,800</span>
              </div>
              <p class="text-xs text-amber-600 mt-1">Incluye amortizaci√≥n</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-amber-700 mb-2">Precio promedio</label>
              <div class="w-full p-3 bg-gray-100 border border-amber-200 rounded-lg text-amber-800 font-semibold">
                <span class="moneda">Q</span> <span id="precioPromedioServicioDisplay">1,000</span>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-amber-700 mb-2">Costo variable promedio</label>
              <div class="w-full p-3 bg-gray-100 border border-amber-200 rounded-lg text-amber-800 font-semibold">
                <span class="moneda">Q</span> <span id="costoVariableServicioDisplay">200</span>
              </div>
            </div>
          </div>
        </div>

        <div>
          <h3 class="text-lg font-semibold text-amber-800 mb-4">üìà Resultados del An√°lisis</h3>
          <div class="space-y-4">
            <div class="bg-blue-50 p-4 rounded-lg">
              <p class="text-sm text-blue-700">Margen de contribuci√≥n promedio</p>
              <p id="margenContribucion" class="text-2xl font-bold text-blue-800"><span class="moneda">Q</span> 800</p>
              <p class="text-xs text-blue-600 mt-1">Precio - Costo variable</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
              <p class="text-sm text-green-700">Unidades necesarias</p>
              <p id="serviciosEquilibrio" class="text-2xl font-bold text-green-800">5 unidades/mes</p>
            </div>
            <div class="bg-gradient-to-r from-yellow-700 to-yellow-600 text-white p-4 rounded-lg">
              <p class="text-sm opacity-90">Ingresos m√≠nimos</p>
              <p id="ingresosMinimos" class="text-2xl font-bold"><span class="moneda">Q</span> 4,750</p>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- Cotizaci√≥n -->
    <div class="bg-white rounded-2xl p-8 card-shadow mb-8">
      <div class="flex items-center mb-6">
        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3">üìã</span>
        <div>
          <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Cotizaci√≥n</h2>
          <p class="text-sm sm:text-base text-gray-500">Formato de factura para presentar a clientes</p>
        </div>
      </div>

      <!-- Estrategia de Precio (GLOBAL) -->
      <div class="mb-6">
        <h3 class="text-base sm:text-lg font-semibold text-amber-800 mb-4">üí∞ Estrategia de Precio</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
          <button type="button" class="estrategia-btn btn-10 px-3 sm:px-4 py-3 border-2 border-gray-300 rounded-xl text-center hover:shadow-lg" data-profit="10">
            <div class="text-xl sm:text-2xl mb-1 w-full flex items-center justify-center">üíö</div>
            <h4 class="font-semibold text-gray-700 text-sm sm:text-base">M√≠nimo no negociable</h4>
            <p class="text-xs sm:text-sm text-gray-600">+10% sobre costo de producci√≥n</p>
            <p class="text-xs text-gray-500 mt-1">Precio de supervivencia</p>
          </button>
          <button type="button" class="estrategia-btn btn-30 px-3 sm:px-4 py-3 border-2 border-blue-300 bg-blue-50 rounded-xl text-center hover:shadow-lg estrategia-activa" data-profit="30">
            <div class="text-xl sm:text-2xl mb-1 w-full flex items-center justify-center">üíô</div>
            <h4 class="font-semibold text-blue-700 text-sm sm:text-base">Precio regular</h4>
            <p class="text-xs sm:text-sm text-blue-600">+30% sobre costo de producci√≥n</p>
            <p class="text-xs text-blue-500 mt-1">Precio competitivo</p>
          </button>
          <button type="button" class="estrategia-btn btn-130 px-3 sm:px-4 py-3 border-2 border-purple-300 rounded-xl text-center hover:shadow-lg" data-profit="130">
            <div class="text-xl sm:text-2xl mb-1 w-full flex items-center justify-center">üíú</div>
            <h4 class="font-semibold text-gray-700 text-sm sm:text-base">Precio ideal</h4>
            <p class="text-xs sm:text-sm text-gray-600">+130% sobre costo de producci√≥n</p>
            <p class="text-xs text-gray-500 mt-1">Precio premium</p>
          </button>
          <div id="customStrategy" class="px-3 sm:px-4 py-3 border-2 border-amber-300 rounded-xl flex flex-col items-center justify-center text-center">
            <div class="font-semibold text-amber-800 mb-2 text-sm sm:text-base">Personalizado</div>
            <div class="flex items-center gap-2 mb-1 justify-center">
              <input id="inputCustomProfitGlobal" type="number" min="0" step="1" placeholder="0" class="w-20 sm:w-24 p-2 border border-amber-300 rounded-md text-center text-sm" aria-label="Porcentaje personalizado (global)">
              <span class="text-amber-700 font-semibold text-sm">%</span>
            </div>
            <p class="text-xs text-amber-600">Se aplica autom√°ticamente al escribir</p>
          </div>
        </div>
      </div>

      <!-- Fechas y Beneficios -->
      <div class="mb-6">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-2">üìÖ Fecha de Emisi√≥n</label>
            <input type="date" id="fechaEmisionInput" class="w-full p-3 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-300">
          </div>
          <div>
            <label class="block text-sm font-medium text-amber-700 mb-2">‚è∞ D√≠as de Validez (opcional)</label>
            <input type="number" id="diasValidez" placeholder="30" min="1" class="w-full p-3 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-300">
          </div>
        </div>
        <div id="fechaVencimiento" class="hidden p-3 bg-orange-50 border border-orange-200 rounded-lg">
          <p class="text-sm text-orange-700">
            <span class="font-semibold">‚ö†Ô∏è V√°lida hasta:</span> 
            <span id="fechaVencimientoTexto" class="font-bold"></span>
          </p>
        </div>
      </div>

      <div class="mb-6">
        <label class="block text-sm font-medium text-amber-700 mb-2">üé§ Comentarios (opcional)</label>
        <textarea id="beneficiosClave" rows="3" class="w-full p-3 border border-amber-200 rounded-lg focus:ring-2 focus:ring-amber-300" placeholder="Describe los beneficios..."></textarea>
      </div>

      <!-- Tabla de productos -->
      <div id="cotizacion" class="space-y-6">
        <div class="text-center border-b-2 border-amber-200 pb-6">
          <h1 class="text-3xl font-bold text-amber-900 mb-2">COTIZACI√ìN</h1>
          <p class="text-amber-600">Fecha de emisi√≥n: <span id="fechaEmision"></span></p>
          <p id="validezCotizacion" class="text-amber-600 hidden">V√°lida hasta: <span id="fechaValidez" class="font-semibold"></span></p>
        </div>

        <div id="beneficiosImpresos" class="hidden bg-amber-50 p-4 rounded-lg">
          <h3 class="font-semibold text-amber-800 mb-2">üí° Beneficios Clave:</h3>
          <p id="textoBeneficios" class="text-amber-700"></p>
        </div>

        <div>
          <h3 class="text-base sm:text-lg font-semibold text-amber-800 mb-4">üì¶ Productos y Servicios</h3>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse shadow-lg rounded-xl overflow-hidden min-w-[600px]">
              <thead>
                <tr class="bg-gradient-to-r from-amber-500 to-orange-500 text-white">
                  <th class="p-2 sm:p-4 text-left font-bold text-xs sm:text-sm">Producto/Servicio</th>
                  <th class="p-2 sm:p-4 text-center font-bold text-xs sm:text-sm">Cantidad</th>
                  <th class="p-2 sm:p-4 text-right font-bold text-xs sm:text-sm">Precio Unitario</th>
                  <th class="p-2 sm:p-4 text-right font-bold text-xs sm:text-sm">Margen Contribuci√≥n</th>
                  <th class="p-2 sm:p-4 text-right font-bold text-xs sm:text-sm">Subtotal</th>
                </tr>
              </thead>
              <tbody id="tablaProductosCotizacion"></tbody>
            </table>
          </div>

          <div class="mt-6 flex justify-end">
            <div class="w-full max-w-md">
              <div class="bg-amber-50 p-4 rounded-lg border border-amber-200">
                <div class="flex justify-between items-center py-2 border-b border-amber-200">
                  <span class="font-semibold text-amber-800">TOTAL GENERAL:</span>
                  <span id="totalGeneralCotizacion" class="text-2xl font-bold text-amber-900"><span class="moneda">Q</span> 0</span>
                </div>
                <p class="text-sm text-amber-600 mt-2 italic">* Impuestos incluidos</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumen en pantalla -->
        <div class="border-t border-amber-200 pt-6 info-adicional-print-hide">
          <h3 class="text-lg font-semibold text-amber-800 mb-3">üìä Informaci√≥n Adicional</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-green-50 p-4 rounded-lg text-center">
              <p class="text-sm text-green-700">Ganancia Neta Total</p>
              <p id="gananciaNetaCotizacion" class="text-xl font-bold text-green-800"><span class="moneda">Q</span> 0</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg text-center">
              <p class="text-sm text-blue-700">Margen Promedio</p>
              <p id="margenPromedioCotizacion" class="text-xl font-bold text-blue-800">0%</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg text-center">
              <p class="text-sm text-purple-700">Total Impuestos</p>
              <p id="totalImpuestosCotizacion" class="text-xl font-bold text-purple-800"><span class="moneda">Q</span> 0</p>
            </div>
          </div>
          
          <!-- Bot√≥n de Imprimir -->
          <div class="text-center">
            <button id="btnImprimir" class="px-8 py-4 bg-orange-600 text-white rounded-xl hover:bg-orange-700 transition-colors font-bold text-lg shadow-lg transform hover:scale-105 flex items-center justify-center gap-3 mx-auto">
              <span class="text-2xl">üñ®Ô∏è</span>
              <span>Imprimir Cotizaci√≥n</span>
            </button>
            <p class="text-gray-500 text-sm mt-2">Genera una versi√≥n lista para presentar al cliente</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Proyecciones Financieras -->
    <div class="bg-white rounded-2xl p-4 sm:p-8 card-shadow mb-8">
      <div class="flex items-center mb-6">
        <span class="text-2xl sm:text-3xl mr-2 sm:mr-3">üìà</span>
        <div>
          <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Proyecciones Financieras</h2>
          <p class="text-sm sm:text-base text-gray-500">An√°lisis de mercado y proyecciones basadas en tus productos</p>
        </div>
      </div>

      <!-- Estimaci√≥n de Mercado -->
      <div class="mb-8">
        <h3 class="text-base sm:text-lg font-semibold text-indigo-800 mb-4">üéØ Estimaci√≥n de Mercado</h3>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
          
          <!-- TAM -->
          <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 sm:p-6 border border-blue-200">
            <div class="flex items-center mb-4">
              <div class="w-8 h-8 sm:w-10 sm:h-10 bg-blue-500 rounded-lg flex items-center justify-center mr-3">
                <span class="text-white text-sm sm:text-lg">üåç</span>
              </div>
              <div>
                <h4 class="text-sm sm:text-lg font-semibold text-blue-800">TAM</h4>
                <p class="text-xs sm:text-sm text-blue-600">Total Addressable Market</p>
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-xs sm:text-sm font-medium text-blue-700 mb-2">Tama√±o total del mercado</label>
              <input type="number" id="tamValue" placeholder="Ej. 17000000" min="0" class="w-full p-2 sm:p-3 border border-blue-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
              <p class="text-xs text-blue-600 mt-1">Ejemplo: Poblaci√≥n total del pa√≠s</p>
            </div>
            <div class="bg-blue-100 p-2 sm:p-3 rounded-lg">
              <p class="text-xs sm:text-sm text-blue-800 font-semibold">TAM: <span id="tamDisplay">0</span></p>
            </div>
          </div>

          <!-- SAM -->
          <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 sm:p-6 border border-green-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
              <div class="flex items-center">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-green-500 rounded-lg flex items-center justify-center mr-3">
                  <span class="text-white text-sm sm:text-lg">üéØ</span>
                </div>
                <div>
                  <h4 class="text-sm sm:text-lg font-semibold text-green-800">SAM</h4>
                  <p class="text-xs sm:text-sm text-green-600">Serviceable Available Market</p>
                </div>
              </div>
              <button id="toggleSamForm" class="px-2 sm:px-3 py-1 sm:py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 text-xs shrink-0">+ Filtro</button>
            </div>
            <div class="mb-4">
              <label class="block text-xs sm:text-sm font-medium text-green-700 mb-2">Mercado disponible</label>
              <p class="text-xs text-green-600 mb-3">Ejemplo: Personas con acceso a internet, edad 18-65 a√±os</p>
            </div>
            
            <!-- Formulario SAM -->
            <div id="samForm" class="hidden bg-white p-3 rounded-lg border border-green-300 mb-4">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-green-800 mb-1">Nombre del filtro</label>
                  <input type="text" id="samFilterName" placeholder="Ej. Con acceso a internet" class="w-full p-2 border border-green-300 rounded text-xs">
                </div>
                <div class="flex gap-2 items-end">
                  <div class="flex-1">
                    <label class="block text-xs font-medium text-green-800 mb-1">Porcentaje (%)</label>
                    <input type="number" id="samFilterPercentage" placeholder="0" min="0" max="100" class="w-full p-2 border border-green-300 rounded text-xs">
                  </div>
                  <button id="confirmSamFilter" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-xs">‚úì</button>
                </div>
              </div>
            </div>
            
            <div id="samFilters" class="space-y-2 mb-4"></div>
            
            <div class="bg-green-100 p-2 sm:p-3 rounded-lg">
              <p class="text-xs sm:text-sm text-green-800 font-semibold">SAM: <span id="samDisplay">0</span></p>
              <p class="text-xs text-green-600">Reducci√≥n: <span id="samReduction">0%</span></p>
            </div>
          </div>

          <!-- SOM -->
          <div class="bg-gradient-to-br from-purple-50 to-violet-50 rounded-xl p-4 sm:p-6 border border-purple-200">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4 gap-2">
              <div class="flex items-center">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-purple-500 rounded-lg flex items-center justify-center mr-3">
                  <span class="text-white text-sm sm:text-lg">üèÜ</span>
                </div>
                <div>
                  <h4 class="text-sm sm:text-lg font-semibold text-purple-800">SOM</h4>
                  <p class="text-xs sm:text-sm text-purple-600">Serviceable Obtainable Market</p>
                </div>
              </div>
              <button id="toggleSomForm" class="px-2 sm:px-3 py-1 sm:py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 text-xs shrink-0">+ Filtro</button>
            </div>
            <div class="mb-4">
              <label class="block text-xs sm:text-sm font-medium text-purple-700 mb-2">Mercado alcanzable</label>
              <p class="text-xs text-purple-600 mb-3">Ejemplo: Dispuestos a pagar el precio, en tu zona geogr√°fica</p>
            </div>
            
            <!-- Formulario SOM -->
            <div id="somForm" class="hidden bg-white p-3 rounded-lg border border-purple-300 mb-4">
              <div class="space-y-3">
                <div>
                  <label class="block text-xs font-medium text-purple-800 mb-1">Nombre del filtro</label>
                  <input type="text" id="somFilterName" placeholder="Ej. Dispuestos a pagar" class="w-full p-2 border border-purple-300 rounded text-xs">
                </div>
                <div class="flex gap-2 items-end">
                  <div class="flex-1">
                    <label class="block text-xs font-medium text-purple-800 mb-1">Porcentaje (%)</label>
                    <input type="number" id="somFilterPercentage" placeholder="0" min="0" max="100" class="w-full p-2 border border-purple-300 rounded text-xs">
                  </div>
                  <button id="confirmSomFilter" class="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 text-xs">‚úì</button>
                </div>
              </div>
            </div>
            
            <div id="somFilters" class="space-y-2 mb-4"></div>
            
            <div class="bg-purple-100 p-2 sm:p-3 rounded-lg">
              <p class="text-xs sm:text-sm text-purple-800 font-semibold">SOM: <span id="somDisplay">0</span></p>
              <p class="text-xs text-purple-600">Del SAM: <span id="somPercentage">0%</span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Proyecci√≥n Mensual -->
      <div class="mb-8">
        <h3 class="text-base sm:text-lg font-semibold text-indigo-800 mb-4">üìÖ Proyecci√≥n Mensual (A√±o 1)</h3>
        <div id="monthlyProjectionsContainer"></div>
      </div>

      <!-- T√≠tulo Principal de Proyecciones -->
      <div class="text-center mb-8 proyecciones-print-hide">
        <h2 class="text-2xl sm:text-3xl font-bold text-indigo-900 mb-2">PROYECCIONES FINANCIERAS</h2>
        <div class="w-full h-1 bg-indigo-600 rounded-full"></div>
      </div>

      <!-- Gr√°fica de Escenarios -->
      <div class="mb-8">
        <h3 class="text-base sm:text-lg font-semibold text-indigo-800 mb-4">üìä Gr√°fica de Escenarios</h3>
        <div class="bg-gray-50 rounded-xl p-4 sm:p-6">
          <canvas id="projectionsChart" width="800" height="400" class="w-full max-w-4xl mx-auto bg-white rounded-lg shadow-sm"></canvas>
          <div class="mt-4 text-center">
            <p class="text-xs sm:text-sm text-gray-600">Comparaci√≥n de escenarios de ventas mensuales por producto</p>
          </div>
        </div>
      </div>

      <!-- Resumen por Escenario -->
      <div class="mb-8">
        <h3 class="text-base sm:text-lg font-semibold text-indigo-800 mb-4">üí∞ Resumen por Escenario</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Optimista -->
          <div class="bg-green-50 p-4 rounded-lg border border-green-200">
            <h5 class="font-semibold text-green-800 mb-2">üöÄ Optimista</h5>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-green-700">Unidades:</span>
                <span id="optimistUnits" class="font-bold text-green-800">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-green-700">Ingresos:</span>
                <span id="optimistRevenue" class="font-bold text-green-800"><span class="moneda">Q</span> 0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-green-700">Costos:</span>
                <span id="optimistCosts" class="font-bold text-red-600"><span class="moneda">Q</span> 0</span>
              </div>
              <div class="flex justify-between border-t border-green-300 pt-2">
                <span class="text-green-700">Utilidad:</span>
                <span id="optimistProfit" class="font-bold text-green-800"><span class="moneda">Q</span> 0</span>
              </div>
            </div>
          </div>

          <!-- Realista -->
          <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
            <h5 class="font-semibold text-blue-800 mb-2">üìà Realista</h5>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-blue-700">Unidades:</span>
                <span id="realistUnits" class="font-bold text-blue-800">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-blue-700">Ingresos:</span>
                <span id="realistRevenue" class="font-bold text-blue-800"><span class="moneda">Q</span> 0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-blue-700">Costos:</span>
                <span id="realistCosts" class="font-bold text-red-600"><span class="moneda">Q</span> 0</span>
              </div>
              <div class="flex justify-between border-t border-blue-300 pt-2">
                <span class="text-blue-700">Utilidad:</span>
                <span id="realistProfit" class="font-bold text-blue-800"><span class="moneda">Q</span> 0</span>
              </div>
            </div>
          </div>

          <!-- Pesimista -->
          <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
            <h5 class="font-semibold text-orange-800 mb-2">‚ö†Ô∏è Pesimista</h5>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-orange-700">Unidades:</span>
                <span id="pessimistUnits" class="font-bold text-orange-800">0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-orange-700">Ingresos:</span>
                <span id="pessimistRevenue" class="font-bold text-orange-800"><span class="moneda">Q</span> 0</span>
              </div>
              <div class="flex justify-between">
                <span class="text-orange-700">Costos:</span>
                <span id="pessimistCosts" class="font-bold text-red-600"><span class="moneda">Q</span> 0</span>
              </div>
              <div class="flex justify-between border-t border-orange-300 pt-2">
                <span class="text-orange-700">Utilidad:</span>
                <span id="pessimistProfit" class="font-bold text-orange-800"><span class="moneda">Q</span> 0</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Indicadores Financieros -->
      <div class="mb-8">
        <h3 class="text-base sm:text-lg font-semibold text-indigo-800 mb-4">üíé Indicadores Financieros</h3>
        <div class="bg-gray-50 rounded-xl p-4 sm:p-6">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white p-4 rounded-lg border text-center">
              <p class="text-xs sm:text-sm text-gray-600 mb-1">Inversi√≥n Inicial Total</p>
              <p id="totalInvestment" class="text-lg sm:text-xl font-bold text-red-600"><span class="moneda">Q</span> 0</p>
            </div>
            <div class="bg-white p-4 rounded-lg border text-center">
              <p class="text-xs sm:text-sm text-gray-600 mb-1">Tasa de Descuento (TIR)</p>
              <p id="discountRateDisplay" class="text-lg sm:text-xl font-bold text-blue-600">12%</p>
            </div>
            <div class="bg-white p-4 rounded-lg border text-center">
              <p class="text-xs sm:text-sm text-gray-600 mb-1">A√±os para Rentabilidad</p>
              <p id="yearsToProfit" class="text-lg sm:text-xl font-bold text-green-600">-</p>
            </div>
          </div>
        </div>
      </div>

      <!-- An√°lisis de Rentabilidad -->
      <div class="mb-8">
        <h3 class="text-base sm:text-lg font-semibold text-indigo-800 mb-4">‚ö° An√°lisis de Rentabilidad</h3>
        <div id="profitabilityAnalysis" class="bg-gray-50 rounded-xl p-4 sm:p-6">
          <!-- El contenido se genera din√°micamente -->
        </div>
      </div>



      <!-- Bot√≥n de Imprimir -->
      <div class="text-center proyecciones-print-hide" style="margin-top: 24px;">
        <button id="btnImprimirProyecciones" class="px-6 sm:px-8 py-3 sm:py-4 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-colors font-bold text-sm sm:text-lg shadow-lg transform hover:scale-105 flex items-center justify-center gap-2 sm:gap-3 mx-auto">
          <span class="text-xl sm:text-2xl">üñ®Ô∏è</span>
          <span>Imprimir Proyecciones</span>
        </button>
        <p class="text-gray-500 text-xs sm:text-sm mt-2">Genera un reporte completo de las proyecciones financieras</p>
        
        <!-- Advertencia de Rentabilidad -->
        <div id="warningNoRentable" class="hidden bg-yellow-50 border border-yellow-200 rounded-xl p-4 mt-4 proyecciones-print-hide">
          <div class="flex items-start">
            <span class="text-2xl mr-3 shrink-0">‚ö†Ô∏è</span>
            <div>
              <h4 class="font-semibold text-yellow-800 mb-2">Advertencia: Proyecto No Rentable</h4>
              <p class="text-yellow-700 text-sm mb-2">
                No es recomendable imprimir la proyecci√≥n si el proyecto no es rentable. 
                Ning√∫n escenario genera flujos de caja positivos suficientes para recuperar la inversi√≥n inicial.
              </p>
              <p class="text-yellow-700 text-sm">
                <strong>Acci√≥n requerida:</strong> Ajusta precios, reduce costos o aumenta las proyecciones de ventas antes de generar el reporte.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Modal de eliminaci√≥n (√∫nico) -->
  <div id="deleteModal" class="fixed inset-0 hidden items-center justify-center z-50" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal-backdrop absolute inset-0 bg-black/60"></div>
    <div class="modal-content relative bg-white rounded-2xl p-8 w-11/12 max-w-md shadow-2xl border border-red-100 text-center">
      <div class="mx-auto mb-4 w-20 h-20 rounded-2xl bg-red-50 flex items-center justify-center text-5xl">‚ö†Ô∏è</div>
      <h2 id="modalTitle" class="text-2xl font-extrabold text-gray-900">¬øEst√°s seguro de que deseas eliminar este producto?</h2>
      <p class="text-gray-600 mt-3 mb-6">Esta acci√≥n no se puede deshacer.</p>
      <div class="flex justify-center gap-3">
        <button id="cancelDeleteBtn" class="px-5 py-3 rounded-lg bg-gray-100 text-gray-700 hover:bg-gray-200 focus-ring">Cancelar</button>
        <button id="confirmDeleteBtn" class="px-5 py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 focus-ring">S√≠, eliminar</button>
      </div>
    </div>
  </div>

  <script>
    // Estado global
    let monedaActual = 'Q';
    let contadorProductos = 0; // Sin producto base
    let impuestosPersonalizados = [];
    
    // Estado para proyecciones financieras
    let samFilters = [];
    let somFilters = [];
    let productColors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#06B6D4', '#84CC16', '#F97316'];

    // Helpers
    const qs = (s, root=document) => root.querySelector(s);
    const qsa = (s, root=document) => Array.from(root.querySelectorAll(s));

    // Moneda
    qs('#monedaSelector').addEventListener('change', () => {
      monedaActual = qs('#monedaSelector').value;
      qsa('.moneda').forEach(el => el.textContent = monedaActual);
      calcularProductos();
      actualizarCotizacion();
    });

    // Impuestos: mostrar formulario
    qs('#toggleFormularioImpuestos').addEventListener('click', () => {
      const form = qs('#formularioImpuestos');
      const open = form.classList.contains('hidden');
      form.classList.toggle('hidden', !open);
      qs('#toggleFormularioImpuestos').textContent = open ? 'Cancelar' : '+ Agregar';
      if (!open) { // al cerrar, limpiar
        qs('#nombreImpuestoPersonalizado').value = '';
        qs('#porcentajeImpuestoPersonalizado').value = '';
      }
    });

    // Impuestos: agregar
    qs('#btnAgregarImpuesto').addEventListener('click', (e) => {
      e.preventDefault();
      const nombre = qs('#nombreImpuestoPersonalizado').value.trim();
      const porcentaje = parseFloat(qs('#porcentajeImpuestoPersonalizado').value);
      if (!nombre || isNaN(porcentaje) || porcentaje < 0) { alert('Ingresa un nombre y porcentaje v√°lido'); return; }
      if (impuestosPersonalizados.some(i => i.nombre.toLowerCase() === nombre.toLowerCase())) { alert('Ya existe un impuesto con ese nombre'); return; }
      impuestosPersonalizados.push({ id: Date.now(), nombre, porcentaje });
      renderImpuestos();
      qs('#toggleFormularioImpuestos').click();
      calcularProductos();
      actualizarCotizacion();
    });

    function renderImpuestos(){
      const lista = qs('#listaImpuestosPersonalizados');
      if (impuestosPersonalizados.length === 0) { lista.classList.add('hidden'); }
      else {
        lista.classList.remove('hidden');
        lista.innerHTML = impuestosPersonalizados.map(imp => `
          <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-amber-200">
            <div class="flex items-center space-x-3">
              <span class="text-2xl">üè∑Ô∏è</span>
              <div>
                <p class="font-semibold text-amber-800">${imp.nombre}</p>
                <p class="text-sm text-amber-600">${imp.porcentaje}%</p>
              </div>
            </div>
            <button data-remove-tax="${imp.id}" class="text-red-600 hover:text-red-700 p-2 rounded-lg hover:bg-red-50">üóëÔ∏è</button>
          </div>
        `).join('');
      }
      const total = impuestosPersonalizados.reduce((s, i) => s + i.porcentaje, 0);
      qs('#totalImpuestosPersonalizados').textContent = `${total.toFixed(1)}%`;
    }

    // Delegaci√≥n global de clicks
    document.addEventListener('click', (e) => {
      // Eliminar impuesto
      const btnTax = e.target.closest('[data-remove-tax]');
      if (btnTax) {
        const id = parseInt(btnTax.getAttribute('data-remove-tax'));
        impuestosPersonalizados = impuestosPersonalizados.filter(i => i.id !== id);
        renderImpuestos();
        calcularProductos();
        actualizarCotizacion();
        return;
      }

      // Toggle formularios de filtros
      if (e.target.id === 'toggleSamForm') {
        toggleSamForm();
        return;
      }

      if (e.target.id === 'toggleSomForm') {
        toggleSomForm();
        return;
      }

      // Confirmar filtros
      if (e.target.id === 'confirmSamFilter') {
        confirmSamFilter();
        return;
      }

      if (e.target.id === 'confirmSomFilter') {
        confirmSomFilter();
        return;
      }

      // Bot√≥n imprimir proyecciones
      if (e.target.id === 'btnImprimirProyecciones') {
        imprimirProyecciones();
        return;
      }

      // Eliminar filtros de mercado
      const removeFilterBtn = e.target.closest('[data-remove-filter]');
      if (removeFilterBtn) {
        const type = removeFilterBtn.getAttribute('data-filter-type');
        const id = parseInt(removeFilterBtn.getAttribute('data-remove-filter'));
        if (type === 'sam') {
          samFilters = samFilters.filter(f => f.id !== id);
          renderSamFilters();
        } else if (type === 'som') {
          somFilters = somFilters.filter(f => f.id !== id);
          renderSomFilters();
        }
        calculateMarketSizes();
        updateProjections();
        return;
      }

      // Abrir modal eliminar producto
      const delBtn = e.target.closest('.delete-btn');
      if (delBtn) {
        const card = delBtn.closest('.product-card');
        if (!card) return;
        const id = card.getAttribute('data-product-id');
        const locked = card.getAttribute('data-locked') === 'true';
        if (locked) return;
        openDeleteModal(id);
        return;
      }

      // Estrategias globales (en Cotizaci√≥n)
      const stratBtn = e.target.closest('.estrategia-btn');
      if (stratBtn) {
        qsa('.estrategia-btn').forEach(b => b.classList.remove('estrategia-activa','bg-blue-50','border-blue-300'));
        qs('#customStrategy')?.classList.remove('estrategia-activa');
        stratBtn.classList.add('estrategia-activa');
        const pr = parseFloat(stratBtn.getAttribute('data-profit')) || 30;
        // Aplicar a todas las tarjetas
        qsa('.product-card').forEach(card => card.dataset.profit = String(pr));
        calcularProductos();
        actualizarCotizacion();
        return;
      }

      // Botones del producto base y adicionales
      // Agregar inversi√≥n
      if (e.target.classList.contains('add-inversion')) {
        const card = e.target.closest('.product-card');
        const container = card.querySelector('.inversion-items');
        const row = document.createElement('div');
        row.className = 'flex flex-col sm:flex-row gap-2 sm:gap-3 sm:items-center';
        row.innerHTML = `
          <input type="text" placeholder="Describe el concepto (ej. C√°mara, luces, etc.)" class="flex-1 p-2 border border-teal-400 rounded-lg text-xs sm:text-sm" aria-label="Concepto de inversi√≥n inicial">
          <div class="flex gap-2 items-center">
            <div class="relative w-24 sm:w-28">
              <span class="absolute left-2 top-2 text-teal-700 font-semibold text-xs moneda">${monedaActual}</span>
              <input type="number" value="0" class="w-full pl-6 pr-2 py-2 border border-teal-400 rounded-lg text-xs sm:text-sm">
            </div>
            <button class="eliminar-item text-orange-600 hover:bg-orange-500 hover:text-white p-1 rounded shrink-0">üóëÔ∏è</button>
          </div>
        `;
        container.appendChild(row);
        calcularInversion(); calcularProductos(); actualizarCotizacion();
        return;
      }

      // Agregar costo fijo
      if (e.target.classList.contains('add-fijo')) {
        const card = e.target.closest('.product-card');
        const container = card.querySelector('.costos-fijos');
        const row = document.createElement('div');
        row.className = 'flex flex-col sm:flex-row gap-2 sm:items-center';
        row.innerHTML = `
          <input type="text" placeholder="Ej. alquiler del local" class="flex-1 p-2 border border-teal-400 rounded-lg text-xs" aria-label="Concepto de costo fijo">
          <div class="flex gap-2 items-center">
            <div class="relative w-24 sm:w-28">
              <span class="absolute left-1 top-2 text-teal-700 font-semibold text-xs moneda">${monedaActual}</span>
              <input type="number" value="0" class="w-full pl-4 pr-1 py-2 border border-teal-400 rounded-lg text-xs">
            </div>
            <button class="eliminar-item text-orange-600 hover:bg-orange-500 hover:text-white text-xs p-1 rounded shrink-0">üóëÔ∏è</button>
          </div>
        `;
        container.appendChild(row);
        calcularCostos(); actualizarCotizacion();
        return;
      }

      // Agregar costo variable
      if (e.target.classList.contains('add-variable')) {
        const card = e.target.closest('.product-card');
        const container = card.querySelector('.costos-variables');
        const row = document.createElement('div');
        row.className = 'flex flex-col sm:flex-row gap-2 sm:items-center';
        row.innerHTML = `
          <input type="text" placeholder="Ej. insumos por pieza" class="flex-1 p-2 border border-teal-400 rounded-lg text-xs" aria-label="Concepto de costo variable">
          <div class="flex gap-2 items-center">
            <div class="relative w-24 sm:w-28">
              <span class="absolute left-1 top-2 text-teal-700 font-semibold text-xs moneda">${monedaActual}</span>
              <input type="number" value="0" class="w-full pl-4 pr-1 py-2 border border-teal-400 rounded-lg text-xs">
            </div>
            <button class="eliminar-item text-orange-600 hover:bg-orange-500 hover:text-white text-xs p-1 rounded shrink-0">üóëÔ∏è</button>
          </div>
        `;
        container.appendChild(row);
        calcularCostos(); actualizarCotizacion();
        return;
      }

      // Eliminar item
      if (e.target.classList.contains('eliminar-item') || e.target.textContent.includes('üóëÔ∏è')) {
        const btn = e.target;
        
        // Buscar la fila que contiene este bot√≥n
        // Subir por el DOM hasta encontrar un elemento que:
        // 1. Sea un div
        // 2. Contenga al menos un input
        // 3. Su padre sea uno de los contenedores v√°lidos
        let currentElement = btn;
        let targetRow = null;
        
        while (currentElement && currentElement !== document.body) {
          currentElement = currentElement.parentElement;
          
          if (currentElement && 
              currentElement.tagName === 'DIV' && 
              currentElement.querySelector('input') &&
              currentElement.parentElement) {
            
            const parentContainer = currentElement.parentElement;
            if (parentContainer.classList.contains('inversion-items') || 
                parentContainer.classList.contains('costos-fijos') || 
                parentContainer.classList.contains('costos-variables')) {
              targetRow = currentElement;
              break;
            }
          }
        }
        
        // Si encontramos la fila correcta, eliminarla
        if (targetRow) {
          targetRow.remove();
          calcularInversion(); 
          calcularCostos(); 
          calcularProductos(); 
          actualizarCotizacion();
        }
        return;
      }
    });

    // Modal de eliminaci√≥n
    const modal = qs('#deleteModal');
    const confirmBtn = qs('#confirmDeleteBtn');
    const cancelBtn = qs('#cancelDeleteBtn');
    let lastFocused = null;

    function actualizarConteoProductos(){
      const allCards = qsa('.product-card');
      const el = qs('#productCount');
      if (el) el.textContent = String(allCards.length);
      return allCards.length;
    }

    function openDeleteModal(targetId) {
      modal.dataset.targetId = targetId;
      lastFocused = document.activeElement;
      modal.classList.add('modal-open');
      cancelBtn.focus();
      document.addEventListener('keydown', handleModalKeys);
    }
    function closeDeleteModal() {
      modal.classList.remove('modal-open');
      modal.dataset.targetId = '';
      document.removeEventListener('keydown', handleModalKeys);
      if (lastFocused) lastFocused.focus();
    }
    function handleModalKeys(e) {
      if (e.key === 'Escape') { e.preventDefault(); closeDeleteModal(); }
      if (e.key === 'Tab') {
        const list = qsa('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])', modal)
          .filter(el => !el.disabled);
        if (list.length === 0) return;
        const first = list[0], last = list[list.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
    }
    modal.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-backdrop')) closeDeleteModal();
    });
    cancelBtn.addEventListener('click', (e) => { e.preventDefault(); closeDeleteModal(); });
    confirmBtn.addEventListener('click', (e) => {
      e.preventDefault();
      const id = modal.dataset.targetId;
      if (!id) { closeDeleteModal(); return; }
      const card = qs(`.product-card[data-product-id="${CSS.escape(id)}"]`);
      if (card) {
        // Eliminar tarjeta
        card.remove();
        // Actualizar contador global seg√∫n tarjetas visibles
        const count = actualizarConteoProductos();
        // Renumerar lo visible para mantener P-1, P-2, P-3...
        renumerarTarjetas();
        // Reajustar numeraci√≥n futura: existentes = siguiente √≠ndice
        contadorProductos = count;
        calcularInversion();
        calcularCostos();
        calcularProductos(); // Ya incluye updateProjectionCalculations()
        calcularEquilibrio();
        actualizarCotizacion();
        updateMonthlyProjections(); // RECONSTRUIR tablas cuando se elimina producto
      }
      closeDeleteModal();
    });

    // Ingresar % personalizado global (aplica en vivo a todas las tarjetas)
    qs('#inputCustomProfitGlobal').addEventListener('input', (e) => {
      const val = parseFloat(e.target.value);
      const customBlock = qs('#customStrategy');
      if (isNaN(val) || val < 0) { customBlock.classList.remove('estrategia-activa'); return; }
      qsa('.product-card').forEach(card => card.dataset.profit = String(val));
      qsa('.estrategia-btn').forEach(b => b.classList.remove('estrategia-activa'));
      customBlock.classList.add('estrategia-activa');
      calcularProductos();
      actualizarCotizacion();
    });

    // Agregar nuevo producto
    qs('#btnAddProduct').addEventListener('click', () => {
      // Determinar siguiente √≠ndice basado en tarjetas existentes
      const currentCount = actualizarConteoProductos();
      contadorProductos = currentCount + 1; // siguiente n√∫mero
      const card = crearTarjetaProducto(contadorProductos);
      qs('#productosCompletosContainer').appendChild(card);
      actualizarConteoProductos();
      renumerarTarjetas();
      calcularProductos(); // Ya incluye updateProjectionCalculations()
      actualizarCotizacion();
      updateMonthlyProjections(); // RECONSTRUIR tablas cuando se agrega producto
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    function renumerarTarjetas() {
      // Asegura t√≠tulos y IDs consecutivos a partir de 1
      let index = 1;
      qsa('.product-card').forEach(card => {
        card.setAttribute('data-product-id', String(index));
        const title = card.querySelector('.product-title');
        if (title) title.textContent = `üì¶ PRODUCTO ${index}`;
        const idBadge = card.querySelector('span.bg-gray-100');
        if (idBadge) idBadge.textContent = `ID: P-${index}`;
        index++;
      });
    }

    function crearTarjetaProducto(id, esRestauracion = false) {
      if (esRestauracion) {
        console.log(`üèóÔ∏è Creando tarjeta para restauraci√≥n - ID: ${id}`);
      }
      
      const wrapper = document.createElement('div');
      wrapper.className = 'product-card bg-white rounded-3xl p-8 border-2 border-teal-400 card-shadow mb-8';
      wrapper.setAttribute('data-product-id', String(id));
      wrapper.setAttribute('data-profit', '30');

      wrapper.innerHTML = `
        <div class="flex items-center justify-between mb-8">
          <div class="text-center mx-auto">
            <h2 class="text-3xl font-bold text-gray-800 product-title">üì¶ PRODUCTO ${id}</h2>
            <p class="text-gray-500 mt-1">Configuraci√≥n completa</p>
          </div>
          <span class="ml-4 px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-700 font-semibold shrink-0">ID: P-${id}</span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
          <div class="bg-gray-50 rounded-2xl p-6 h-full">
            <div class="flex items-center mb-4">
              <span class="text-2xl mr-3">üí∞</span>
              <div>
                <h4 class="text-lg font-bold text-gray-800">Inversi√≥n Inicial</h4>
                <p class="text-gray-500 text-sm">Gastos para arrancar</p>
              </div>
            </div>
            <div class="inversion-items space-y-3 mb-4">
            </div>
            <button class="w-full p-2 bg-teal-500 text-white rounded-lg hover:bg-teal-600 transition-colors mb-3 font-medium text-sm add-inversion">+ Agregar costo inicial</button>
            <div class="bg-gradient-to-r from-gray-800 to-indigo-700 text-white p-3 rounded-lg text-center">
              <p class="text-sm font-semibold">Total Inversi√≥n</p>
              <p class="total-inversion text-xl font-bold"><span class="moneda">${monedaActual}</span> 0</p>
            </div>
          </div>

          <div class="bg-gray-50 rounded-2xl p-6 h-full">
            <div class="flex items-center mb-4">
              <span class="text-2xl mr-3">üìä</span>
              <div>
                <h4 class="text-lg font-bold text-gray-800">Costos Mensuales</h4>
                <p class="text-gray-500 text-sm">Fijos y variables</p>
              </div>
            </div>

            <div class="mb-4">
              <h5 class="text-sm font-semibold text-teal-700 mb-2">Costos Fijos</h5>
              <div class="costos-fijos space-y-2 mb-3">
              </div>
              <button class="w-full p-2 bg-blue-100 text-blue-800 rounded-lg hover:bg-blue-200 transition-colors text-xs mb-2 add-fijo">+ Agregar fijo</button>
              <div class="p-2 bg-blue-50 rounded-lg">
                <p class="font-semibold text-blue-800 text-xs">Total Fijos: <span class="total-fijos"><span class="moneda">${monedaActual}</span> 0</span></p>
              </div>
            </div>

            <div class="mb-4">
              <h5 class="text-sm font-semibold text-purple-700 mb-2">Costos Variables</h5>
              <div class="costos-variables space-y-2 mb-3">
              </div>
              <button class="w-full p-2 bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 transition-colors text-xs mb-2 add-variable">+ Agregar variable</button>
              <div class="p-2 bg-purple-50 rounded-lg">
                <p class="font-semibold text-purple-800 text-xs">Total Variables: <span class="total-variables"><span class="moneda">${monedaActual}</span> 0</span></p>
              </div>
            </div>

            <div class="border-t border-gray-300 pt-4">
              <h5 class="text-sm font-semibold text-gray-700 mb-2">‚è∞ Horas de Trabajo</h5>
              <p class="text-xs text-gray-600 mb-3">Consejo: indica tus horas/d√≠a, d√≠as/mes, horas del proyecto y tu tarifa. Esto impacta el costo fijo mensual.</p>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Horas trabajadas por d√≠a</label>
                  <input type="number" placeholder="Ej. 6" aria-label="Horas trabajadas por d√≠a" min="0" class="horas-por-dia w-full p-2 border border-teal-400 rounded-lg text-xs">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">D√≠as laborables por mes</label>
                  <input type="number" placeholder="Ej. 22" aria-label="D√≠as laborables por mes" min="0" class="dias-por-mes w-full p-2 border border-teal-400 rounded-lg text-xs">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Horas totales del proyecto</label>
                  <input type="number" placeholder="Ej. 12" aria-label="Horas totales del proyecto" min="0" class="horas-proyecto w-full p-2 border border-teal-400 rounded-lg text-xs">
                </div>
                <div>
                  <label class="block text-xs font-medium text-gray-700 mb-1">Tarifa por hora</label>
                  <div class="relative">
                    <span class="absolute left-1 top-2 text-teal-700 font-semibold text-xs moneda">${monedaActual}</span>
                    <input type="number" placeholder="Ej. 150" aria-label="Tarifa por hora" min="0" class="honorarios-hora w-full pl-4 pr-1 py-2 border border-teal-400 rounded-lg text-xs">
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="bg-gray-50 rounded-2xl p-6 mb-6">
          <div class="flex items-center mb-4">
            <span class="text-2xl mr-3">üõçÔ∏è</span>
            <div>
              <h4 class="text-lg font-bold text-gray-800">Configuraci√≥n</h4>
              <p class="text-gray-500 text-sm">Precio y producci√≥n</p>
            </div>
          </div>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Nombre del producto</label>
              <input type="text" value="Producto ${id}" class="nombre-producto w-full p-3 border border-teal-400 rounded-lg focus:ring-2 focus:ring-indigo-400" oninput="actualizarTituloProducto(this)">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Costo de producci√≥n (auto)</label>
              <div class="relative">
                <span class="absolute left-3 top-3 text-teal-700 font-semibold moneda">${monedaActual}</span>
                <input type="number" value="0" class="costo-produccion w-full pl-8 pr-3 py-3 border border-teal-400 rounded-lg bg-gray-100" readonly>
              </div>
            </div>
            <div class="bg-green-50 rounded-lg px-4 py-3 text-green-800 text-sm">El precio se calcula autom√°ticamente con la estrategia seleccionada.</div>
            <div>
              <label class="block text-sm font-medium text-gray-600 mb-2">Unidades producidas/mes</label>
              <input type="number" value="1" min="1" class="unidades-mensuales w-full p-3 border border-teal-400 rounded-lg focus:ring-2 focus:ring-indigo-400">
            </div>
          </div>
        </div>

        <!-- Resultados -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
          <div class="bg-blue-50 p-3 rounded-lg text-center">
            <p class="text-xs text-blue-700">Costo total</p>
            <p class="costo-total text-sm font-bold text-blue-800"><span class="moneda">${monedaActual}</span> 0</p>
          </div>
          <div class="bg-red-50 p-3 rounded-lg text-center">
            <p class="text-xs text-red-700">Impuestos</p>
            <p class="total-impuestos text-sm font-bold text-red-800"><span class="moneda">${monedaActual}</span> 0</p>
          </div>
          <div class="bg-purple-50 p-3 rounded-lg text-center">
            <p class="text-xs text-purple-700">Margen</p>
            <p class="margen-porcentaje text-sm font-bold text-purple-800">0%</p>
          </div>
        </div>

        <div class="text-center pt-6 border-t border-gray-200 mt-6">
          <button class="delete-btn px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors font-medium shadow-md" aria-label="Eliminar este producto">
            üóëÔ∏è Eliminar Producto
          </button>
        </div>
      `;
      
      return wrapper;
    }

    // C√°lculos
    function calcInversionCard(card) {
      let total = 0;
      qsa('.inversion-items input[type="number"]', card).forEach(i => {
        const valor = parseFloat(i.value) || 0;
        total += valor;
      });
      const target = qs('.total-inversion', card);
      if (target) target.innerHTML = `<span class="moneda">${monedaActual}</span> ${Math.round(total).toLocaleString()}`;
      return total;
    }

    function calcularInversion() {
      qsa('.product-card').forEach(card => calcInversionCard(card));
    }

    function calcCostosCard(card) {
      // Calcular costos fijos (sin honorarios por ahora)
      let totalFijos = 0;
      qsa('.costos-fijos input[type="number"]', card).forEach(i => {
        const valor = parseFloat(i.value) || 0;
        totalFijos += valor;
      });

      // Agregar honorarios mensuales a costos fijos
      const hpd = parseFloat(qs('.horas-por-dia', card)?.value) || 0;
      const dpm = parseFloat(qs('.dias-por-mes', card)?.value) || 0;
      const hh = parseFloat(qs('.honorarios-hora', card)?.value) || 0;
      const honorariosMensuales = hpd * dpm * hh;
      totalFijos += honorariosMensuales;

      // Mostrar total de costos fijos
      const fijosEl = qs('.total-fijos', card);
      if (fijosEl) fijosEl.innerHTML = `<span class="moneda">${monedaActual}</span> ${Math.round(totalFijos).toLocaleString()}`;

      // Calcular costos variables
      let totalVariables = 0;
      qsa('.costos-variables input[type="number"]', card).forEach(i => {
        const valor = parseFloat(i.value) || 0;
        totalVariables += valor;
      });

      // Mostrar total de costos variables
      const varEl = qs('.total-variables', card);
      if (varEl) varEl.innerHTML = `<span class="moneda">${monedaActual}</span> ${Math.round(totalVariables).toLocaleString()}`;

      return { totalFijos, totalVariables };
    }

    function calcularCostos() {
      qsa('.product-card').forEach(card => calcCostosCard(card));
    }

    function calcularProductos() {
      const impRate = impuestosPersonalizados.reduce((s, i) => s + i.porcentaje, 0);
      
      qsa('.product-card').forEach(card => {
        const unidades = parseFloat(qs('.unidades-mensuales', card)?.value) || 1;
        
        // Obtener inversi√≥n y calcular amortizaci√≥n mensual
        const inversion = calcInversionCard(card);
        const amortMensual = inversion / 12;

        // Obtener costos mensuales
        const { totalFijos, totalVariables } = calcCostosCard(card);
        
        // Calcular costo de producci√≥n por unidad
        const costoFijoUnidad = unidades > 0 ? (totalFijos + amortMensual) / unidades : 0;
        const costoVariableUnidad = unidades > 0 ? totalVariables / unidades : 0;
        const costoProduccion = costoFijoUnidad + costoVariableUnidad;
        
        // Actualizar campo de costo de producci√≥n
        const cpEl = qs('.costo-produccion', card);
        if (cpEl) cpEl.value = costoProduccion.toFixed(2);

        // Calcular precio con margen de ganancia
        const profit = parseFloat(card.dataset.profit || '30') || 30;
        const precioSinImpuestos = costoProduccion * (1 + profit / 100);
        
        // Calcular impuestos sobre el precio
        const impuestos = precioSinImpuestos * impRate / 100;
        const precioFinal = precioSinImpuestos + impuestos;
        
        // Calcular ganancia neta (precio final - costo - impuestos)
        const gananciaNeta = precioFinal - costoProduccion - impuestos;
        const margenPct = precioFinal > 0 ? (gananciaNeta / precioFinal) * 100 : 0;

        // Actualizar displays
        const costoTotalEl = qs('.costo-total', card);
        if (costoTotalEl) costoTotalEl.innerHTML = `<span class="moneda">${monedaActual}</span> ${costoProduccion.toFixed(2)}`;
        
        const impuestosEl = qs('.total-impuestos', card);
        if (impuestosEl) impuestosEl.innerHTML = `<span class="moneda">${monedaActual}</span> ${impuestos.toFixed(2)}`;
        
        const margenEl = qs('.margen-porcentaje', card);
        if (margenEl) margenEl.textContent = `${margenPct.toFixed(1)}%`;
      });

      // Recalcular equilibrio y cotizaci√≥n despu√©s de actualizar productos
      calcularEquilibrio();
      actualizarCotizacion();
      
      // üîß OPTIMIZACI√ìN: Solo actualizar c√°lculos de proyecciones, no reconstruir tablas
      updateProjectionCalculations();
    }

    function calcularEquilibrio() {
      const cards = qsa('.product-card');
      let totalFijosMensuales = 0;
      let totalInversion = 0;
      let sumaPrecios = 0;
      let sumaCostosVariablesUnitarios = 0;
      let totalUnidades = 0;
      let productosValidos = 0;

      cards.forEach(card => {
        // Sumar costos fijos mensuales (incluyendo honorarios)
        qsa('.costos-fijos input[type="number"]', card).forEach(i => {
          totalFijosMensuales += parseFloat(i.value) || 0;
        });
        
        const hpd = parseFloat(qs('.horas-por-dia', card)?.value) || 0;
        const dpm = parseFloat(qs('.dias-por-mes', card)?.value) || 0;
        const hh = parseFloat(qs('.honorarios-hora', card)?.value) || 0;
        totalFijosMensuales += (hpd * dpm * hh);

        // Sumar inversi√≥n total
        qsa('.inversion-items input[type="number"]', card).forEach(i => {
          totalInversion += parseFloat(i.value) || 0;
        });

        // Calcular datos por producto para promedios ponderados
        const unidades = parseFloat(qs('.unidades-mensuales', card)?.value) || 1;
        const costoProduccion = parseFloat(qs('.costo-produccion', card)?.value) || 0;
        const profit = parseFloat(card.dataset.profit || '30') || 30;
        
        // Precio de venta unitario (sin impuestos para an√°lisis de equilibrio)
        const precioVentaUnitario = costoProduccion * (1 + profit / 100);
        
        // Costo variable unitario (solo costos variables, sin fijos ni amortizaci√≥n)
        let costosVariablesCard = 0;
        qsa('.costos-variables input[type="number"]', card).forEach(i => {
          costosVariablesCard += parseFloat(i.value) || 0;
        });
        const costoVariableUnitario = unidades > 0 ? costosVariablesCard / unidades : 0;

        // Acumular para promedios ponderados por unidades
        sumaPrecios += precioVentaUnitario * unidades;
        sumaCostosVariablesUnitarios += costoVariableUnitario * unidades;
        totalUnidades += unidades;
        productosValidos++;
      });

      // Calcular amortizaci√≥n mensual de la inversi√≥n
      const amortizacionMensual = totalInversion / 12;
      
      // Total de costos fijos mensuales (incluyendo amortizaci√≥n)
      const costosFijosTotales = totalFijosMensuales + amortizacionMensual;
      
      // Promedios ponderados por unidades producidas
      const precioVentaPromedio = totalUnidades > 0 ? sumaPrecios / totalUnidades : 0;
      const costoVariablePromedio = totalUnidades > 0 ? sumaCostosVariablesUnitarios / totalUnidades : 0;

      // Actualizar displays
      qs('#costosFijosEquilibrioDisplay').textContent = Math.round(costosFijosTotales).toLocaleString();
      qs('#precioPromedioServicioDisplay').textContent = Math.round(precioVentaPromedio).toLocaleString();
      qs('#costoVariableServicioDisplay').textContent = Math.round(costoVariablePromedio).toLocaleString();

      // F√ìRMULA CORRECTA DEL PUNTO DE EQUILIBRIO:
      // PE = Costos Fijos Totales / (Precio de Venta Unitario - Costo Variable Unitario)
      const margenContribucionUnitario = precioVentaPromedio - costoVariablePromedio;
      const unidadesEquilibrio = margenContribucionUnitario > 0 ? costosFijosTotales / margenContribucionUnitario : 0;
      const ingresosMinimos = unidadesEquilibrio * precioVentaPromedio;

      qs('#margenContribucion').innerHTML = `<span class="moneda">${monedaActual}</span> ${Math.round(margenContribucionUnitario).toLocaleString()}`;
      qs('#serviciosEquilibrio').textContent = `${Math.ceil(unidadesEquilibrio)} unidades/mes`;
      qs('#ingresosMinimos').innerHTML = `<span class="moneda">${monedaActual}</span> ${Math.round(ingresosMinimos).toLocaleString()}`;
    }

    // Cotizaci√≥n
    function actualizarCotizacion() {
      // fechas
      const fechaInput = qs('#fechaEmisionInput');
      let fechaEmision = fechaInput.value ? new Date(fechaInput.value + 'T00:00:00') : new Date();
      if (!fechaInput.value) fechaInput.value = fechaEmision.toISOString().split('T')[0];

      const format = fechaEmision.toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
      qs('#fechaEmision').textContent = format;

      const diasValidez = parseInt(qs('#diasValidez').value);
      const fechaVencDiv = qs('#fechaVencimiento');
      const validezP = qs('#validezCotizacion');
      if (diasValidez && diasValidez > 0) {
        const fv = new Date(fechaEmision); fv.setDate(fv.getDate() + diasValidez);
        const fvf = fv.toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric'});
        qs('#fechaVencimientoTexto').textContent = fvf;
        qs('#fechaValidez').textContent = fvf;
        fechaVencDiv.classList.remove('hidden'); validezP.classList.remove('hidden');
      } else { fechaVencDiv.classList.add('hidden'); validezP.classList.add('hidden'); }

      // beneficios
      const beneficios = (qs('#beneficiosClave').value || '').trim();
      const bDiv = qs('#beneficiosImpresos'); const bText = qs('#textoBeneficios');
      if (beneficios) { bDiv.classList.remove('hidden'); bText.textContent = beneficios; } else { bDiv.classList.add('hidden'); }

      // tabla
      const tbody = qs('#tablaProductosCotizacion');
      const cards = qsa('.product-card');
      let totalGeneral = 0, totalGananciaNeta = 0, totalImpuestos = 0, acumMargenPct = 0, count = 0;
      const impRate = impuestosPersonalizados.reduce((s,i)=>s+i.porcentaje,0);

      tbody.innerHTML = cards.map((card, index) => {
        const nombre = qs('.nombre-producto', card)?.value || 'Sin nombre';
        const unidades = parseFloat(qs('.unidades-mensuales', card)?.value) || 1;
        const costoProduccion = parseFloat(qs('.costo-produccion', card)?.value) || 0;
        const profit = parseFloat(card.dataset.profit || '30') || 30;
        
        // Precio sin impuestos
        const precioSinImpuestos = costoProduccion * (1 + profit / 100);
        
        // Impuestos sobre el precio
        const impuestosUnitarios = precioSinImpuestos * impRate / 100;
        
        // Precio final (con impuestos)
        const precioFinal = precioSinImpuestos + impuestosUnitarios;
        
        // Margen de contribuci√≥n (precio sin impuestos - costo)
        const margenContribucion = precioSinImpuestos - costoProduccion;
        
        // Ganancia neta (precio final - costo - impuestos)
        const gananciaNeta = precioFinal - costoProduccion - impuestosUnitarios;

        // Totales
        const subtotalSinImpuestos = precioSinImpuestos * unidades;
        const subtotalImpuestos = impuestosUnitarios * unidades;
        const subtotalFinal = precioFinal * unidades;
        const subtotalGananciaNeta = gananciaNeta * unidades;

        totalGeneral += subtotalFinal;
        totalGananciaNeta += subtotalGananciaNeta;
        totalImpuestos += subtotalImpuestos;
        
        const margPct = precioFinal > 0 ? (gananciaNeta / precioFinal) * 100 : 0;
        acumMargenPct += margPct; 
        count++;

        return `
          <tr class="hover:bg-amber-50 transition-colors duration-200 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
            <td class="p-2 sm:p-4 font-medium text-gray-800 text-xs sm:text-sm">${nombre}</td>
            <td class="p-2 sm:p-4 text-center text-gray-700 text-xs sm:text-sm">${unidades}</td>
            <td class="p-2 sm:p-4 text-right text-gray-700 text-xs sm:text-sm"><span class="moneda">${monedaActual}</span> ${precioFinal.toFixed(2)}</td>
            <td class="p-2 sm:p-4 text-right text-green-600 font-semibold text-xs sm:text-sm"><span class="moneda">${monedaActual}</span> ${margenContribucion.toFixed(2)}</td>
            <td class="p-2 sm:p-4 text-right font-bold text-amber-800 text-xs sm:text-sm"><span class="moneda">${monedaActual}</span> ${subtotalFinal.toFixed(2)}</td>
          </tr>
        `;
      }).join('');

      qs('#totalGeneralCotizacion').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalGeneral.toFixed(2)}`;
      qs('#gananciaNetaCotizacion').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalGananciaNeta.toFixed(2)}`;
      qs('#totalImpuestosCotizacion').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalImpuestos.toFixed(2)}`;
      const margenProm = count > 0 ? (acumMargenPct / count) : 0;
      qs('#margenPromedioCotizacion').textContent = `${margenProm.toFixed(1)}%`;
    }

    // Impresi√≥n solo de cotizaci√≥n
    qs('#btnImprimir').addEventListener('click', () => {
      actualizarCotizacion();
      
      // Crear una nueva ventana para imprimir
      const printWindow = window.open('', '_blank');
      const cotizacionContent = qs('#cotizacion').innerHTML;
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Cotizaci√≥n</title>
          <style>
            body {
              font-family: 'Inter', Arial, sans-serif;
              margin: 0;
              padding: 20px;
              background: white;
              color: #000;
              line-height: 1.4;
            }
            .text-center { text-align: center; }
            .text-left { text-align: left; }
            .text-right { text-align: right; }
            .font-bold { font-weight: bold; }
            .font-semibold { font-weight: 600; }
            .text-3xl { font-size: 1.875rem; }
            .text-2xl { font-size: 1.5rem; }
            .text-xl { font-size: 1.25rem; }
            .text-lg { font-size: 1.125rem; }
            .text-sm { font-size: 0.875rem; }
            .text-xs { font-size: 0.75rem; }
            .mb-2 { margin-bottom: 0.5rem; }
            .mb-3 { margin-bottom: 0.75rem; }
            .mb-4 { margin-bottom: 1rem; }
            .mb-6 { margin-bottom: 1.5rem; }
            .mt-2 { margin-top: 0.5rem; }
            .mt-6 { margin-top: 1.5rem; }
            .p-3 { padding: 0.75rem; }
            .p-4 { padding: 1rem; }
            .pb-6 { padding-bottom: 1.5rem; }
            .pt-6 { padding-top: 1.5rem; }
            .border-b-2 { border-bottom: 2px solid #d97706; }
            .bg-amber-50 { background-color: #fffbeb; }
            .text-amber-900 { color: #78350f; }
            .text-amber-800 { color: #92400e; }
            .text-amber-700 { color: #b45309; }
            .text-amber-600 { color: #d97706; }
            .rounded-lg { border-radius: 0.5rem; }
            .space-y-6 > * + * { margin-top: 1.5rem; }
            .space-y-4 > * + * { margin-top: 1rem; }
            .grid { display: grid; }
            .grid-cols-1 { grid-template-columns: repeat(1, minmax(0, 1fr)); }
            .grid-cols-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
            .gap-4 { gap: 1rem; }
            .max-w-md { max-width: 28rem; }
            .w-full { width: 100%; }
            .flex { display: flex; }
            .justify-end { justify-content: flex-end; }
            .justify-between { justify-content: space-between; }
            .items-center { align-items: center; }
            .overflow-x-auto { overflow-x: auto; }
            .border-collapse { border-collapse: collapse; }
            .border { border: 1px solid #d97706; }
            .border-amber-200 { border-color: #fde68a; }
            .italic { font-style: italic; }
            .hidden { display: none; }
            
            table {
              width: 100%;
              border-collapse: collapse;
              margin: 1rem 0;
              box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
              border-radius: 12px;
              overflow: hidden;
            }
            
            th, td {
              padding: 12px 16px;
              text-align: left;
            }
            
            th {
              background: linear-gradient(to right, #f59e0b, #ea580c);
              font-weight: bold;
              color: white;
            }
            
            tr:nth-child(even) {
              background-color: #f9fafb;
            }
            
            tr:nth-child(odd) {
              background-color: white;
            }
            
            .text-green-600 { color: #059669; }
            .text-gray-800 { color: #1f2937; }
            .text-gray-700 { color: #374151; }
            
            .info-adicional-print-hide {
              display: none;
            }
            
            @media print {
              body { margin: 0; }
              @page { margin: 0.5in; }
            }
          </style>
        </head>
        <body>
          <div class="space-y-6">
            ${cotizacionContent}
          </div>
        </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // Esperar a que se cargue el contenido y luego imprimir
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
          
          // üîì REACTIVAR GUARDADO AUTOM√ÅTICO despu√©s de imprimir
          autoSaveEnabled = true;
          console.log('üîì Guardado autom√°tico REACTIVADO despu√©s de impresi√≥n');
        }, 250);
      };
    });

    // Inicializaci√≥n
    function initFechas() {
      const fechaInput = qs('#fechaEmisionInput');
      if (!fechaInput.value) {
        const today = new Date();
        fechaInput.value = today.toISOString().split('T')[0];
      }
      actualizarCotizacion();
    }

    // Funciones para proyecciones financieras
    function toggleSamForm() {
      const form = qs('#samForm');
      const btn = qs('#toggleSamForm');
      const isHidden = form.classList.contains('hidden');
      
      if (isHidden) {
        form.classList.remove('hidden');
        btn.textContent = 'Cancelar';
        qs('#samFilterName').focus();
      } else {
        form.classList.add('hidden');
        btn.textContent = '+ Filtro';
        qs('#samFilterName').value = '';
        qs('#samFilterPercentage').value = '';
      }
    }

    function toggleSomForm() {
      const form = qs('#somForm');
      const btn = qs('#toggleSomForm');
      const isHidden = form.classList.contains('hidden');
      
      if (isHidden) {
        form.classList.remove('hidden');
        btn.textContent = 'Cancelar';
        qs('#somFilterName').focus();
      } else {
        form.classList.add('hidden');
        btn.textContent = '+ Filtro';
        qs('#somFilterName').value = '';
        qs('#somFilterPercentage').value = '';
      }
    }

    function confirmSamFilter() {
      const name = qs('#samFilterName').value.trim();
      const percentage = parseFloat(qs('#samFilterPercentage').value);
      
      if (!name || isNaN(percentage) || percentage <= 0 || percentage > 100) {
        alert('Ingresa un nombre v√°lido y un porcentaje entre 1 y 100');
        return;
      }
      
      samFilters.push({
        id: Date.now(),
        name: name,
        percentage: percentage
      });
      
      renderSamFilters();
      toggleSamForm();
      calculateMarketSizes();
      updateProjections();
    }

    function confirmSomFilter() {
      const name = qs('#somFilterName').value.trim();
      const percentage = parseFloat(qs('#somFilterPercentage').value);
      
      if (!name || isNaN(percentage) || percentage <= 0 || percentage > 100) {
        alert('Ingresa un nombre v√°lido y un porcentaje entre 1 y 100');
        return;
      }
      
      somFilters.push({
        id: Date.now(),
        name: name,
        percentage: percentage
      });
      
      renderSomFilters();
      toggleSomForm();
      calculateMarketSizes();
      updateProjections();
    }

    function renderSamFilters() {
      const container = qs('#samFilters');
      if (samFilters.length === 0) {
        container.classList.add('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      container.innerHTML = samFilters.map(filter => `
        <div class="flex gap-2 items-center bg-white p-2 rounded border border-green-200">
          <div class="flex-1">
            <span class="text-xs font-medium text-green-800">${filter.name}</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-xs font-bold text-green-700">${filter.percentage}%</span>
          </div>
          <button data-remove-filter="${filter.id}" data-filter-type="sam" 
                  class="text-red-500 hover:text-red-700 text-xs p-1 rounded hover:bg-red-50">üóëÔ∏è</button>
        </div>
      `).join('');
    }

    function renderSomFilters() {
      const container = qs('#somFilters');
      if (somFilters.length === 0) {
        container.classList.add('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      container.innerHTML = somFilters.map(filter => `
        <div class="flex gap-2 items-center bg-white p-2 rounded border border-purple-200">
          <div class="flex-1">
            <span class="text-xs font-medium text-purple-800">${filter.name}</span>
          </div>
          <div class="flex items-center gap-1">
            <span class="text-xs font-bold text-purple-700">${filter.percentage}%</span>
          </div>
          <button data-remove-filter="${filter.id}" data-filter-type="som" 
                  class="text-red-500 hover:text-red-700 text-xs p-1 rounded hover:bg-red-50">üóëÔ∏è</button>
        </div>
      `).join('');
    }



    function calculateMarketSizes() {
      const tam = parseFloat(qs('#tamValue')?.value) || 0;
      qs('#tamDisplay').textContent = tam.toLocaleString();

      // Calcular SAM aplicando filtros secuencialmente
      let sam = tam;
      let totalSamReduction = 0;
      samFilters.forEach(filter => {
        if (filter.percentage > 0) {
          sam = sam * (filter.percentage / 100);
          totalSamReduction += (100 - filter.percentage);
        }
      });
      
      qs('#samDisplay').textContent = Math.round(sam).toLocaleString();
      qs('#samReduction').textContent = `${totalSamReduction.toFixed(1)}%`;

      // Calcular SOM aplicando filtros sobre SAM
      let som = sam;
      somFilters.forEach(filter => {
        if (filter.percentage > 0) {
          som = som * (filter.percentage / 100);
        }
      });

      qs('#somDisplay').textContent = Math.round(som).toLocaleString();
      const somPercentage = sam > 0 ? (som / sam) * 100 : 0;
      qs('#somPercentage').textContent = `${somPercentage.toFixed(1)}%`;
    }

    // üîß FUNCI√ìN PRINCIPAL: Solo reconstruye tablas cuando cambia la estructura (agregar/eliminar productos)
    function updateMonthlyProjections() {
      console.log('üèóÔ∏è updateMonthlyProjections: Reconstruyendo tablas de proyecci√≥n...');
      
      // üîí DESACTIVAR GUARDADO AUTOM√ÅTICO durante reconstrucci√≥n
      autoSaveEnabled = false;
      console.log('üîí Guardado autom√°tico DESACTIVADO durante reconstrucci√≥n');
      
      const container = qs('#monthlyProjectionsContainer');
      const products = qsa('.product-card');
      
      if (products.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Agrega productos para ver las proyecciones mensuales</p>';
        autoSaveEnabled = true;
        console.log('üîì Guardado autom√°tico REACTIVADO (sin productos)');
        updateProjectionCalculations();
        return;
      }

      // üîÑ PRESERVAR DATOS ANTES DE RECONSTRUIR
      const currentProjectionData = preserveProjectionData();
      console.log('üíæ Datos de proyecci√≥n preservados antes de reconstruir tablas');

      container.innerHTML = products.map((card, index) => {
        const productName = qs('.nombre-producto', card)?.value || `Producto ${index + 1}`;
        const productId = card.getAttribute('data-product-id');
        const price = calculateProductPrice(card);
        const cost = parseFloat(qs('.costo-produccion', card)?.value) || 0;
        const color = productColors[index % productColors.length];
        
        return `
          <div class="mb-6 bg-white rounded-lg border overflow-hidden shadow-sm" data-projection-product-id="${productId}">
            <div class="p-3 text-white font-semibold text-sm sm:text-base" style="background-color: ${color}">
              ${productName} - Proyecci√≥n Mensual
              <div class="text-xs opacity-90 mt-1">
                Precio: <span class="moneda">${monedaActual}</span> ${price.toFixed(2)} | Costo: <span class="moneda">${monedaActual}</span> ${cost.toFixed(2)}
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full min-w-[800px]">
                <thead>
                  <tr class="bg-gray-50">
                    <th class="p-2 text-left text-xs font-medium w-24">Escenario</th>
                    ${Array.from({length: 12}, (_, i) => `<th class="p-2 text-center text-xs font-medium">Mes ${i + 1}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${['optimist', 'realist', 'pessimist'].map((scenario, scenarioIndex) => {
                    const scenarioNames = {optimist: 'Optimista', realist: 'Realista', pessimist: 'Pesimista'};
                    const scenarioIcons = {optimist: 'üöÄ', realist: 'üìà', pessimist: '‚ö†Ô∏è'};
                    const scenarioColors = {
                      optimist: `${color}E6`,
                      realist: `${color}B3`,
                      pessimist: `${color}80`
                    };
                    
                    return `
                      <tr>
                        <td class="p-2 text-xs font-medium text-white text-center" style="background-color: ${scenarioColors[scenario]}">
                          <div class="flex flex-col items-center">
                            <span class="text-sm">${scenarioIcons[scenario]}</span>
                            <span class="text-xs">${scenarioNames[scenario]}</span>
                          </div>
                        </td>
                        ${Array.from({length: 12}, (_, monthIndex) => `
                          <td class="p-1">
                            <input type="number" min="0" value="0" 
                                   class="monthly-input w-full p-1 border rounded text-xs text-center" 
                                   data-product-id="${productId}" data-scenario="${scenario}" data-month="${monthIndex}">
                          </td>
                        `).join('')}
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');
      
      // üîÑ RESTAURAR DATOS INMEDIATAMENTE (delay m√≠nimo)
      setTimeout(() => {
        restoreProjectionData(currentProjectionData);
        console.log('üîÑ Datos de proyecci√≥n restaurados despu√©s de reconstruir tablas');
        
        // ‚úÖ ACTUALIZAR TODOS LOS C√ÅLCULOS despu√©s de restaurar datos
        updateProjectionCalculations();
        
        // üîì REACTIVAR GUARDADO AUTOM√ÅTICO solo despu√©s de restaurar y calcular
        autoSaveEnabled = true;
        console.log('üîì Guardado autom√°tico REACTIVADO despu√©s de restauraci√≥n completa');
        
      }, 100); // Delay m√≠nimo para asegurar que el DOM est√© listo
    }

    // üîß FUNCI√ìN OPTIMIZADA: Solo actualiza c√°lculos sin tocar el DOM
    function updateProjectionCalculations() {
      console.log('üìä updateProjectionCalculations: Actualizando solo c√°lculos...');
      updateProjectionsChart();
      updateScenarioSummary();
      calculateProfitabilityAnalysis();
      calculateFinancialIndicators();
    }

    // üîß FUNCI√ìN LIGERA: Solo actualiza headers (nombres y precios) sin reconstruir tablas
    function updateProjectionHeaders() {
      console.log('üè∑Ô∏è updateProjectionHeaders: Actualizando solo headers...');
      const products = qsa('.product-card');
      
      products.forEach((card, index) => {
        const productId = card.getAttribute('data-product-id');
        const productName = qs('.nombre-producto', card)?.value || `Producto ${index + 1}`;
        const price = calculateProductPrice(card);
        const cost = parseFloat(qs('.costo-produccion', card)?.value) || 0;
        
        // Buscar y actualizar solo el header de este producto
        const projectionContainer = qs(`[data-projection-product-id="${productId}"]`);
        if (projectionContainer) {
          const header = qs('.p-3', projectionContainer);
          if (header) {
            const headerContent = header.innerHTML;
            const updatedContent = headerContent.replace(
              /^[^-]+ - Proyecci√≥n Mensual/,
              `${productName} - Proyecci√≥n Mensual`
            ).replace(
              /Precio: <span class="moneda">[^<]+<\/span> [0-9.,]+ \| Costo: <span class="moneda">[^<]+<\/span> [0-9.,]+/,
              `Precio: <span class="moneda">${monedaActual}</span> ${price.toFixed(2)} | Costo: <span class="moneda">${monedaActual}</span> ${cost.toFixed(2)}`
            );
            header.innerHTML = updatedContent;
          }
        }
      });
      
      // Solo actualizar c√°lculos despu√©s de cambiar headers
      updateProjectionCalculations();
    }

    // üîÑ FUNCI√ìN PARA PRESERVAR DATOS DE PROYECCI√ìN ANTES DE RECONSTRUIR
    function preserveProjectionData() {
      const data = {};
      const projectionInputs = qsa('.monthly-input, input[data-product-id][data-scenario][data-month]');
      
      projectionInputs.forEach(input => {
        const productId = input.getAttribute('data-product-id');
        const scenario = input.getAttribute('data-scenario');
        const month = input.getAttribute('data-month');
        const value = input.value;
        
        if (productId && scenario && month !== null) {
          const key = `${productId}-${scenario}-${month}`;
          data[key] = value;
        }
      });
      
      console.log(`üíæ Preservados ${Object.keys(data).length} valores de proyecci√≥n`);
      return data;
    }

    // üîÑ FUNCI√ìN PARA RESTAURAR DATOS DE PROYECCI√ìN DESPU√âS DE RECONSTRUIR
    function restoreProjectionData(data) {
      let restored = 0;
      
      Object.keys(data).forEach(key => {
        const [productId, scenario, month] = key.split('-');
        const value = data[key];
        
        // Buscar el input reci√©n creado
        const input = qs(`input[data-product-id="${productId}"][data-scenario="${scenario}"][data-month="${month}"]`);
        
        if (input && value !== '0') {
          input.value = value;
          restored++;
        }
      });
      
      console.log(`üîÑ Restaurados ${restored} valores de proyecci√≥n`);
    }

    function calculateProductPrice(card) {
      const costoProduccion = parseFloat(qs('.costo-produccion', card)?.value) || 0;
      const profit = parseFloat(card.dataset.profit || '30') || 30;
      const impRate = impuestosPersonalizados.reduce((s, i) => s + i.porcentaje, 0);
      
      const precioSinImpuestos = costoProduccion * (1 + profit / 100);
      const impuestos = precioSinImpuestos * impRate / 100;
      return precioSinImpuestos + impuestos;
    }

    function updateScenarioSummary() {
      const products = qsa('.product-card');
      
      let totalOptimistUnits = 0, totalOptimistRevenue = 0, totalOptimistCosts = 0;
      let totalRealistUnits = 0, totalRealistRevenue = 0, totalRealistCosts = 0;
      let totalPessimistUnits = 0, totalPessimistRevenue = 0, totalPessimistCosts = 0;

      products.forEach((card, productIndex) => {
        const productId = card.getAttribute('data-product-id');
        const price = calculateProductPrice(card);
        const cost = parseFloat(qs('.costo-produccion', card)?.value) || 0;
        
        // Calcular totales anuales sumando todos los meses
        let optimistUnitsYear = 0, realistUnitsYear = 0, pessimistUnitsYear = 0;
        
        for (let month = 0; month < 12; month++) {
          // B√∫squeda robusta de inputs usando m√∫ltiples estrategias
          let optimistInput = qs(`input[data-product-id="${productId}"][data-scenario="optimist"][data-month="${month}"]`);
          let realistInput = qs(`input[data-product-id="${productId}"][data-scenario="realist"][data-month="${month}"]`);
          let pessimistInput = qs(`input[data-product-id="${productId}"][data-scenario="pessimist"][data-month="${month}"]`);
          
          // Fallback: buscar por √≠ndice de producto
          if (!optimistInput) {
            optimistInput = qs(`input[data-product="${productIndex}"][data-scenario="optimist"][data-month="${month}"]`);
          }
          if (!realistInput) {
            realistInput = qs(`input[data-product="${productIndex}"][data-scenario="realist"][data-month="${month}"]`);
          }
          if (!pessimistInput) {
            pessimistInput = qs(`input[data-product="${productIndex}"][data-scenario="pessimist"][data-month="${month}"]`);
          }
          
          optimistUnitsYear += parseFloat(optimistInput?.value) || 0;
          realistUnitsYear += parseFloat(realistInput?.value) || 0;
          pessimistUnitsYear += parseFloat(pessimistInput?.value) || 0;
        }
        
        // Calcular ingresos y costos por escenario
        const optimistRevenue = optimistUnitsYear * price;
        const realistRevenue = realistUnitsYear * price;
        const pessimistRevenue = pessimistUnitsYear * price;
        
        const optimistCost = optimistUnitsYear * cost;
        const realistCost = realistUnitsYear * cost;
        const pessimistCost = pessimistUnitsYear * cost;
        
        // Acumular totales
        totalOptimistUnits += optimistUnitsYear;
        totalOptimistRevenue += optimistRevenue;
        totalOptimistCosts += optimistCost;
        
        totalRealistUnits += realistUnitsYear;
        totalRealistRevenue += realistRevenue;
        totalRealistCosts += realistCost;
        
        totalPessimistUnits += pessimistUnitsYear;
        totalPessimistRevenue += pessimistRevenue;
        totalPessimistCosts += pessimistCost;
      });

      // Actualizar resumen por escenario
      qs('#optimistUnits').textContent = totalOptimistUnits.toLocaleString();
      qs('#optimistRevenue').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalOptimistRevenue.toFixed(2)}`;
      qs('#optimistCosts').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalOptimistCosts.toFixed(2)}`;
      qs('#optimistProfit').innerHTML = `<span class="moneda">${monedaActual}</span> ${(totalOptimistRevenue - totalOptimistCosts).toFixed(2)}`;
      
      qs('#realistUnits').textContent = totalRealistUnits.toLocaleString();
      qs('#realistRevenue').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalRealistRevenue.toFixed(2)}`;
      qs('#realistCosts').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalRealistCosts.toFixed(2)}`;
      qs('#realistProfit').innerHTML = `<span class="moneda">${monedaActual}</span> ${(totalRealistRevenue - totalRealistCosts).toFixed(2)}`;
      
      qs('#pessimistUnits').textContent = totalPessimistUnits.toLocaleString();
      qs('#pessimistRevenue').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalPessimistRevenue.toFixed(2)}`;
      qs('#pessimistCosts').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalPessimistCosts.toFixed(2)}`;
      qs('#pessimistProfit').innerHTML = `<span class="moneda">${monedaActual}</span> ${(totalPessimistRevenue - totalPessimistCosts).toFixed(2)}`;
    }



    function updateProjectionsChart() {
      const canvas = qs('#projectionsChart');
      if (!canvas) return;
      
      const ctx = canvas.getContext('2d');
      const products = qsa('.product-card');
      
      // Limpiar canvas
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      if (products.length === 0) {
        // Mostrar mensaje cuando no hay productos
        ctx.fillStyle = '#6B7280';
        ctx.font = '16px Inter, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Agrega productos para ver la gr√°fica de proyecciones', canvas.width / 2, canvas.height / 2);
        return;
      }
      
      // Configuraci√≥n de la gr√°fica - EXTENDIDA PARA M√öLTIPLES A√ëOS
      const padding = 80;
      const chartWidth = canvas.width - 2 * padding;
      const chartHeight = canvas.height - 2 * padding;
      
      // Determinar cu√°ntos a√±os necesitamos mostrar basado en an√°lisis de rentabilidad
      const yearsToShow = determineYearsForProfitability();
      const totalMonths = yearsToShow * 12;
      
      // Recopilar datos de todos los productos y escenarios
      let maxValue = 0;
      const chartData = [];
      
      products.forEach((card, productIndex) => {
        const productName = qs('.nombre-producto', card)?.value || `Producto ${productIndex + 1}`;
        const productId = card.getAttribute('data-product-id');
        const baseColor = productColors[productIndex % productColors.length];
        
        ['optimist', 'realist', 'pessimist'].forEach((scenario, scenarioIndex) => {
          const scenarioName = {optimist: 'Optimista', realist: 'Realista', pessimist: 'Pesimista'}[scenario];
          const data = [];
          
          // Obtener datos del primer a√±o (de los inputs) con b√∫squeda robusta
          const firstYearData = [];
          for (let month = 0; month < 12; month++) {
            // B√∫squeda principal por ID √∫nico
            let input = qs(`input[data-product-id="${productId}"][data-scenario="${scenario}"][data-month="${month}"]`);
            
            // Fallback: buscar por √≠ndice
            if (!input) {
              input = qs(`input[data-product="${productIndex}"][data-scenario="${scenario}"][data-month="${month}"]`);
            }
            
            const value = parseFloat(input?.value) || 0;
            firstYearData.push(value);
            maxValue = Math.max(maxValue, value);
          }
          
          // Extender datos para a√±os adicionales (repetir patr√≥n del primer a√±o)
          for (let year = 0; year < yearsToShow; year++) {
            firstYearData.forEach(monthValue => {
              data.push(monthValue);
            });
          }
          
          // Colores con diferentes saturaciones para cada escenario
          const saturation = {optimist: 'FF', realist: 'B3', pessimist: '80'}[scenario];
          const lineColor = baseColor + saturation;
          
          chartData.push({
            label: `${productName} - ${scenarioName}`,
            data: data,
            color: lineColor,
            productIndex: productIndex,
            scenario: scenario
          });
        });
      });
      
      if (maxValue === 0) maxValue = 10;
      
      // Dibujar ejes
      ctx.strokeStyle = '#E5E7EB';
      ctx.lineWidth = 1;
      
      // Eje Y
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, padding + chartHeight);
      ctx.stroke();
      
      // Eje X
      ctx.beginPath();
      ctx.moveTo(padding, padding + chartHeight);
      ctx.lineTo(padding + chartWidth, padding + chartHeight);
      ctx.stroke();
      
      // Etiquetas del eje X - SOLO MARCAR INICIO DE A√ëOS
      ctx.fillStyle = '#6B7280';
      ctx.font = '12px Inter, sans-serif';
      ctx.textAlign = 'center';
      
      for (let year = 0; year < yearsToShow; year++) {
        const monthIndex = year * 12; // Enero de cada a√±o
        const x = padding + (monthIndex / totalMonths) * chartWidth;
        
        // L√≠nea vertical para marcar el a√±o
        ctx.strokeStyle = '#D1D5DB';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, padding + chartHeight);
        ctx.stroke();
        
        // Etiqueta del a√±o
        ctx.fillStyle = '#374151';
        ctx.font = 'bold 12px Inter, sans-serif';
        ctx.fillText(`A√±o ${year + 1}`, x, padding + chartHeight + 20);
      }
      
      // Etiquetas del eje Y
      ctx.textAlign = 'right';
      ctx.font = '11px Inter, sans-serif';
      for (let i = 0; i <= 5; i++) {
        const value = (maxValue / 5) * i;
        const y = padding + chartHeight - (i * chartHeight / 5);
        ctx.fillText(Math.round(value).toString(), padding - 10, y + 4);
        
        // L√≠neas de cuadr√≠cula horizontales
        if (i > 0) {
          ctx.strokeStyle = '#F9FAFB';
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(padding, y);
          ctx.lineTo(padding + chartWidth, y);
          ctx.stroke();
        }
      }
      
      // Dibujar l√≠neas de datos
      chartData.forEach((series, seriesIndex) => {
        ctx.strokeStyle = series.color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        
        let hasData = false;
        let firstPoint = true;
        
        series.data.forEach((value, monthIndex) => {
          if (value > 0) {
            const x = padding + (monthIndex / totalMonths) * chartWidth;
            const y = padding + chartHeight - (value / maxValue) * chartHeight;
            
            if (firstPoint) {
              ctx.moveTo(x, y);
              firstPoint = false;
            } else {
              ctx.lineTo(x, y);
            }
            hasData = true;
          }
        });
        
        if (hasData) {
          ctx.stroke();
          
          // Dibujar puntos solo en algunos meses para no saturar
          ctx.fillStyle = series.color;
          series.data.forEach((value, monthIndex) => {
            if (value > 0 && monthIndex % 3 === 0) { // Solo cada 3 meses
              const x = padding + (monthIndex / totalMonths) * chartWidth;
              const y = padding + chartHeight - (value / maxValue) * chartHeight;
              
              ctx.beginPath();
              ctx.arc(x, y, 2, 0, 2 * Math.PI);
              ctx.fill();
            }
          });
        }
      });
      
      // Leyenda mejorada
      const legendStartY = 15;
      let legendY = legendStartY;
      let legendX = padding;
      
      ctx.font = '10px Inter, sans-serif';
      ctx.textAlign = 'left';
      
      // Agrupar por producto para mejor organizaci√≥n
      const productGroups = {};
      chartData.forEach(series => {
        if (!productGroups[series.productIndex]) {
          productGroups[series.productIndex] = [];
        }
        productGroups[series.productIndex].push(series);
      });
      
      Object.values(productGroups).forEach((productSeries, groupIndex) => {
        productSeries.forEach((series, index) => {
          // Cuadrado de color
          ctx.fillStyle = series.color;
          ctx.fillRect(legendX, legendY, 10, 10);
          
          // Texto
          ctx.fillStyle = '#374151';
          const scenarioShort = {optimist: 'Opt', realist: 'Real', pessimist: 'Pes'}[series.scenario];
          const label = `${series.label.split(' - ')[0]} ${scenarioShort}`;
          ctx.fillText(label, legendX + 14, legendY + 8);
          
          legendX += ctx.measureText(label).width + 25;
          
          // Nueva l√≠nea si es necesario
          if (legendX > canvas.width - 80) {
            legendX = padding;
            legendY += 15;
          }
        });
      });
    }

    function determineYearsForProfitability() {
      const products = qsa('.product-card');
      if (products.length === 0) return 1;
      
      // Calcular inversi√≥n total
      let totalInvestment = 0;
      products.forEach(card => {
        qsa('.inversion-items input[type="number"]', card).forEach(input => {
          totalInvestment += parseFloat(input.value) || 0;
        });
      });
      
      if (totalInvestment === 0) return 1;
      
      // Calcular flujo de caja mensual promedio de todos los escenarios
      let monthlyAverageCashFlow = 0;
      let scenarioCount = 0;
      
      ['optimist', 'realist', 'pessimist'].forEach(scenario => {
        let scenarioCashFlow = 0;
        
        products.forEach((card, productIndex) => {
          const productId = card.getAttribute('data-product-id');
          const price = calculateProductPrice(card);
          const cost = parseFloat(qs('.costo-produccion', card)?.value) || 0;
          
          // Sumar flujo mensual de todo el a√±o
          for (let month = 0; month < 12; month++) {
            // Buscar input usando m√∫ltiples estrategias
            let input = qs(`input[data-product-id="${productId}"][data-scenario="${scenario}"][data-month="${month}"]`);
            if (!input) {
              input = qs(`input[data-product="${productIndex}"][data-scenario="${scenario}"][data-month="${month}"]`);
            }
            const units = parseFloat(input?.value) || 0;
            scenarioCashFlow += (price - cost) * units;
          }
        });
        
        if (scenarioCashFlow > 0) {
          monthlyAverageCashFlow += scenarioCashFlow / 12; // Promedio mensual
          scenarioCount++;
        }
      });
      
      if (scenarioCount > 0) {
        monthlyAverageCashFlow = monthlyAverageCashFlow / scenarioCount;
      }
      
      if (monthlyAverageCashFlow <= 0) return 3; // Mostrar 3 a√±os por defecto si no hay flujo positivo
      
      // Calcular cu√°ntos meses se necesitan para recuperar la inversi√≥n
      const monthsToBreakeven = Math.ceil(totalInvestment / monthlyAverageCashFlow);
      const yearsToBreakeven = Math.ceil(monthsToBreakeven / 12);
      
      // Mostrar al menos 1 a√±o, m√°ximo 5 a√±os
      return Math.min(Math.max(yearsToBreakeven, 1), 5);
    }

    function calculateProfitabilityAnalysis() {
      const products = qsa('.product-card');
      const container = qs('#profitabilityAnalysis');
      const warningElement = qs('#warningNoRentable');
      const printButton = qs('#btnImprimirProyecciones');
      
      if (products.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Agrega productos para ver el an√°lisis de rentabilidad</p>';
        // Ocultar advertencia y deshabilitar bot√≥n cuando no hay productos
        if (warningElement) warningElement.classList.add('hidden');
        if (printButton) {
          printButton.disabled = false;
          printButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        return;
      }
      
      // Calcular inversi√≥n total
      let totalInvestment = 0;
      products.forEach(card => {
        qsa('.inversion-items input[type="number"]', card).forEach(input => {
          totalInvestment += parseFloat(input.value) || 0;
        });
      });
      
      if (totalInvestment === 0) {
        container.innerHTML = `
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <div class="flex items-center">
              <span class="text-2xl mr-3">‚ö†Ô∏è</span>
              <div>
                <h4 class="font-semibold text-yellow-800">Sin Inversi√≥n Inicial</h4>
                <p class="text-yellow-700 text-sm">Agrega inversi√≥n inicial en los productos para analizar la rentabilidad.</p>
              </div>
            </div>
          </div>
        `;
        // Ocultar advertencia cuando no hay inversi√≥n
        if (warningElement) warningElement.classList.add('hidden');
        if (printButton) {
          printButton.disabled = false;
          printButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
        return;
      }
      
      // Analizar cada escenario
      const scenarios = ['optimist', 'realist', 'pessimist'];
      const scenarioNames = {optimist: 'Optimista', realist: 'Realista', pessimist: 'Pesimista'};
      const scenarioColors = {optimist: 'green', realist: 'blue', pessimist: 'orange'};
      const scenarioIcons = {optimist: 'üöÄ', realist: 'üìà', pessimist: '‚ö†Ô∏è'};
      
      let analysisResults = [];
      let anyProfitableInFirstYear = false;
      
      scenarios.forEach(scenario => {
        let monthlyCashFlow = 0;
        
        products.forEach((card, productIndex) => {
          const productId = card.getAttribute('data-product-id');
          const price = calculateProductPrice(card);
          const cost = parseFloat(qs('.costo-produccion', card)?.value) || 0;
          
          // Calcular flujo de caja anual sumando todos los meses
          let annualUnits = 0;
          for (let month = 0; month < 12; month++) {
            // B√∫squeda principal por ID √∫nico
            let input = qs(`input[data-product-id="${productId}"][data-scenario="${scenario}"][data-month="${month}"]`);
            
            // Fallback: buscar por √≠ndice
            if (!input) {
              input = qs(`input[data-product="${productIndex}"][data-scenario="${scenario}"][data-month="${month}"]`);
            }
            
            annualUnits += parseFloat(input?.value) || 0;
          }
          
          monthlyCashFlow += (price - cost) * annualUnits / 12; // Promedio mensual
        });
        
        const annualCashFlow = monthlyCashFlow * 12;
        let monthsToBreakeven = 0;
        let yearsToBreakeven = 0;
        let isProfitable = false;
        
        if (monthlyCashFlow > 0) {
          monthsToBreakeven = Math.ceil(totalInvestment / monthlyCashFlow);
          yearsToBreakeven = Math.ceil(monthsToBreakeven / 12);
          isProfitable = true;
          
          if (yearsToBreakeven <= 1) {
            anyProfitableInFirstYear = true;
          }
        }
        
        analysisResults.push({
          scenario,
          name: scenarioNames[scenario],
          color: scenarioColors[scenario],
          icon: scenarioIcons[scenario],
          monthlyCashFlow,
          annualCashFlow,
          monthsToBreakeven,
          yearsToBreakeven,
          isProfitable
        });
      });
      
      // Generar HTML del an√°lisis
      let html = `
        <div class="mb-6">
          <div class="flex items-center mb-4">
            <span class="text-2xl mr-3">üí∞</span>
            <div>
              <h4 class="font-semibold text-gray-800">Inversi√≥n Total Requerida</h4>
              <p class="text-2xl font-bold text-red-600"><span class="moneda">${monedaActual}</span> ${totalInvestment.toLocaleString()}</p>
            </div>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      `;
      
      analysisResults.forEach(result => {
        const statusClass = result.isProfitable ? 
          (result.yearsToBreakeven <= 1 ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200') : 
          'bg-red-50 border-red-200';
        
        const statusText = result.isProfitable ? 
          (result.yearsToBreakeven <= 1 ? 'Rentable en el primer a√±o' : `Rentable en ${result.yearsToBreakeven} a√±o${result.yearsToBreakeven > 1 ? 's' : ''}`) : 
          'No rentable con estos datos';
        
        const statusColor = result.isProfitable ? 
          (result.yearsToBreakeven <= 1 ? 'text-green-800' : 'text-yellow-800') : 
          'text-red-800';
        
        html += `
          <div class="${statusClass} border rounded-lg p-4">
            <div class="flex items-center mb-3">
              <span class="text-2xl mr-2">${result.icon}</span>
              <h5 class="font-semibold text-gray-800">${result.name}</h5>
            </div>
            <div class="space-y-2 text-sm">
              <div class="flex justify-between">
                <span class="text-gray-600">Flujo mensual:</span>
                <span class="font-semibold ${result.monthlyCashFlow > 0 ? 'text-green-600' : 'text-red-600'}">
                  <span class="moneda">${monedaActual}</span> ${result.monthlyCashFlow.toFixed(2)}
                </span>
              </div>
              <div class="flex justify-between">
                <span class="text-gray-600">Flujo anual:</span>
                <span class="font-semibold ${result.annualCashFlow > 0 ? 'text-green-600' : 'text-red-600'}">
                  <span class="moneda">${monedaActual}</span> ${result.annualCashFlow.toFixed(2)}
                </span>
              </div>
              ${result.isProfitable ? `
                <div class="flex justify-between">
                  <span class="text-gray-600">Punto de equilibrio:</span>
                  <span class="font-semibold text-blue-600">${result.monthsToBreakeven} meses</span>
                </div>
              ` : ''}
              <div class="pt-2 border-t">
                <p class="font-semibold ${statusColor}">${statusText}</p>
              </div>
            </div>
          </div>
        `;
      });
      
      html += '</div>';
      
      // Advertencia o confirmaci√≥n general
      if (!anyProfitableInFirstYear) {
        const bestScenario = analysisResults.filter(r => r.isProfitable).sort((a, b) => a.yearsToBreakeven - b.yearsToBreakeven)[0];
        
        if (bestScenario) {
          html += `
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <span class="text-2xl mr-3">‚ö†Ô∏è</span>
                <div>
                  <h4 class="font-semibold text-yellow-800 mb-2">Advertencia: Rentabilidad a Largo Plazo</h4>
                  <p class="text-yellow-700 text-sm mb-2">
                    Ning√∫n escenario alcanza la rentabilidad en el primer a√±o. El mejor escenario (${bestScenario.name}) 
                    requiere ${bestScenario.yearsToBreakeven} a√±o${bestScenario.yearsToBreakeven > 1 ? 's' : ''} para recuperar la inversi√≥n.
                  </p>
                  <p class="text-yellow-700 text-sm">
                    <strong>Recomendaci√≥n:</strong> Considera ajustar precios, reducir costos o aumentar las proyecciones de ventas.
                  </p>
                </div>
              </div>
            </div>
          `;
        } else {
          html += `
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
              <div class="flex items-start">
                <span class="text-2xl mr-3">üö®</span>
                <div>
                  <h4 class="font-semibold text-red-800 mb-2">Alerta: Proyecto No Rentable</h4>
                  <p class="text-red-700 text-sm mb-2">
                    Ning√∫n escenario genera flujos de caja positivos suficientes para recuperar la inversi√≥n inicial.
                  </p>
                  <p class="text-red-700 text-sm">
                    <strong>Acci√≥n requerida:</strong> Revisa completamente el modelo de negocio, precios y costos antes de proceder.
                  </p>
                </div>
              </div>
            </div>
          `;
          
          // Mostrar advertencia y deshabilitar bot√≥n de impresi√≥n cuando no es rentable
          if (warningElement) warningElement.classList.remove('hidden');
          if (printButton) {
            printButton.disabled = true;
            printButton.classList.add('opacity-50', 'cursor-not-allowed');
          }
        }
      } else {
        html += `
          <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
            <div class="flex items-start">
              <span class="text-2xl mr-3">‚úÖ</span>
              <div>
                <h4 class="font-semibold text-green-800 mb-2">Excelente: Rentabilidad en el Primer A√±o</h4>
                <p class="text-green-700 text-sm">
                  Al menos uno de los escenarios muestra rentabilidad en el primer a√±o de operaci√≥n. 
                  El proyecto tiene potencial de generar retornos r√°pidos sobre la inversi√≥n.
                </p>
              </div>
            </div>
          </div>
        `;
      }
      
      // Determinar si el proyecto es rentable (en cualquier plazo)
      const isProjectProfitable = analysisResults.some(r => r.isProfitable);
      
      if (isProjectProfitable) {
        // Ocultar advertencia y habilitar bot√≥n cuando es rentable
        if (warningElement) warningElement.classList.add('hidden');
        if (printButton) {
          printButton.disabled = false;
          printButton.classList.remove('opacity-50', 'cursor-not-allowed');
        }
      }
      
      container.innerHTML = html;
    }

    function calculateFinancialIndicators() {
      const products = qsa('.product-card');
      let totalInvestment = 0;
      
      // Calcular inversi√≥n total
      products.forEach(card => {
        qsa('.inversion-items input[type="number"]', card).forEach(input => {
          totalInvestment += parseFloat(input.value) || 0;
        });
      });
      
      qs('#totalInvestment').innerHTML = `<span class="moneda">${monedaActual}</span> ${totalInvestment.toLocaleString()}`;
      
      // Tasa de descuento fija del 12%
      const discountRate = 12;
      qs('#discountRateDisplay').textContent = `${discountRate}%`;
      
      // Calcular a√±os necesarios para alcanzar rentabilidad
      let yearsToProfit = calculateYearsToProfit();
      qs('#yearsToProfit').textContent = yearsToProfit > 0 ? `${yearsToProfit} a√±o${yearsToProfit > 1 ? 's' : ''}` : 'No rentable';
      
      // Actualizar an√°lisis de rentabilidad
      calculateProfitabilityAnalysis();
    }

    function calculateYearsToProfit() {
      const products = qsa('.product-card');
      if (products.length === 0) return 0;
      
      // Calcular inversi√≥n total
      let totalInvestment = 0;
      products.forEach(card => {
        qsa('.inversion-items input[type="number"]', card).forEach(input => {
          totalInvestment += parseFloat(input.value) || 0;
        });
      });
      
      if (totalInvestment === 0) return 0;
      
      // Calcular flujo de caja mensual promedio de todos los escenarios
      let monthlyAverageCashFlow = 0;
      let scenarioCount = 0;
      
      ['optimist', 'realist', 'pessimist'].forEach(scenario => {
        let scenarioCashFlow = 0;
        
        products.forEach((card, productIndex) => {
          const productId = card.getAttribute('data-product-id');
          const price = calculateProductPrice(card);
          const cost = parseFloat(qs('.costo-produccion', card)?.value) || 0;
          
          // Sumar flujo mensual de todo el a√±o con b√∫squeda robusta
          for (let month = 0; month < 12; month++) {
            // B√∫squeda principal por ID √∫nico
            let input = qs(`input[data-product-id="${productId}"][data-scenario="${scenario}"][data-month="${month}"]`);
            
            // Fallback: buscar por √≠ndice
            if (!input) {
              input = qs(`input[data-product="${productIndex}"][data-scenario="${scenario}"][data-month="${month}"]`);
            }
            
            const units = parseFloat(input?.value) || 0;
            scenarioCashFlow += (price - cost) * units;
          }
        });
        
        if (scenarioCashFlow > 0) {
          monthlyAverageCashFlow += scenarioCashFlow / 12; // Promedio mensual
          scenarioCount++;
        }
      });
      
      if (scenarioCount > 0) {
        monthlyAverageCashFlow = monthlyAverageCashFlow / scenarioCount;
      }
      
      if (monthlyAverageCashFlow <= 0) return -1; // No rentable
      
      // Calcular cu√°ntos meses se necesitan para recuperar la inversi√≥n
      const monthsToBreakeven = Math.ceil(totalInvestment / monthlyAverageCashFlow);
      const yearsToBreakeven = Math.ceil(monthsToBreakeven / 12);
      
      return yearsToBreakeven;
    }

    // üîß FUNCI√ìN LEGACY: Mantener compatibilidad pero optimizar
    function updateProjections() {
      // Solo reconstruir si no hay tablas o cambi√≥ el n√∫mero de productos
      const existingTables = qsa('#monthlyProjectionsContainer [data-projection-product-id]');
      const currentProducts = qsa('.product-card');
      
      if (existingTables.length !== currentProducts.length) {
        console.log('üîÑ updateProjections: Reconstruyendo por cambio en n√∫mero de productos');
        updateMonthlyProjections();
      } else {
        console.log('üìä updateProjections: Solo actualizando c√°lculos');
        updateProjectionCalculations();
      }
    }

    function imprimirProyecciones() {
      console.log('üñ®Ô∏è Iniciando proceso de impresi√≥n de proyecciones...');
      
      // Verificar si el proyecto es rentable antes de imprimir
      const printButton = qs('#btnImprimirProyecciones');
      if (printButton && printButton.disabled) {
        console.log('‚ùå Impresi√≥n cancelada: Proyecto no rentable');
        alert('‚ö†Ô∏è No es posible imprimir la proyecci√≥n porque el proyecto no es rentable. Ajusta los datos para generar flujos de caja positivos.');
        return;
      }
      
      // üîí DESACTIVAR GUARDADO AUTOM√ÅTICO durante impresi√≥n
      autoSaveEnabled = false;
      console.log('üîí Guardado autom√°tico DESACTIVADO durante impresi√≥n');
      
      // Actualizar todos los c√°lculos para asegurar datos correctos
      updateProjectionCalculations();
      console.log('üìä C√°lculos actualizados para impresi√≥n');
      
      // Crear imagen de la gr√°fica despu√©s de actualizar
      const canvas = qs('#projectionsChart');
      let chartImageData = '';
      
      if (canvas) {
        try {
          chartImageData = canvas.toDataURL('image/png');
          console.log('üìà Imagen de gr√°fica generada para impresi√≥n');
        } catch (error) {
          console.warn('‚ö†Ô∏è No se pudo generar imagen de la gr√°fica:', error);
        }
      }
      
      // Crear una nueva ventana para imprimir
      const printWindow = window.open('', '_blank');
      
      // Crear el contenido de impresi√≥n optimizado para papel
      let proyeccionesContent = `
        <!-- Encabezado Principal -->
        <div class="header-section">
          <h1 class="main-title">PROYECCIONES FINANCIERAS</h1>
          <p class="subtitle">Fecha de an√°lisis: ${new Date().toLocaleDateString('es-ES', {year:'numeric',month:'long',day:'numeric'})}</p>
        </div>

        <!-- Gr√°fica de Escenarios -->
        <div class="section">
          <h2 class="section-title">üìä Gr√°fica de Escenarios</h2>
          <div class="chart-container">
            ${chartImageData ? 
              `<img src="${chartImageData}" alt="Gr√°fica de Proyecciones Financieras" class="chart-image">
               <p class="chart-caption">Comparaci√≥n de escenarios de ventas mensuales por producto</p>` :
              `<div class="chart-placeholder">
                 <div class="chart-content">
                   <p class="chart-main">üìà Gr√°fica de Proyecciones</p>
                   <p class="chart-desc">Comparaci√≥n visual de escenarios de ventas mensuales</p>
                   <p class="chart-note">Agrega productos y datos para ver la gr√°fica</p>
                 </div>
               </div>`
            }
          </div>
        </div>

        <!-- Resumen por Escenario -->
        <div class="section">
          <h2 class="section-title">üí∞ Resumen por Escenario</h2>
          <div class="scenarios-grid">
            <!-- Optimista -->
            <div class="scenario-card optimist">
              <h3 class="scenario-header">üöÄ Optimista</h3>
              <div class="scenario-data">
                <div class="data-row">
                  <span>Unidades:</span>
                  <span class="value">${qs('#optimistUnits')?.textContent || '0'}</span>
                </div>
                <div class="data-row">
                  <span>Ingresos:</span>
                  <span class="value">${qs('#optimistRevenue')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
                <div class="data-row">
                  <span>Costos:</span>
                  <span class="value cost">${qs('#optimistCosts')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
                <div class="data-row total">
                  <span>Utilidad:</span>
                  <span class="value">${qs('#optimistProfit')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
              </div>
            </div>

            <!-- Realista -->
            <div class="scenario-card realist">
              <h3 class="scenario-header">üìà Realista</h3>
              <div class="scenario-data">
                <div class="data-row">
                  <span>Unidades:</span>
                  <span class="value">${qs('#realistUnits')?.textContent || '0'}</span>
                </div>
                <div class="data-row">
                  <span>Ingresos:</span>
                  <span class="value">${qs('#realistRevenue')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
                <div class="data-row">
                  <span>Costos:</span>
                  <span class="value cost">${qs('#realistCosts')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
                <div class="data-row total">
                  <span>Utilidad:</span>
                  <span class="value">${qs('#realistProfit')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
              </div>
            </div>

            <!-- Pesimista -->
            <div class="scenario-card pessimist">
              <h3 class="scenario-header">‚ö†Ô∏è Pesimista</h3>
              <div class="scenario-data">
                <div class="data-row">
                  <span>Unidades:</span>
                  <span class="value">${qs('#pessimistUnits')?.textContent || '0'}</span>
                </div>
                <div class="data-row">
                  <span>Ingresos:</span>
                  <span class="value">${qs('#pessimistRevenue')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
                <div class="data-row">
                  <span>Costos:</span>
                  <span class="value cost">${qs('#pessimistCosts')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
                <div class="data-row total">
                  <span>Utilidad:</span>
                  <span class="value">${qs('#pessimistProfit')?.innerHTML || '<span class="moneda">Q</span> 0'}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Indicadores Financieros -->
        <div class="section">
          <h2 class="section-title">üíé Indicadores Financieros</h2>
          <div class="indicators-grid">
            <div class="indicator-card">
              <p class="indicator-label">Inversi√≥n Inicial Total</p>
              <p class="indicator-value investment">${qs('#totalInvestment')?.innerHTML || '<span class="moneda">Q</span> 0'}</p>
            </div>
            <div class="indicator-card">
              <p class="indicator-label">Tasa de Descuento (TIR)</p>
              <p class="indicator-value rate">${qs('#discountRateDisplay')?.textContent || '12%'}</p>
            </div>
            <div class="indicator-card">
              <p class="indicator-label">A√±os para Rentabilidad</p>
              <p class="indicator-value years">${qs('#yearsToProfit')?.textContent || '-'}</p>
            </div>
          </div>
        </div>

        <!-- An√°lisis de Rentabilidad -->
        <div class="section">
          <h2 class="section-title">‚ö° An√°lisis de Rentabilidad</h2>
          <div class="analysis-content">
            ${qs('#profitabilityAnalysis')?.innerHTML || '<p class="no-data">No hay an√°lisis disponible</p>'}
          </div>
        </div>
      `;
      
      printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Proyecciones Financieras</title>
          <style>
            /* Reset y configuraci√≥n base */
            * { margin: 0; padding: 0; box-sizing: border-box; }
            
            body {
              font-family: 'Inter', Arial, sans-serif;
              background: white;
              color: #1f2937;
              line-height: 1.5;
              font-size: 14px;
              padding: 15px;
            }

            /* Encabezado principal */
            .header-section {
              text-align: center;
              border-bottom: 3px solid #4f46e5;
              padding-bottom: 15px;
              margin-bottom: 20px;
            }

            .main-title {
              font-size: 28px;
              font-weight: bold;
              color: #312e81;
              margin-bottom: 8px;
              letter-spacing: 1px;
            }

            .subtitle {
              color: #4f46e5;
              font-size: 14px;
              font-weight: 500;
            }

            /* Secciones */
            .section {
              margin-bottom: 18px;
              page-break-inside: avoid;
            }

            .section-title {
              font-size: 16px;
              font-weight: bold;
              color: #3730a3;
              margin-bottom: 10px;
              padding-bottom: 5px;
              border-bottom: 1px solid #e5e7eb;
            }

            /* Contenedor de gr√°fica */
            .chart-container {
              text-align: center;
              margin: 15px 0;
            }

            .chart-image {
              max-width: 100%;
              height: auto;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
              background: white;
              padding: 10px;
            }

            .chart-caption {
              font-size: 12px;
              color: #6b7280;
              margin-top: 8px;
              font-style: italic;
            }

            /* Placeholder de gr√°fica */
            .chart-placeholder {
              background: #f9fafb;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              padding: 20px;
              text-align: center;
            }

            .chart-content {
              background: white;
              padding: 15px;
              border-radius: 6px;
              border: 1px solid #d1d5db;
            }

            .chart-main {
              font-size: 16px;
              color: #4b5563;
              margin-bottom: 5px;
            }

            .chart-desc {
              font-size: 12px;
              color: #6b7280;
              margin-bottom: 8px;
            }

            .chart-note {
              font-size: 10px;
              color: #9ca3af;
              font-style: italic;
            }

            /* Grid de escenarios */
            .scenarios-grid {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 12px;
            }

            .scenario-card {
              border: 1px solid #d1d5db;
              border-radius: 8px;
              padding: 12px;
              page-break-inside: avoid;
            }

            .scenario-card.optimist {
              background: #f0fdf4;
              border-color: #bbf7d0;
            }

            .scenario-card.realist {
              background: #eff6ff;
              border-color: #bfdbfe;
            }

            .scenario-card.pessimist {
              background: #fff7ed;
              border-color: #fed7aa;
            }

            .scenario-header {
              font-size: 14px;
              font-weight: bold;
              margin-bottom: 8px;
              text-align: center;
            }

            .optimist .scenario-header { color: #166534; }
            .realist .scenario-header { color: #1e40af; }
            .pessimist .scenario-header { color: #9a3412; }

            .scenario-data {
              font-size: 11px;
            }

            .data-row {
              display: flex;
              justify-content: space-between;
              margin-bottom: 4px;
              padding: 2px 0;
            }

            .data-row.total {
              border-top: 1px solid #d1d5db;
              padding-top: 6px;
              margin-top: 6px;
              font-weight: bold;
            }

            .data-row .value {
              font-weight: 600;
            }

            .data-row .value.cost {
              color: #dc2626;
            }

            /* Grid de indicadores */
            .indicators-grid {
              display: grid;
              grid-template-columns: repeat(3, 1fr);
              gap: 12px;
            }

            .indicator-card {
              background: white;
              border: 1px solid #d1d5db;
              border-radius: 8px;
              padding: 12px;
              text-align: center;
            }

            .indicator-label {
              font-size: 11px;
              color: #6b7280;
              margin-bottom: 4px;
            }

            .indicator-value {
              font-size: 16px;
              font-weight: bold;
            }

            .indicator-value.investment { color: #dc2626; }
            .indicator-value.rate { color: #2563eb; }
            .indicator-value.years { color: #16a34a; }

            /* Contenido de an√°lisis */
            .analysis-content {
              background: #f9fafb;
              border-radius: 8px;
              padding: 12px;
            }

            .no-data {
              text-align: center;
              color: #6b7280;
              font-style: italic;
              padding: 12px;
            }

            /* Estilos para el contenido del an√°lisis de rentabilidad */
            .analysis-content .flex {
              display: flex;
            }

            .analysis-content .items-center {
              align-items: center;
            }

            .analysis-content .items-start {
              align-items: flex-start;
            }

            .analysis-content .justify-between {
              justify-content: space-between;
            }

            .analysis-content .mb-2 { margin-bottom: 6px; }
            .analysis-content .mb-3 { margin-bottom: 8px; }
            .analysis-content .mb-4 { margin-bottom: 10px; }
            .analysis-content .mb-6 { margin-bottom: 12px; }
            .analysis-content .mr-3 { margin-right: 8px; }

            .analysis-content .grid {
              display: grid;
            }

            .analysis-content .grid-cols-3 {
              grid-template-columns: repeat(3, 1fr);
            }

            .analysis-content .gap-4 {
              gap: 8px;
            }

            .analysis-content .p-4 {
              padding: 8px;
            }

            .analysis-content .rounded-lg {
              border-radius: 6px;
            }

            .analysis-content .border {
              border: 1px solid #d1d5db;
            }

            .analysis-content .text-center {
              text-align: center;
            }

            .analysis-content .font-semibold {
              font-weight: 600;
            }

            .analysis-content .text-sm {
              font-size: 10px;
              line-height: 1.3;
            }

            .analysis-content .text-2xl {
              font-size: 14px;
              line-height: 1.2;
            }

            /* Ajustes espec√≠ficos para tarjetas de an√°lisis */
            .analysis-content > div {
              page-break-inside: avoid;
              margin-bottom: 8px;
            }

            /* Inversi√≥n total - m√°s compacto */
            .analysis-content > div:first-child {
              margin-bottom: 10px;
            }

            .analysis-content > div:first-child .text-2xl {
              font-size: 16px;
            }

            /* Grid de escenarios - m√°s compacto */
            .analysis-content .grid-cols-3 > div {
              padding: 6px;
              font-size: 9px;
            }

            .analysis-content .grid-cols-3 h5 {
              font-size: 10px;
              margin-bottom: 4px;
            }

            .analysis-content .grid-cols-3 .space-y-2 > div {
              margin-bottom: 2px;
            }

            .analysis-content .grid-cols-3 .border-t {
              border-top: 1px solid;
              padding-top: 3px;
              margin-top: 3px;
            }

            /* Alertas y advertencias - m√°s compactas */
            .analysis-content > div:last-child {
              padding: 8px;
              font-size: 10px;
            }

            .analysis-content > div:last-child h4 {
              font-size: 11px;
              margin-bottom: 4px;
            }

            .analysis-content > div:last-child p {
              margin-bottom: 3px;
              line-height: 1.3;
            }

            /* Colores para el an√°lisis */
            .analysis-content .bg-green-50 { background-color: #f0fdf4; }
            .analysis-content .bg-yellow-50 { background-color: #fefce8; }
            .analysis-content .bg-red-50 { background-color: #fef2f2; }
            .analysis-content .border-green-200 { border-color: #bbf7d0; }
            .analysis-content .border-yellow-200 { border-color: #fef3c7; }
            .analysis-content .border-red-200 { border-color: #fecaca; }
            .analysis-content .text-green-800 { color: #166534; }
            .analysis-content .text-yellow-800 { color: #92400e; }
            .analysis-content .text-red-800 { color: #991b1b; }
            .analysis-content .text-green-600 { color: #16a34a; }
            .analysis-content .text-red-600 { color: #dc2626; }
            .analysis-content .text-blue-600 { color: #2563eb; }
            .analysis-content .text-gray-600 { color: #4b5563; }

            /* Configuraci√≥n de impresi√≥n */
            @media print {
              body { 
                margin: 0; 
                padding: 10px;
                font-size: 12px;
              }
              
              @page { 
                margin: 0.4in;
                size: letter;
              }
              
              .section {
                page-break-inside: avoid;
                margin-bottom: 12px;
              }
              
              .scenarios-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
              }
              
              .indicators-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
              }
              
              .main-title {
                font-size: 22px;
              }
              
              .section-title {
                font-size: 13px;
              }
              
              /* An√°lisis de rentabilidad espec√≠fico para impresi√≥n */
              .analysis-content {
                padding: 8px;
                font-size: 9px;
              }
              
              .analysis-content .grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 4px;
              }
              
              .analysis-content .grid-cols-3 > div {
                padding: 4px;
                font-size: 8px;
              }
              
              .analysis-content > div:last-child {
                padding: 6px;
                font-size: 9px;
              }
              
              .analysis-content > div:last-child h4 {
                font-size: 10px;
              }
            }

            /* Responsive para pantallas peque√±as */
            @media screen and (max-width: 768px) {
              .scenarios-grid,
              .indicators-grid {
                grid-template-columns: 1fr;
              }
            }
          </style>
        </head>
        <body>
          ${proyeccionesContent}
        </body>
        </html>
      `);
      
      printWindow.document.close();
      
      // Esperar a que se cargue el contenido y luego imprimir
      printWindow.onload = function() {
        setTimeout(() => {
          printWindow.print();
          printWindow.close();
          
          // üîì REACTIVAR GUARDADO AUTOM√ÅTICO despu√©s de imprimir
          autoSaveEnabled = true;
          console.log('üîì Guardado autom√°tico REACTIVADO despu√©s de impresi√≥n');
        }, 250);
      };
    }

    // Entradas que impactan c√°lculos globales
    document.addEventListener('input', (e) => {
      const t = e.target;
      if (t.matches('.inversion-items input[type="number"], .costos-fijos input[type="number"], .costos-variables input[type="number"]')) {
        calcularInversion(); 
        calcularCostos();
        calcularProductos(); // Ya incluye updateProjectionCalculations()
      }
      if (t.matches('.unidades-mensuales, .horas-por-dia, .dias-por-mes, .honorarios-hora')) {
        calcularCostos(); // Recalcular costos primero (incluye honorarios)
        calcularProductos(); // Ya incluye updateProjectionCalculations()
      }
      if (t.matches('.nombre-producto')) {
        // Solo actualizar headers de proyecciones, no reconstruir tablas
        updateProjectionHeaders();
      }
      if (t.id === 'beneficiosClave' || t.id === 'diasValidez' || t.id === 'fechaEmisionInput') {
        actualizarCotizacion();
      }
      
      // Proyecciones financieras
      if (t.id === 'tamValue') {
        calculateMarketSizes();
      }
      // Los inputs de proyecciones mensuales se manejan en el sistema de guardado inmediato
    });

    function actualizarTituloProducto(input){
      const card = input.closest('.product-card');
      const titulo = card.querySelector('.product-title');
      const nombre = input.value.trim();
      titulo.textContent = nombre ? `üì¶ ${nombre.toUpperCase()}` : `üì¶ ${card.getAttribute('data-locked')==='true' ? 'PRODUCTO 1' : 'PRODUCTO ' + card.getAttribute('data-product-id')}`;
    }

    // Sistema de guardado autom√°tico en localStorage
    const STORAGE_KEY = 'calculadora_precios_data';
    let autoSaveEnabled = true;
    
    function guardarDatos() {
      if (!autoSaveEnabled) {
        console.log('üíæ Guardado omitido - autoSave desactivado');
        return;
      }
      
      console.log('üíæ Iniciando guardado autom√°tico...');
      try {
        const data = {
          version: '1.2',
          timestamp: Date.now(),
          monedaActual,
          contadorProductos,
          impuestosPersonalizados,
          configuracionGeneral: {
            fechaEmision: qs('#fechaEmisionInput')?.value || '',
            diasValidez: qs('#diasValidez')?.value || '',
            beneficiosClave: qs('#beneficiosClave')?.value || '',
            customProfitGlobal: qs('#inputCustomProfitGlobal')?.value || '',
            estrategiaActiva: getActiveStrategy()
          },
          productos: []
        };

        // Funci√≥n para obtener estrategia activa
        function getActiveStrategy() {
          const customStrategy = qs('#customStrategy');
          const customInput = qs('#inputCustomProfitGlobal');
          
          if (customStrategy && customStrategy.classList.contains('estrategia-activa') && customInput && customInput.value) {
            return { type: 'custom', value: customInput.value };
          }
          
          const activeBtn = qs('.estrategia-btn.estrategia-activa');
          if (activeBtn) {
            return { type: 'preset', value: activeBtn.getAttribute('data-profit') };
          }
          
          return { type: 'preset', value: '30' };
        }

        // Guardar datos de proyecciones financieras
        data.proyeccionesFinancieras = {
          tam: qs('#tamValue')?.value || '',
          samFilters: samFilters || [],
          somFilters: somFilters || [],
          proyeccionesMensuales: []
        };

        // GUARDADO MEJORADO DE PROYECCIONES MENSUALES CON ID √öNICO
        const productCards = qsa('.product-card');
        console.log(`üíæ Encontradas ${productCards.length} tarjetas de producto para guardar proyecciones`);
        
        productCards.forEach((card, productIndex) => {
          const productId = card.getAttribute('data-product-id');
          console.log(`üíæ Procesando proyecciones para producto ID: ${productId} (√≠ndice: ${productIndex})`);
          
          const proyeccionMensual = {
            productId: productId, // Usar ID √∫nico como identificador principal
            optimista: [],
            realista: [],
            pesimista: []
          };

          let hasData = false;

          ['optimist', 'realist', 'pessimist'].forEach(scenario => {
            const scenarioKey = scenario === 'optimist' ? 'optimista' : scenario === 'realist' ? 'realista' : 'pesimista';
            
            for (let month = 0; month < 12; month++) {
              // Buscar input usando el ID √∫nico del producto
              let input = qs(`input[data-product-id="${productId}"][data-scenario="${scenario}"][data-month="${month}"]`);
              
              // Fallback: buscar por √≠ndice (compatibilidad con versiones anteriores)
              if (!input) {
                input = qs(`input[data-product="${productIndex}"][data-scenario="${scenario}"][data-month="${month}"]`);
              }
              
              // Fallback: buscar en la tabla espec√≠fica del producto
              if (!input) {
                const monthlyTables = qsa('#monthlyProjectionsContainer table');
                if (monthlyTables[productIndex]) {
                  input = qs(`input[data-scenario="${scenario}"][data-month="${month}"]`, monthlyTables[productIndex]);
                }
              }
              
              const value = input?.value || '0';
              proyeccionMensual[scenarioKey].push(value);
              
              if (value !== '0') {
                hasData = true;
                console.log(`üìä Guardado: Producto ID ${productId}, ${scenario}, Mes ${month + 1}: ${value}`);
              }
            }
          });

          if (hasData) {
            console.log(`‚úÖ Producto ID ${productId} tiene datos de proyecci√≥n, guardando...`);
          } else {
            console.log(`‚ÑπÔ∏è Producto ID ${productId} sin datos de proyecci√≥n (valores en 0)`);
          }

          data.proyeccionesFinancieras.proyeccionesMensuales.push(proyeccionMensual);
        });

        // Guardar datos de cada producto
        qsa('.product-card').forEach(card => {
          const productId = card.getAttribute('data-product-id');
          const profit = card.getAttribute('data-profit') || '30';

          const producto = {
            id: productId,
            profit: profit,
            nombre: qs('.nombre-producto', card)?.value || '',
            unidadesMensuales: qs('.unidades-mensuales', card)?.value || '1',
            horasTrabajo: {
              horasPorDia: qs('.horas-por-dia', card)?.value || '',
              diasPorMes: qs('.dias-por-mes', card)?.value || '',
              horasProyecto: qs('.horas-proyecto', card)?.value || '',
              honorariosHora: qs('.honorarios-hora', card)?.value || ''
            },
            inversion: [],
            costosFijos: [],
            costosVariables: []
          };

          // Guardar inversi√≥n inicial - TODAS las filas, incluso vac√≠as para mantener estructura
          qsa('.inversion-items > div', card).forEach(row => {
            const conceptoInput = qs('input[type="text"]', row);
            const valorInput = qs('input[type="number"]', row);
            
            if (conceptoInput && valorInput) {
              producto.inversion.push({ 
                concepto: conceptoInput.value || '', 
                valor: valorInput.value || '0' 
              });
            }
          });

          // Guardar costos fijos - TODAS las filas
          qsa('.costos-fijos > div', card).forEach(row => {
            const conceptoInput = qs('input[type="text"]', row);
            const valorInput = qs('input[type="number"]', row);
            
            if (conceptoInput && valorInput) {
              producto.costosFijos.push({ 
                concepto: conceptoInput.value || '', 
                valor: valorInput.value || '0' 
              });
            }
          });

          // Guardar costos variables - TODAS las filas
          qsa('.costos-variables > div', card).forEach(row => {
            const conceptoInput = qs('input[type="text"]', row);
            const valorInput = qs('input[type="number"]', row);
            
            if (conceptoInput && valorInput) {
              producto.costosVariables.push({ 
                concepto: conceptoInput.value || '', 
                valor: valorInput.value || '0' 
              });
            }
          });

          data.productos.push(producto);
        });

        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        console.log('üíæ Datos guardados exitosamente');
      } catch (error) {
        console.warn('‚ùå Error al guardar datos:', error);
      }
    }

    function cargarDatos() {
      try {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (!savedData) return false;

        const data = JSON.parse(savedData);
        if (!data.version) return false;

        console.log('üîÑ Iniciando restauraci√≥n de datos...');
        
        // üîí DESACTIVAR GUARDADO AUTOM√ÅTICO DURANTE RESTAURACI√ìN
        autoSaveEnabled = false;
        console.log('üîí Guardado autom√°tico DESACTIVADO');

        // üßπ LIMPIEZA COMPLETA Y GARANTIZADA DEL DOM
        limpiarProductosCompletamente();

        function limpiarProductosCompletamente() {
          console.log('üßπ Limpiando DOM completamente...');
          
          // 1. Limpiar el contenedor principal completamente
          const container = qs('#productosCompletosContainer');
          if (container) {
            container.innerHTML = '';
            console.log('‚úÖ Contenedor principal limpiado');
          }
          
          // 2. Eliminar cualquier tarjeta de producto que pueda existir en todo el DOM
          const existingCards = qsa('.product-card');
          console.log(`üóëÔ∏è Eliminando ${existingCards.length} tarjetas existentes`);
          existingCards.forEach(card => card.remove());
          
          // 3. Resetear contador para evitar conflictos de numeraci√≥n
          contadorProductos = 0;
          console.log('üî¢ Contador reseteado a 0');
          
          // 4. Actualizar contador visual
          actualizarConteoProductos();
          console.log('üìä Contador visual actualizado');
        }

        // Restaurar configuraci√≥n general
        monedaActual = data.monedaActual || 'Q';
        contadorProductos = data.contadorProductos || 1;
        impuestosPersonalizados = data.impuestosPersonalizados || [];

        // Actualizar selector de moneda
        qs('#monedaSelector').value = monedaActual;
        qsa('.moneda').forEach(el => el.textContent = monedaActual);

        // Restaurar campos de configuraci√≥n
        if (data.configuracionGeneral) {
          const config = data.configuracionGeneral;
          if (config.fechaEmision) qs('#fechaEmisionInput').value = config.fechaEmision;
          if (config.diasValidez) qs('#diasValidez').value = config.diasValidez;
          if (config.beneficiosClave) qs('#beneficiosClave').value = config.beneficiosClave;
          if (config.customProfitGlobal) qs('#inputCustomProfitGlobal').value = config.customProfitGlobal;
          
          // Restaurar estrategia activa - MEJORADO
          qsa('.estrategia-btn').forEach(btn => btn.classList.remove('estrategia-activa','bg-blue-50','border-blue-300'));
          qs('#customStrategy')?.classList.remove('estrategia-activa');
          
          if (config.estrategiaActiva) {
            if (typeof config.estrategiaActiva === 'object') {
              // Nueva estructura con type y value
              if (config.estrategiaActiva.type === 'custom') {
                qs('#inputCustomProfitGlobal').value = config.estrategiaActiva.value;
                qs('#customStrategy')?.classList.add('estrategia-activa');
              } else {
                const activeBtn = qs(`.estrategia-btn[data-profit="${config.estrategiaActiva.value}"]`);
                if (activeBtn) activeBtn.classList.add('estrategia-activa');
              }
            } else {
              // Compatibilidad con versi√≥n anterior
              if (config.customProfitGlobal && config.customProfitGlobal !== '') {
                qs('#customStrategy')?.classList.add('estrategia-activa');
              } else {
                const activeBtn = qs(`.estrategia-btn[data-profit="${config.estrategiaActiva}"]`);
                if (activeBtn) activeBtn.classList.add('estrategia-activa');
              }
            }
          }
        }

        // Renderizar impuestos
        renderImpuestos();

        // Restaurar datos de proyecciones financieras
        if (data.proyeccionesFinancieras) {
          const pf = data.proyeccionesFinancieras;
          
          // Restaurar TAM
          if (pf.tam) qs('#tamValue').value = pf.tam;
          
          // Restaurar filtros SAM y SOM
          samFilters = pf.samFilters || [];
          somFilters = pf.somFilters || [];
          renderSamFilters();
          renderSomFilters();
          calculateMarketSizes();
        }

        // Restaurar productos
        if (data.productos && data.productos.length > 0) {

          data.productos.forEach(producto => {
            // Crear producto (indicando que es restauraci√≥n)
            const card = crearTarjetaProducto(producto.id, true);
            qs('#productosCompletosContainer').appendChild(card);

            // Restaurar datos b√°sicos
            card.setAttribute('data-profit', producto.profit || '30');
            if (producto.nombre) qs('.nombre-producto', card).value = producto.nombre;
            if (producto.unidadesMensuales) qs('.unidades-mensuales', card).value = producto.unidadesMensuales;

            // Restaurar horas de trabajo
            if (producto.horasTrabajo) {
              const ht = producto.horasTrabajo;
              if (ht.horasPorDia) qs('.horas-por-dia', card).value = ht.horasPorDia;
              if (ht.diasPorMes) qs('.dias-por-mes', card).value = ht.diasPorMes;
              if (ht.horasProyecto) qs('.horas-proyecto', card).value = ht.horasProyecto;
              if (ht.honorariosHora) qs('.honorarios-hora', card).value = ht.honorariosHora;
            }

            // Restaurar inversi√≥n inicial - MEJORADO
            const inversionContainer = qs('.inversion-items', card);
            if (inversionContainer && producto.inversion && producto.inversion.length > 0) {
              // Limpiar contenedor
              while (inversionContainer.firstChild) {
                inversionContainer.removeChild(inversionContainer.firstChild);
              }
              
              // Restaurar elementos
              producto.inversion.forEach(item => {
                const row = document.createElement('div');
                row.className = 'flex flex-col sm:flex-row gap-2 sm:gap-3 sm:items-center';
                row.innerHTML = `
                  <input type="text" value="${item.concepto || ''}" placeholder="Describe el concepto" class="flex-1 p-2 border border-teal-400 rounded-lg text-xs sm:text-sm">
                  <div class="flex gap-2 items-center">
                    <div class="relative w-24 sm:w-28">
                      <span class="absolute left-2 top-2 text-teal-700 font-semibold text-xs moneda">${monedaActual}</span>
                      <input type="number" value="${item.valor || '0'}" class="w-full pl-6 pr-2 py-2 border border-teal-400 rounded-lg text-xs sm:text-sm">
                    </div>
                    <button class="eliminar-item text-orange-600 hover:bg-orange-500 hover:text-white p-1 rounded shrink-0">üóëÔ∏è</button>
                  </div>
                `;
                inversionContainer.appendChild(row);
              });
            }

            // Restaurar costos fijos - MEJORADO
            const fijosContainer = qs('.costos-fijos', card);
            if (fijosContainer && producto.costosFijos && producto.costosFijos.length > 0) {
              // Limpiar contenedor
              while (fijosContainer.firstChild) {
                fijosContainer.removeChild(fijosContainer.firstChild);
              }
              
              // Restaurar elementos
              producto.costosFijos.forEach(item => {
                const row = document.createElement('div');
                row.className = 'flex flex-col sm:flex-row gap-2 sm:items-center';
                row.innerHTML = `
                  <input type="text" value="${item.concepto || ''}" placeholder="Concepto" class="flex-1 p-2 border border-teal-400 rounded-lg text-xs">
                  <div class="flex gap-2 items-center">
                    <div class="relative w-24 sm:w-28">
                      <span class="absolute left-1 top-2 text-teal-700 font-semibold text-xs moneda">${monedaActual}</span>
                      <input type="number" value="${item.valor || '0'}" class="w-full pl-4 pr-1 py-2 border border-teal-400 rounded-lg text-xs">
                    </div>
                    <button class="eliminar-item text-orange-600 hover:bg-orange-500 hover:text-white text-xs p-1 rounded shrink-0">üóëÔ∏è</button>
                  </div>
                `;
                fijosContainer.appendChild(row);
              });
            }

            // Restaurar costos variables - MEJORADO
            const variablesContainer = qs('.costos-variables', card);
            if (variablesContainer && producto.costosVariables && producto.costosVariables.length > 0) {
              // Limpiar contenedor
              while (variablesContainer.firstChild) {
                variablesContainer.removeChild(variablesContainer.firstChild);
              }
              
              // Restaurar elementos
              producto.costosVariables.forEach(item => {
                const row = document.createElement('div');
                row.className = 'flex flex-col sm:flex-row gap-2 sm:items-center';
                row.innerHTML = `
                  <input type="text" value="${item.concepto || ''}" placeholder="Concepto" class="flex-1 p-2 border border-teal-400 rounded-lg text-xs">
                  <div class="flex gap-2 items-center">
                    <div class="relative w-24 sm:w-28">
                      <span class="absolute left-1 top-2 text-teal-700 font-semibold text-xs moneda">${monedaActual}</span>
                      <input type="number" value="${item.valor || '0'}" class="w-full pl-4 pr-1 py-2 border border-teal-400 rounded-lg text-xs">
                    </div>
                    <button class="eliminar-item text-orange-600 hover:bg-orange-500 hover:text-white text-xs p-1 rounded shrink-0">üóëÔ∏è</button>
                  </div>
                `;
                variablesContainer.appendChild(row);
              });
            }

            // Actualizar t√≠tulo del producto
            actualizarTituloProducto(qs('.nombre-producto', card));
          });

          // Actualizar contador de productos
          actualizarConteoProductos();
          
          // üîß CORRECCI√ìN CR√çTICA: Actualizar contador global para evitar IDs duplicados
          const idsExistentes = data.productos.map(p => parseInt(p.id)).filter(id => !isNaN(id));
          const maxId = idsExistentes.length > 0 ? Math.max(...idsExistentes) : 0;
          contadorProductos = maxId; // El pr√≥ximo producto ser√° maxId + 1

          // Guardar datos de proyecciones para restauraci√≥n posterior
          window.savedProjectionData = data.proyeccionesFinancieras;
        }

        // üîì REACTIVAR GUARDADO AUTOM√ÅTICO AL COMPLETAR RESTAURACI√ìN
        autoSaveEnabled = true;
        console.log('üîì Guardado autom√°tico REACTIVADO');
        console.log('‚úÖ Restauraci√≥n completada exitosamente');

        return true;
      } catch (error) {
        console.warn('‚ùå Error al cargar datos:', error);
        // Reactivar guardado incluso si hay error
        autoSaveEnabled = true;
        console.log('üîì Guardado autom√°tico REACTIVADO (por error)');
        return false;
      }
    }

    // Guardar autom√°ticamente cuando hay cambios
    function setupAutoSave() {
      // Guardar en cambios de inputs con debounce
      document.addEventListener('input', debounce(guardarDatos, 1500));
      document.addEventListener('change', debounce(guardarDatos, 800));
      
      // Guardar en clicks importantes (agregar/eliminar elementos)
      document.addEventListener('click', (e) => {
        const importantSelectors = [
          '.eliminar-item', '.add-inversion', '.add-fijo', '.add-variable', 
          '.delete-btn', '.estrategia-btn', '#btnAgregarImpuesto', 
          '[data-remove-tax]', '#btnAddProduct', '[data-remove-filter]',
          '#confirmSamFilter', '#confirmSomFilter', '#toggleSamForm', '#toggleSomForm'
        ];
        
        if (importantSelectors.some(selector => e.target.matches(selector) || e.target.closest(selector))) {
          setTimeout(guardarDatos, 150); // Peque√±o delay para que se complete la acci√≥n
        }
      });

      // üöÄ SISTEMA DE GUARDADO INMEDIATO PARA PROYECCIONES MENSUALES
      // Usar delegaci√≥n de eventos para capturar inputs din√°micos sin perder eventos
      document.addEventListener('input', (e) => {
        if (e.target.matches('.monthly-input') || 
            (e.target.matches('input[data-product-id][data-scenario][data-month]')) ||
            (e.target.matches('input[data-product][data-scenario][data-month]'))) {
          
          const productId = e.target.getAttribute('data-product-id');
          const productIndex = e.target.getAttribute('data-product'); // Fallback
          const scenario = e.target.getAttribute('data-scenario');
          const month = e.target.getAttribute('data-month');
          const value = e.target.value;
          
          console.log(`üìä Cambio detectado en proyecci√≥n mensual:`, {
            productoId: productId,
            productoIndex: productIndex,
            escenario: scenario,
            mes: parseInt(month) + 1,
            valor: value
          });
          
          // üîÑ ACTUALIZAR C√ÅLCULOS INMEDIATAMENTE
          updateProjectionsChart();
          updateScenarioSummary();
          calculateProfitabilityAnalysis();
          
          // üöÄ GUARDADO INMEDIATO SIN DEBOUNCE para proyecciones
          // Usar un debounce muy corto (100ms) para evitar m√∫ltiples guardados por tecla
          clearTimeout(window.projectionSaveTimeout);
          window.projectionSaveTimeout = setTimeout(() => {
            console.log('üíæ Guardado inmediato de proyecci√≥n mensual ejecutado');
            guardarDatos();
          }, 100);
        }
      });
      
      // Guardar tambi√©n en cambios de proyecciones mensuales con change event
      document.addEventListener('change', (e) => {
        if (e.target.matches('.monthly-input') || 
            (e.target.matches('input[data-product-id][data-scenario][data-month]')) ||
            (e.target.matches('input[data-product][data-scenario][data-month]'))) {
          
          const productId = e.target.getAttribute('data-product-id');
          const productIndex = e.target.getAttribute('data-product'); // Fallback
          const scenario = e.target.getAttribute('data-scenario');
          const month = e.target.getAttribute('data-month');
          const value = e.target.value;
          
          console.log(`üìä Cambio confirmado en proyecci√≥n mensual:`, {
            productoId: productId,
            productoIndex: productIndex,
            escenario: scenario,
            mes: parseInt(month) + 1,
            valor: value
          });
          
          // üîÑ ACTUALIZAR C√ÅLCULOS INMEDIATAMENTE
          updateProjectionsChart();
          updateScenarioSummary();
          calculateProfitabilityAnalysis();
          
          // üöÄ GUARDADO INMEDIATO al confirmar cambio
          console.log('üíæ Guardado inmediato por change event ejecutado');
          guardarDatos();
        }
      });

    // üöÄ FUNCI√ìN PARA CONFIGURAR GUARDADO INMEDIATO EN NUEVOS INPUTS DE PROYECCI√ìN
    function setupImmediateProjectionSave() {
      const projectionInputs = qsa('.monthly-input, input[data-product-id][data-scenario][data-month]');
      console.log(`üöÄ Configurando guardado inmediato para ${projectionInputs.length} inputs de proyecci√≥n`);
      
      // Los eventos ya est√°n configurados globalmente con delegaci√≥n,
      // pero podemos agregar atributos para identificar que est√°n listos
      projectionInputs.forEach(input => {
        if (!input.hasAttribute('data-immediate-save-ready')) {
          input.setAttribute('data-immediate-save-ready', 'true');
        }
      });
    }

      // Guardar antes de cerrar la p√°gina
      window.addEventListener('beforeunload', guardarDatos);
      
      // Guardar peri√≥dicamente (cada 45 segundos)
      setInterval(() => {
        if (autoSaveEnabled) {
          guardarDatos();
        }
      }, 45000);
      
      // Guardar cuando la p√°gina pierde el foco (usuario cambia de pesta√±a)
      document.addEventListener('visibilitychange', () => {
        if (document.hidden && autoSaveEnabled) {
          guardarDatos();
        }
      });
    }

    // Funci√≥n debounce para evitar guardar demasiado frecuentemente
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Boot
    const datosRestaurados = cargarDatos();
    
    if (!datosRestaurados) {
      // Si no hay datos guardados, inicializar normalmente
      renderImpuestos();
      initFechas();
      actualizarConteoProductos();
      updateMonthlyProjections(); // Crear tablas vac√≠as
      updateProjectionCalculations(); // Inicializar c√°lculos
    } else {
      // Si se restauraron datos, recalcular todo
      calcularInversion();
      calcularCostos();
      calcularProductos(); // Ya incluye updateProjectionCalculations()
      calcularEquilibrio();
      actualizarCotizacion();
      
      // CR√çTICO: Asegurar que las proyecciones se reconstruyan y calculen correctamente
      setTimeout(() => {
        updateMonthlyProjections(); // Reconstruir tablas con productos restaurados
        
        // Restaurar datos de proyecciones despu√©s de crear tablas
        setTimeout(() => {
          restaurarProyeccionesFinancieras();
          updateProjectionCalculations(); // Calcular despu√©s de restaurar datos
        }, 200);
      }, 100);
    }
    
    // Funci√≥n para restaurar proyecciones financieras
    function restaurarProyeccionesFinancieras() {
      const data = window.savedProjectionData;
      if (!data || !data.proyeccionesMensuales) {
        console.log('üìä No hay datos de proyecciones para restaurar');
        return;
      }
      
      console.log('üîÑ Iniciando restauraci√≥n de proyecciones financieras...');
      
      let proyeccionesRestauradas = 0;
      let inputsEncontrados = 0;
      let inputsNoEncontrados = 0;
      
      // Crear mapa de productos actuales por ID
      const productMap = new Map();
      const productCards = qsa('.product-card');
      productCards.forEach((card, index) => {
        const productId = card.getAttribute('data-product-id');
        productMap.set(productId, { card, index });
      });
      
      data.proyeccionesMensuales.forEach((proyeccion) => {
        const productId = proyeccion.productId;
        console.log(`üìä Restaurando proyecci√≥n para producto ID: ${productId}`);
        
        const productInfo = productMap.get(productId);
        if (!productInfo) {
          console.warn(`‚ö†Ô∏è Producto ID ${productId} no encontrado`);
          return;
        }
        
        ['optimista', 'realista', 'pesimista'].forEach(scenarioKey => {
          const scenarioEn = scenarioKey === 'optimista' ? 'optimist' : scenarioKey === 'realista' ? 'realist' : 'pessimist';
          
          if (proyeccion[scenarioKey] && Array.isArray(proyeccion[scenarioKey])) {
            proyeccion[scenarioKey].forEach((value, monthIndex) => {
              // Buscar input por ID √∫nico del producto
              let input = qs(`input[data-product-id="${productId}"][data-scenario="${scenarioEn}"][data-month="${monthIndex}"]`);
              
              if (input) {
                input.value = value || '0';
                inputsEncontrados++;
                
                if (value !== '0') {
                  console.log(`‚úÖ Restaurado: Producto ID ${productId}, ${scenarioEn}, Mes ${monthIndex + 1}: ${value}`);
                  proyeccionesRestauradas++;
                }
              } else {
                inputsNoEncontrados++;
                console.warn(`‚ö†Ô∏è Input no encontrado: Producto ID ${productId}, ${scenarioEn}, Mes ${monthIndex + 1}`);
              }
            });
          }
        });
      });
      
      console.log(`üìä Restauraci√≥n completada:`);
      console.log(`   - Inputs encontrados: ${inputsEncontrados}`);
      console.log(`   - Inputs no encontrados: ${inputsNoEncontrados}`);
      console.log(`   - Proyecciones restauradas: ${proyeccionesRestauradas}`);
      
      if (proyeccionesRestauradas > 0) {
        console.log('‚úÖ Proyecciones financieras restauradas exitosamente');
      }
    }
    
    // Configurar guardado autom√°tico
    setupAutoSave();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98849f530340cc74',t:'MTc1OTQxMjUzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
