<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Precios Universal</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text x=%2250%22 y=%2257%22 font-size=%2280%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>üßÆ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        
        .section-bg-estructura { background-color: #fef7f0; }
        .section-bg-productos { background-color: #f0f9ff; }
        .section-bg-cotizacion { background-color: #f7fee7; }
        .section-bg-proyecciones { background-color: #fdf4ff; }
        
        .nav-bg-estructura { background-color: #fef2e8; }
        .nav-bg-productos { background-color: #e0f2fe; }
        .nav-bg-cotizacion { background-color: #ecfccb; }
        .nav-bg-proyecciones { background-color: #fae8ff; }
        
        .active-estructura { 
            background-color: #fed7aa; 
            box-shadow: 0 4px 15px rgba(251, 146, 60, 0.3);
        }
        .active-productos { 
            background-color: #7dd3fc; 
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
        }
        .active-cotizacion { 
            background-color: #bef264; 
            box-shadow: 0 4px 15px rgba(132, 204, 22, 0.3);
        }
        .active-proyecciones { 
            background-color: #d8b4fe; 
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }
        
        .float-bg-estructura { background-color: #fed7aa; }
        .float-bg-productos { background-color: #7dd3fc; }
        .float-bg-cotizacion { background-color: #bef264; }
        .float-bg-proyecciones { background-color: #d8b4fe; }
        
        .mobile-active {
            background-color: white !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .transition-all {
            transition: all 0.3s ease;
        }
        
        .popup-overlay {
            backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        /* Rich text editor styles */
        #project-description[contenteditable="true"]:empty:before {
            content: attr(data-placeholder);
            color: #9CA3AF;
            font-style: italic;
        }
        
        #project-description[contenteditable="true"]:focus:before {
            content: none;
        }
        
        #project-description ul, #project-description ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }
        
        #project-description li {
            margin-bottom: 5px;
        }
        
        #project-description p {
            margin-bottom: 10px;
        }
        
        #project-description strong {
            font-weight: bold;
        }
        
        #project-description em {
            font-style: italic;
        }
        
        #project-description u {
            text-decoration: underline;
        }
    </style>
</head>
<body class="min-h-full transition-all section-bg-estructura">
    <!-- Header -->
    <header class="text-center py-8 px-4">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Calculadora de Precios Universal</h1>
        <p class="text-lg text-gray-600">Calcula precios autom√°ticamente y proyecta con estrategias de ganancia.</p>
    </header>

    <!-- Desktop Navigation -->
    <nav id="desktop-nav" class="hidden md:block sticky top-0 z-40 px-4 mb-8 transition-all">
        <div class="max-w-4xl mx-auto">
            <div id="nav-container" class="nav-bg-estructura rounded-full p-2 transition-all">
                <div class="flex justify-center items-center space-x-2">
                    <button onclick="switchSection('estructura')" class="nav-btn active-estructura rounded-full px-6 py-3 font-medium text-gray-700 transition-all" data-section="estructura">
                        üèõÔ∏è Estructura
                    </button>
                    <button onclick="switchSection('productos')" class="nav-btn rounded-full px-6 py-3 font-medium text-gray-700 transition-all" data-section="productos">
                        üõçÔ∏è Productos o Servicios
                    </button>
                    <button onclick="switchSection('cotizacion')" class="nav-btn rounded-full px-6 py-3 font-medium text-gray-700 transition-all" data-section="cotizacion">
                        üßæ Cotizaci√≥n
                    </button>
                    <button onclick="switchSection('proyecciones')" class="nav-btn rounded-full px-6 py-3 font-medium text-gray-700 transition-all" data-section="proyecciones">
                        üìà Proyecciones
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile Navigation -->
    <nav id="mobile-nav" class="md:hidden fixed bottom-0 left-0 right-0 z-50">
        <div id="mobile-nav-container" class="nav-bg-estructura mx-4 mb-4 rounded-full p-2 transition-all">
            <div class="flex justify-between items-center gap-2">
                <button onclick="switchSection('estructura')" class="mobile-nav-btn mobile-active rounded-full p-3 text-2xl transition-all flex-1 flex items-center justify-center" data-section="estructura">
                    üèõÔ∏è
                </button>
                <button onclick="switchSection('productos')" class="mobile-nav-btn rounded-full p-3 text-2xl transition-all flex-1 flex items-center justify-center" data-section="productos">
                    üõçÔ∏è
                </button>
                <button onclick="switchSection('cotizacion')" class="mobile-nav-btn rounded-full p-3 text-2xl transition-all flex-1 flex items-center justify-center" data-section="cotizacion">
                    üßæ
                </button>
                <button onclick="switchSection('proyecciones')" class="mobile-nav-btn rounded-full p-3 text-2xl transition-all flex-1 flex items-center justify-center" data-section="proyecciones">
                    üìà
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="px-2 sm:px-4 pb-32 md:pb-8">
        <div class="max-w-7xl mx-auto">
            <!-- Estructura Section -->
            <section id="section-estructura" class="section-content">
                <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 lg:p-8">
                    <div class="text-center mb-6 md:hidden">
                        <div class="text-6xl mb-4">üèõÔ∏è</div>
                        <h2 class="text-2xl font-bold text-gray-800">Estructura</h2>
                    </div>
                    
                    <!-- Configuraci√≥n General Card -->
                    <div class="bg-orange-50 border border-orange-100 rounded-xl p-4 sm:p-6 mb-4 sm:mb-6">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 sm:mb-6 text-center">‚öôÔ∏è Configuraci√≥n General</h3>
                        
                        <!-- Two Column Layout -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
                            <!-- A√±os operando y Moneda Card -->
                            <div class="bg-white border border-orange-200 rounded-lg p-3 sm:p-4">
                                <!-- A√±os operando section -->
                                <div class="mb-4">
                                    <div class="text-center mb-3">
                                        <div class="text-3xl mb-2">‚è±Ô∏è</div>
                                        <label class="block text-sm font-medium text-gray-700">A√±os operativos del negocio</label>
                                    </div>
                                    <input type="number" id="business-years" onchange="saveBusinessYears()" class="w-full px-4 py-3 bg-orange-50 border border-orange-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300" placeholder="Ej: 5" min="0" step="1">
                                </div>
                                
                                <!-- Divider -->
                                <div class="flex justify-center mb-4">
                                    <div class="w-4/5 h-px bg-orange-300"></div>
                                </div>
                                
                                <!-- Moneda section -->
                                <div>
                                    <div class="text-center mb-3">
                                        <div class="text-3xl mb-2">üí±</div>
                                        <label class="block text-sm font-medium text-gray-700">Seleccionar moneda</label>
                                    </div>
                                    <div class="relative">
                                        <select id="currency-select" onchange="saveCurrency()" class="w-full px-4 py-3 bg-orange-50 border border-orange-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300 appearance-none cursor-pointer">
                                            <option value="GTQ">üá¨üáπ Quetzales Q</option>
                                            <option value="USD">üá∫üá∏ D√≥lares $</option>
                                            <option value="EUR">üá™üá∏ Euros ‚Ç¨</option>
                                        </select>
                                        <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                            <svg class="w-4 h-4 text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Impuestos Card -->
                            <div class="bg-white border border-orange-200 rounded-lg p-3 sm:p-4">
                                <h4 class="text-base sm:text-lg font-medium text-gray-700 mb-2 sm:mb-3 text-center">üßæ Impuestos</h4>
                                <div id="impuestos-container" class="space-y-2 mb-4">
                                    <!-- Los impuestos se agregar√°n aqu√≠ din√°micamente -->
                                </div>
                                <div id="total-impuestos" class="bg-orange-200 border border-orange-300 rounded-lg p-3 mb-4 text-center">
                                    <div class="text-sm font-medium text-gray-700">Total de Impuestos</div>
                                    <div id="total-percentage" class="text-lg font-bold text-orange-800">0%</div>
                                </div>
                                <button onclick="openTaxPopup()" class="w-full bg-orange-100 hover:bg-orange-200 text-orange-700 font-medium py-2 px-4 rounded-lg transition-all">
                                    + Agregar impuesto
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Inversi√≥n inicial y gastos mensuales Card -->
                    <div class="bg-orange-50 border border-orange-100 rounded-xl p-4 sm:p-6">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 sm:mb-6 text-center">üíº Inversi√≥n inicial y gastos mensuales</h3>
                        
                        <!-- Two Column Layout -->
                        <div class="flex flex-col lg:flex-row gap-4 sm:gap-6">
                            <!-- Left Column - Investment costs -->
                            <div class="lg:w-[63%]">
                                <div class="bg-white border border-orange-200 rounded-lg p-4 sm:p-6 h-full">
                                    <h4 class="text-base sm:text-lg font-medium text-gray-700 mb-3 sm:mb-4 text-center">üèóÔ∏è Costos de inversi√≥n inicial</h4>
                                    
                                    <!-- Investment Table -->
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg overflow-hidden">
                                        <!-- Table Container -->
                                        <div class="overflow-x-auto">
                                            <table class="min-w-[650px] w-full" id="investments-table">
                                                <thead class="bg-orange-75">
                                                    <tr>
                                                        <th class="w-[200px] px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-orange-200">Nombre</th>
                                                        <th class="w-[150px] px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-orange-200">Valor</th>
                                                        <th class="w-[120px] px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-orange-200">Vida √∫til</th>
                                                        <th class="w-[180px] px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-orange-200">Costo por hora</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="investments-table-body">
                                                    <!-- Investment rows will be added here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Add Row Button -->
                                        <div class="bg-white border-t border-orange-200 p-3">
                                            <button onclick="addInvestmentRow()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg transition-all">
                                                + Agregar nueva fila
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Investment Amount -->
                                    <div class="bg-orange-200 border border-orange-300 rounded-lg p-4 text-center mt-4">
                                        <div class="text-sm font-medium text-gray-700">Total de inversiones</div>
                                        <div id="total-investment-amount" class="text-xl font-bold text-orange-800">Q 0.00</div>
                                    </div>
                                    
                                    <!-- Divider -->
                                    <div class="flex justify-center mt-6 mb-6">
                                        <div class="w-4/5 h-px bg-orange-300"></div>
                                    </div>
                                    
                                    <!-- Raw Materials Section -->
                                    <h4 class="text-base sm:text-lg font-medium text-gray-700 mb-3 sm:mb-4 text-center">ü•ï Materia prima</h4>
                                    
                                    <!-- Raw Materials Table -->
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg overflow-hidden">
                                        <!-- Table Container -->
                                        <div class="overflow-x-auto">
                                            <table class="min-w-[800px] w-full" id="raw-materials-table">
                                                <thead class="bg-orange-75">
                                                    <tr>
                                                        <th class="w-[150px] px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-orange-200">Descripci√≥n</th>
                                                        <th class="w-[120px] px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-orange-200">Costo</th>
                                                        <th class="w-[70px] px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-orange-200">Cantidad</th>
                                                        <th class="w-[120px] px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-orange-200">Horas de trabajo</th>
                                                        <th class="w-[120px] px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-orange-200">Costo unitario</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="raw-materials-table-body">
                                                    <!-- Raw material rows will be added here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Add Row Button -->
                                        <div class="bg-white border-t border-orange-200 p-3">
                                            <button onclick="addRawMaterialRow()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg transition-all">
                                                + Agregar nueva fila
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Raw Materials Amount -->
                                    <div class="bg-orange-200 border border-orange-300 rounded-lg p-4 text-center mt-4">
                                        <div class="text-sm font-medium text-gray-700">Total de materia prima</div>
                                        <div id="total-raw-materials-amount" class="text-xl font-bold text-orange-800">Q 0.00</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column - Fixed costs -->
                            <div class="lg:w-[37%]">
                                <div class="bg-white border border-orange-200 rounded-lg p-4 sm:p-6 flex flex-col h-full">
                                    <h4 class="text-base sm:text-lg font-medium text-gray-700 mb-3 sm:mb-4 text-center">üìÜ Costos fijos mensuales</h4>
                                    
                                    <!-- Fixed Costs Table -->
                                    <div class="bg-orange-50 border border-orange-200 rounded-lg overflow-hidden mb-4">
                                        <!-- Table Container -->
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full w-full" id="fixed-costs-table">
                                                <thead class="bg-orange-75">
                                                    <tr>
                                                        <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-orange-200">Nombre</th>
                                                        <th class="px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-orange-200">Costo mensual</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="fixed-costs-table-body">
                                                    <!-- Fixed cost rows will be added here -->
                                                </tbody>
                                            </table>
                                        </div>
                                        
                                        <!-- Add Row Button -->
                                        <div class="bg-white border-t border-orange-200 p-3">
                                            <button onclick="addFixedCostRow()" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-2 px-4 rounded-lg transition-all">
                                                + Agregar nueva fila
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <!-- Total Fixed Costs -->
                                    <div class="bg-orange-200 border border-orange-300 rounded-lg p-3 mb-4 text-center">
                                        <div class="text-sm font-medium text-gray-700">Total de Costos Fijos</div>
                                        <div id="total-fixed-amount" class="text-lg font-bold text-orange-800">Q 0.00</div>
                                    </div>
                                    
                                    <!-- Divider -->
                                    <div class="flex justify-center mb-4">
                                        <div class="w-4/5 h-px bg-orange-300"></div>
                                    </div>
                                    
                                    <!-- Honorarios Configuration -->
                                    <div class="space-y-3">
                                        <h5 class="text-md font-medium text-gray-700 text-center">‚åö Configuraci√≥n de Honorarios</h5>
                                        <p class="text-sm text-gray-600 italic text-center">¬øCu√°nto cobra el due√±o de la empresa?</p>
                                        
                                        <!-- Honorarios Fields - Vertical Layout -->
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Horas diarias</label>
                                                <input type="number" id="daily-hours" onchange="calculateHonorarios()" oninput="calculateHonorarios()" class="w-full px-3 py-2 text-sm bg-orange-50 border border-orange-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-300" placeholder="8" min="0" step="0.5">
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-700 mb-1">Cobro por hora</label>
                                                <div class="relative">
                                                    <div id="hourly-rate-currency" class="absolute inset-y-0 left-0 flex items-center px-2 text-xs text-gray-500">Q</div>
                                                    <input type="number" id="hourly-rate" onchange="calculateHonorarios()" oninput="calculateHonorarios()" class="w-full px-3 py-2 pl-8 text-sm bg-orange-50 border border-orange-200 rounded focus:outline-none focus:ring-1 focus:ring-orange-300" placeholder="50" min="0" step="0.01">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Productos Section -->
            <section id="section-productos" class="section-content hidden">
                <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 lg:p-8">
                    <div class="text-center mb-6 md:hidden">
                        <div class="text-5xl sm:text-6xl mb-4">üõçÔ∏è</div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Productos o Servicios</h2>
                    </div>
                    
                    <!-- Projects Grid -->
                    <div id="projects-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-6">
                        <!-- Projects will be added here dynamically -->
                    </div>
                    
                    <!-- Add Service and Product Buttons -->
                    <div class="flex justify-center space-x-4">
                        <button onclick="openProjectPopup()" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-lg transition-all">
                            + Agregar servicio
                        </button>
                        <button onclick="openProjectPopup('product')" class="bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-lg transition-all">
                            + Agregar producto
                        </button>
                    </div>
                </div>
            </section>

            <!-- Cotizaci√≥n Section -->
            <section id="section-cotizacion" class="section-content hidden">
                <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 lg:p-8">
                    <div class="text-center mb-6 md:hidden">
                        <div class="text-5xl sm:text-6xl mb-4">üßæ</div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Cotizaci√≥n</h2>
                    </div>
                    
                    <!-- Informaci√≥n de cotizaci√≥n Card -->
                    <div class="bg-lime-50 border border-lime-100 rounded-xl p-4 sm:p-6 mb-6">
                        <h3 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 sm:mb-6 text-center">üìã Informaci√≥n de cotizaci√≥n</h3>
                        
                        <!-- Basic Info Fields -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo de la cotizaci√≥n</label>
                                <input type="text" id="quote-title" onchange="updateQuoteDisplay()" oninput="updateQuoteDisplay()" class="w-full px-4 py-3 bg-lime-50 border border-lime-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-lime-300 focus:border-lime-300" placeholder="Ej: Cotizaci√≥n de servicios web">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Emisi√≥n</label>
                                <input type="date" id="quote-date" onchange="updateQuoteDisplay()" class="w-full px-4 py-3 bg-lime-50 border border-lime-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-lime-300 focus:border-lime-300">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">D√≠as de Validez (opcional)</label>
                                <input type="number" id="quote-validity" onchange="updateQuoteDisplay()" oninput="updateQuoteDisplay()" class="w-full px-4 py-3 bg-lime-50 border border-lime-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-lime-300 focus:border-lime-300" placeholder="30" min="1">
                            </div>
                        </div>
                        
                        <!-- Pricing Strategy Buttons -->
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                            <button onclick="selectPricingStrategy('minimum', 10)" id="pricing-minimum" class="pricing-strategy-btn bg-white border-2 border-lime-200 rounded-lg p-4 text-center transition-all hover:bg-lime-100">
                                <div class="text-4xl mb-2">üíö</div>
                                <div class="text-sm font-medium text-gray-700 mb-1">M√≠nimo no negociable</div>
                                <div class="text-lg font-bold text-gray-800">10%</div>
                            </button>
                            <button onclick="selectPricingStrategy('regular', 30)" id="pricing-regular" class="pricing-strategy-btn bg-white border-2 border-lime-200 rounded-lg p-4 text-center transition-all hover:bg-lime-100">
                                <div class="text-4xl mb-2">üíô</div>
                                <div class="text-sm font-medium text-gray-700 mb-1">Precio regular</div>
                                <div class="text-lg font-bold text-gray-800">30%</div>
                            </button>
                            <button onclick="selectPricingStrategy('ideal', 130)" id="pricing-ideal" class="pricing-strategy-btn bg-white border-2 border-lime-200 rounded-lg p-4 text-center transition-all hover:bg-lime-100">
                                <div class="text-4xl mb-2">üíú</div>
                                <div class="text-sm font-medium text-gray-700 mb-1">Precio ideal</div>
                                <div class="text-lg font-bold text-gray-800">130%</div>
                            </button>
                            <div class="bg-white border-2 border-lime-200 rounded-lg p-4 text-center">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Personalizado</label>
                                <div class="relative">
                                    <input type="number" id="custom-percentage" onchange="selectPricingStrategy('custom', this.value)" oninput="selectPricingStrategy('custom', this.value)" class="w-full px-3 py-2 pr-8 bg-lime-50 border border-lime-200 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-lime-300 focus:border-lime-300 text-center" placeholder="0" min="0" step="0.1">
                                    <div class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Comments Section -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2 text-left">üé§ Comentarios (opcional)</label>
                            
                            <!-- Text Editor Toolbar -->
                            <div class="border border-lime-300 rounded-t-lg bg-lime-50 p-2 flex flex-wrap gap-1">
                                <button type="button" onclick="formatQuoteText('bold')" class="px-2 py-1 text-sm bg-white border border-lime-200 rounded hover:bg-lime-100 transition-all" title="Negrita">
                                    <strong>B</strong>
                                </button>
                                <button type="button" onclick="formatQuoteText('italic')" class="px-2 py-1 text-sm bg-white border border-lime-200 rounded hover:bg-lime-100 transition-all" title="Cursiva">
                                    <em>I</em>
                                </button>
                                <button type="button" onclick="formatQuoteText('underline')" class="px-2 py-1 text-sm bg-white border border-lime-200 rounded hover:bg-lime-100 transition-all" title="Subrayado">
                                    <u>U</u>
                                </button>
                                <div class="w-px h-6 bg-lime-300 mx-1"></div>
                                <button type="button" onclick="formatQuoteText('insertUnorderedList')" class="px-2 py-1 text-sm bg-white border border-lime-200 rounded hover:bg-lime-100 transition-all" title="Lista con vi√±etas">
                                    ‚Ä¢ Lista
                                </button>
                                <button type="button" onclick="formatQuoteText('insertOrderedList')" class="px-2 py-1 text-sm bg-white border border-lime-200 rounded hover:bg-lime-100 transition-all" title="Lista numerada">
                                    1. Lista
                                </button>
                                <div class="w-px h-6 bg-lime-300 mx-1"></div>
                                <button type="button" onclick="formatQuoteText('justifyLeft')" class="px-2 py-1 text-sm bg-white border border-lime-200 rounded hover:bg-lime-100 transition-all" title="Alinear izquierda">
                                    ‚¨Ö
                                </button>
                                <button type="button" onclick="formatQuoteText('justifyCenter')" class="px-2 py-1 text-sm bg-white border border-lime-200 rounded hover:bg-lime-100 transition-all" title="Centrar">
                                    ‚Üî
                                </button>
                                <button type="button" onclick="formatQuoteText('justifyRight')" class="px-2 py-1 text-sm bg-white border border-lime-200 rounded hover:bg-lime-100 transition-all" title="Alinear derecha">
                                    ‚û°
                                </button>
                            </div>
                            
                            <!-- Rich Text Editor -->
                            <div id="quote-comments" contenteditable="true" onblur="updateQuoteDisplay()" oninput="updateQuoteDisplay()" class="w-full min-h-[120px] px-4 py-3 border border-lime-300 border-t-0 rounded-b-lg focus:outline-none focus:ring-2 focus:ring-lime-300 focus:border-lime-300 bg-white" style="max-height: 200px; overflow-y: auto;" data-placeholder="Ingrese comentarios adicionales sobre la cotizaci√≥n...">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quote Display Card -->
                    <div class="bg-lime-50 border border-lime-100 rounded-xl p-4 sm:p-6 mb-6">
                        <div class="mb-6 text-center">
                            <h3 id="display-quote-title" class="text-xl font-bold text-gray-800 mb-2">Cotizaci√≥n</h3>
                            <div id="display-quote-date" class="text-lg font-semibold text-gray-700 mb-1"></div>
                            <div id="display-quote-validity" class="text-base text-gray-600 mb-4"></div>
                            <div id="display-quote-comments" class="text-gray-700" style="text-align: left;"></div>
                        </div>
                        
                        <!-- Quote Table -->
                        <div class="bg-white border border-lime-200 rounded-lg overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="min-w-full w-full" id="quote-table">
                                    <thead class="bg-lime-100">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b border-lime-200">Producto/Servicio</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 border-b border-lime-200">Cantidad</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 border-b border-lime-200">Precio Unitario</th>
                                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 border-b border-lime-200">Subtotal</th>
                                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b border-lime-200">Descripci√≥n</th>
                                        </tr>
                                    </thead>
                                    <tbody id="quote-table-body">
                                        <!-- Quote items will be added here -->
                                    </tbody>
                                    <tfoot class="bg-lime-50">
                                        <tr>
                                            <td colspan="3" class="px-4 py-3 text-right font-semibold text-gray-700 border-t border-lime-200">Total:</td>
                                            <td id="quote-total" class="px-4 py-3 text-center font-bold text-lg text-gray-800 border-t border-lime-200">Q 0.00</td>
                                            <td class="border-t border-lime-200"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Print Button -->
                    <div class="text-center">
                        <button onclick="printQuote()" class="bg-lime-500 hover:bg-lime-600 text-white font-medium py-3 px-6 rounded-lg transition-all">
                            üñ®Ô∏è Imprimir cotizaci√≥n
                        </button>
                    </div>
                </div>
            </section>

            <!-- Proyecciones Section -->
            <section id="section-proyecciones" class="section-content hidden">
                <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 lg:p-8">
                    <div class="text-center mb-6 md:hidden">
                        <div class="text-5xl sm:text-6xl mb-4">üìà</div>
                        <h2 class="text-xl sm:text-2xl font-bold text-gray-800">Proyecciones</h2>
                    </div>
                    <div class="text-center text-gray-500">
                        <p>Contenido de la secci√≥n Proyecciones</p>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Copyright Footer -->
    <footer class="text-center py-3 px-4 pb-32 md:pb-8 text-gray-500 text-sm">
        <p>¬© Beleck Kintro</p>
    </footer>

    <!-- Floating Menu -->
    <div id="floating-menu" class="fixed right-4 z-40 transition-all" style="bottom: 105px;">
        <div class="flex flex-col space-y-3">
            <button onclick="togglePopup('manual')" id="manual-btn" class="float-bg-estructura w-12 h-12 md:w-14 md:h-14 rounded-full shadow-lg text-xl md:text-2xl transition-all hover:scale-110">
                üìñ
            </button>
        </div>
    </div>

    <!-- Popup Overlays -->
    <div id="popup-manual" class="fixed inset-0 z-50 hidden popup-overlay">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">üìñ Manual de Uso</h3>
                    <button onclick="togglePopup('manual')" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                <div class="flex flex-col space-y-4">
                    <div class="w-full">
                        <iframe class="w-full aspect-video rounded-lg" src="https://www.youtube.com/embed/--hRkglyZrQ?si=umSEABnjFo0J1ivH" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tax Add/Edit Popup -->
    <div id="popup-tax" class="fixed inset-0 z-50 hidden popup-overlay">
        <div class="flex items-center justify-center min-h-full p-4">
            <div id="tax-popup-content" class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="mb-6">
                    <h3 id="tax-popup-title" class="text-xl font-bold text-gray-800 text-center">üßæ Configuraci√≥n del impuesto</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del impuesto</label>
                        <input type="text" id="tax-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300" placeholder="Ej: IVA">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Porcentaje del impuesto</label>
                        <div class="relative">
                            <input type="number" id="tax-percentage" class="w-full px-4 py-3 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300" placeholder="12" min="0" max="100" step="0.01">
                            <div class="absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">%</div>
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button onclick="closeTaxPopup()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all">
                        Cancelar
                    </button>
                    <button id="tax-add-btn" onclick="addTax()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-lg transition-all">
                        Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fixed Cost Add/Edit Popup -->
    <div id="popup-fixed-cost" class="fixed inset-0 z-50 hidden popup-overlay">
        <div class="flex items-center justify-center min-h-full p-4">
            <div id="fixed-cost-popup-content" class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="mb-6">
                    <h3 id="fixed-cost-popup-title" class="text-xl font-bold text-gray-800 text-center">üìÜ Configuraci√≥n de costo fijo</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del costo</label>
                        <input type="text" id="fixed-cost-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300" placeholder="Ej: Alquiler">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Costo mensual</label>
                        <div class="relative">
                            <div id="fixed-cost-currency" class="absolute inset-y-0 left-0 flex items-center px-3 text-gray-500">Q</div>
                            <input type="number" id="fixed-cost-amount" class="w-full px-4 py-3 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300" placeholder="1500" min="0" step="0.01">
                        </div>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button onclick="closeFixedCostPopup()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all">
                        Cancelar
                    </button>
                    <button id="fixed-cost-add-btn" onclick="addFixedCost()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-lg transition-all">
                        Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Investment Add/Edit Popup -->
    <div id="popup-investment" class="fixed inset-0 z-50 hidden popup-overlay">
        <div class="flex items-center justify-center min-h-full p-4">
            <div id="investment-popup-content" class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="mb-6">
                    <h3 id="investment-popup-title" class="text-xl font-bold text-gray-800 text-center">üèóÔ∏è Edici√≥n de inversi√≥n inicial</h3>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nombre del costo</label>
                        <input type="text" id="edit-investment-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300" placeholder="Ej: Equipo de oficina">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor de la inversi√≥n</label>
                        <div class="relative">
                            <div id="edit-investment-value-currency" class="absolute inset-y-0 left-0 flex items-center px-3 text-gray-500">Q</div>
                            <input type="number" id="edit-investment-value" onchange="calculateEditCostPerHour()" class="w-full px-4 py-3 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300" placeholder="5000" min="0" step="0.01">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vida √∫til (a√±os)</label>
                        <input type="number" id="edit-investment-lifespan" onchange="calculateEditCostPerHour()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-300 focus:border-orange-300" placeholder="5" min="0" step="0.1">
                    </div>
                    <div class="bg-orange-200 border border-orange-300 rounded-lg p-3 text-center">
                        <div class="text-sm font-medium text-gray-700">Costo por hora</div>
                        <div id="edit-cost-per-hour" class="text-lg font-bold text-orange-800">Q 0.00</div>
                    </div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button onclick="closeInvestmentPopup()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all">
                        Cancelar
                    </button>
                    <button id="investment-save-btn" onclick="saveInvestment()" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-4 rounded-lg transition-all">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Project Add/Edit Popup -->
    <div id="popup-project" class="fixed inset-0 z-50 hidden popup-overlay">
        <div class="flex items-center justify-center min-h-full p-2 sm:p-4">
            <div id="project-popup-content" class="bg-white rounded-lg shadow-xl w-full max-w-[95vw] sm:max-w-4xl lg:max-w-5xl xl:max-w-6xl p-4 sm:p-6 max-h-[95vh] overflow-y-auto">
                <div class="mb-6">
                    <h3 id="project-popup-title" class="text-xl font-bold text-gray-800 text-center">Proyecto 1</h3>
                </div>
                
                <!-- Main Content -->
                <div class="space-y-6 mb-6">
                    <!-- Basic Project Info -->
                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" id="project-name-label">Nombre del proyecto</label>
                            <input type="text" id="project-name" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-300" placeholder="Ej: Dise√±o web">
                        </div>
                        <div id="hours-field" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Horas de duraci√≥n</label>
                            <input type="number" id="project-hours" onchange="calculateProjectCosts()" oninput="calculateProjectCosts()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-300" placeholder="40" min="0" step="0.5">
                        </div>
                    </div>

                    <!-- Equipment, Raw Materials and Variable Costs -->
                    <div id="project-cards-container" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Equipment Card -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex flex-col">
                            <h4 class="text-lg font-medium text-gray-700 mb-4 text-center">üèóÔ∏è Equipo a utilizar</h4>
                            <div id="equipment-checklist" class="space-y-2 flex-1 mb-4">
                                <!-- Equipment items will be added here -->
                            </div>
                            <div class="bg-blue-200 border border-blue-300 rounded-lg p-3 text-center mt-auto">
                                <div class="text-sm font-medium text-gray-700">Costo total por uso</div>
                                <div id="equipment-total-cost" class="text-lg font-bold text-blue-800">Q 0.00</div>
                            </div>
                        </div>

                        <!-- Variable Costs Card -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 flex flex-col">
                            <h4 class="text-lg font-medium text-gray-700 mb-4 text-center">üé≠ Costos variables</h4>
                            
                            <!-- Variable Costs Table -->
                            <div class="bg-blue-50 border border-blue-200 rounded-lg overflow-hidden mb-4 flex-1">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full w-full" id="variable-costs-table">
                                        <thead class="bg-blue-75">
                                            <tr>
                                                <th class="px-3 py-2 text-left text-sm font-medium text-gray-700 border-b border-blue-200">Nombre</th>
                                                <th class="px-3 py-2 text-center text-sm font-medium text-gray-700 border-b border-blue-200">Costo</th>
                                            </tr>
                                        </thead>
                                        <tbody id="variable-costs-table-body">
                                            <!-- Variable cost rows will be added here -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Add Row Button -->
                                <div class="bg-white border-t border-blue-200 p-3">
                                    <button onclick="addVariableCostRow()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg transition-all">
                                        + Agregar nueva fila
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Total Variable Costs -->
                            <div class="bg-blue-200 border border-blue-300 rounded-lg p-3 text-center mt-auto">
                                <div class="text-sm font-medium text-gray-700">Total de costos variables</div>
                                <div id="total-variable-costs" class="text-lg font-bold text-blue-800">Q 0.00</div>
                            </div>
                        </div>

                        <!-- Raw Materials Card (for products only) -->
                        <div id="raw-materials-card" class="bg-blue-50 border border-blue-200 rounded-lg p-4 hidden flex flex-col">
                            <h4 class="text-lg font-medium text-gray-700 mb-4 text-center">ü•ï Materia prima</h4>
                            <div id="raw-materials-checklist" class="space-y-2 flex-1 mb-4">
                                <!-- Raw materials items will be added here -->
                            </div>
                            <div class="bg-blue-200 border border-blue-300 rounded-lg p-3 text-center mt-auto">
                                <div class="text-sm font-medium text-gray-700">Costo total de materia prima</div>
                                <div id="raw-materials-total-cost" class="text-lg font-bold text-blue-800">Q 0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- Fixed Cost Per Hour and Equipment Hours -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-blue-200 border border-blue-300 rounded-lg p-4 text-center">
                            <div class="text-sm font-medium text-gray-700">Costo fijo total del proyecto</div>
                            <div id="fixed-cost-per-hour" class="text-xl font-bold text-blue-800">Q 0.00</div>
                        </div>
                        <div class="bg-blue-200 border border-blue-300 rounded-lg p-4 text-center">
                            <div class="text-sm font-medium text-gray-700">Total de horas</div>
                            <div id="total-equipment-hours" class="text-xl font-bold text-blue-800">0 hrs</div>
                        </div>
                    </div>

                    <!-- Cost Summary Cards -->
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Total Project Cost -->
                        <div class="bg-blue-100 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-3xl mb-2">üí∞</div>
                            <div class="text-sm font-medium text-gray-700 mb-1">Costo total del proyecto</div>
                            <div id="total-project-cost" class="text-lg font-bold text-blue-800">Q 0.00</div>
                        </div>
                        
                        <!-- Safety Margin -->
                        <div class="bg-blue-100 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-3xl mb-2">üõ°Ô∏è</div>
                            <div class="text-sm font-medium text-gray-700 mb-1">Margen de Seguridad del 30%</div>
                            <div id="safety-margin" class="text-lg font-bold text-blue-800">Q 0.00</div>
                        </div>
                        
                        <!-- Taxes -->
                        <div class="bg-blue-100 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-3xl mb-2">üßæ</div>
                            <div class="text-sm font-medium text-gray-700 mb-1">Impuestos a pagar <span id="tax-percentage-display">0%</span></div>
                            <div id="taxes-to-pay" class="text-lg font-bold text-blue-800">Q 0.00</div>
                        </div>
                        
                        <!-- Suggested Price -->
                        <div class="bg-blue-100 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-3xl mb-2">üíé</div>
                            <div class="text-sm font-medium text-gray-700 mb-1">Precio sugerido</div>
                            <div id="suggested-price" class="text-lg font-bold text-blue-800">Q 0.00</div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Descripci√≥n</label>
                    
                    <!-- Text Editor Toolbar -->
                    <div class="border border-gray-300 rounded-t-lg bg-gray-50 p-2 flex flex-wrap gap-1">
                        <button type="button" onclick="formatText('bold')" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Negrita">
                            <strong>B</strong>
                        </button>
                        <button type="button" onclick="formatText('italic')" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Cursiva">
                            <em>I</em>
                        </button>
                        <button type="button" onclick="formatText('underline')" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Subrayado">
                            <u>U</u>
                        </button>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <button type="button" onclick="formatText('insertUnorderedList')" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Lista con vi√±etas">
                            ‚Ä¢ Lista
                        </button>
                        <button type="button" onclick="formatText('insertOrderedList')" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Lista numerada">
                            1. Lista
                        </button>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <button type="button" onclick="formatText('justifyLeft')" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Alinear izquierda">
                            ‚¨Ö
                        </button>
                        <button type="button" onclick="formatText('justifyCenter')" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Centrar">
                            ‚Üî
                        </button>
                        <button type="button" onclick="formatText('justifyRight')" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Alinear derecha">
                            ‚û°
                        </button>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <select onchange="formatText('fontSize', this.value)" class="px-2 py-1 text-sm bg-white border border-gray-200 rounded hover:bg-gray-100 transition-all" title="Tama√±o de fuente">
                            <option value="">Tama√±o</option>
                            <option value="1">Muy peque√±o</option>
                            <option value="2">Peque√±o</option>
                            <option value="3">Normal</option>
                            <option value="4">Grande</option>
                            <option value="5">Muy grande</option>
                        </select>
                        <input type="color" onchange="formatText('foreColor', this.value)" class="w-8 h-6 border border-gray-200 rounded cursor-pointer" title="Color de texto">
                    </div>
                    
                    <!-- Rich Text Editor -->
                    <div id="project-description" contenteditable="true" class="w-full min-h-[120px] px-4 py-3 border border-gray-300 border-t-0 rounded-b-lg focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-300 bg-white" style="max-height: 300px; overflow-y: auto;" data-placeholder="Describe los detalles del proyecto, entregables, metodolog√≠a, etc.">
                    </div>
                    
                    <!-- Hidden textarea for form compatibility -->
                    <textarea id="project-description-hidden" class="hidden"></textarea>
                </div>

                <!-- Action Buttons -->
                <div class="flex space-x-3">
                    <button onclick="closeProjectPopup()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all">
                        Cancelar
                    </button>
                    <button id="project-action-btn" onclick="saveProject()" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-all">
                        Agregar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Project Confirmation Popup -->
    <div id="popup-delete-project" class="fixed inset-0 z-50 hidden popup-overlay">
        <div class="flex items-center justify-center min-h-full p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                <div class="text-center mb-6">
                    <div class="text-6xl mb-4">‚ö†Ô∏è</div>
                    <h3 class="text-xl font-bold text-gray-800 mb-2">¬øDeseas eliminar este proyecto?</h3>
                    <p class="text-gray-600">Todos los c√°lculos relacionados desaparecer√°n</p>
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeDeleteProjectPopup()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-medium py-3 px-4 rounded-lg transition-all">
                        Cancelar
                    </button>
                    <button id="confirm-delete-project" onclick="confirmDeleteProject()" class="flex-1 bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-4 rounded-lg transition-all">
                        S√≠, eliminar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSection = 'estructura';
        let taxes = [];
        let editingTaxId = null;
        let fixedCosts = [];
        let editingFixedCostId = null;
        let investments = [];
        let editingInvestmentId = null;
        let projects = [];
        let editingProjectId = null;
        let deletingProjectId = null;
        let currentProjectVariableCosts = [];
        let currentProjectType = 'service'; // 'service' or 'product'
        let currentProjectRawMaterials = [];
        let currentProjectEquipment = [];

        // Unified data management system
        const appData = {
            currency: 'GTQ',
            businessYears: '',
            taxes: [],
            fixedCosts: [],
            investments: [],
            rawMaterials: [],
            projects: [],
            honorarios: {
                dailyHours: '',
                projectHours: '',
                hourlyRate: ''
            },
            quotation: {
                title: '',
                date: '',
                validity: '',
                comments: '',
                pricingStrategy: 'regular',
                customPercentage: 30,
                items: []
            }
        };

        // Load all data from localStorage
        function loadAllData() {
            const savedData = localStorage.getItem('calculadora-data');
            if (savedData) {
                const data = JSON.parse(savedData);
                appData.currency = data.currency || 'GTQ';
                appData.businessYears = data.businessYears || '';
                appData.taxes = data.taxes || [];
                appData.fixedCosts = data.fixedCosts || [];
                appData.investments = data.investments || [];
                appData.rawMaterials = data.rawMaterials || [];
                appData.projects = data.projects || [];
                appData.honorarios = data.honorarios || {
                    dailyHours: '',
                    projectHours: '',
                    hourlyRate: ''
                };
                appData.quotation = data.quotation || {
                    title: '',
                    date: '',
                    validity: '',
                    comments: '',
                    pricingStrategy: 'regular',
                    customPercentage: 30,
                    items: []
                };
                
                taxes = appData.taxes; // Keep backward compatibility
                fixedCosts = appData.fixedCosts;
                investments = appData.investments;
                rawMaterials = appData.rawMaterials;
                projects = appData.projects;
                
                // Update UI elements
                const currencySelect = document.getElementById('currency-select');
                const businessYearsInput = document.getElementById('business-years');
                const dailyHoursInput = document.getElementById('daily-hours');
                const hourlyRateInput = document.getElementById('hourly-rate');
                
                currencySelect.value = appData.currency;
                businessYearsInput.value = appData.businessYears;
                dailyHoursInput.value = appData.honorarios.dailyHours;
                hourlyRateInput.value = appData.honorarios.hourlyRate;
                
                renderTaxes();
                renderFixedCosts();
                renderInvestments();
                renderRawMaterials();
                renderProjects();
                updateCurrencySymbols();
                calculateHonorarios();
                loadQuotationData();
            }
        }

        // Save all data to localStorage (unified auto-save)
        function saveAllData() {
            const currencySelect = document.getElementById('currency-select');
            const businessYearsInput = document.getElementById('business-years');
            const dailyHoursInput = document.getElementById('daily-hours');
            const hourlyRateInput = document.getElementById('hourly-rate');
            
            appData.currency = currencySelect.value;
            appData.businessYears = businessYearsInput.value;
            appData.taxes = taxes;
            appData.fixedCosts = fixedCosts;
            appData.investments = investments;
            appData.rawMaterials = rawMaterials;
            appData.projects = projects;
            appData.honorarios = {
                dailyHours: dailyHoursInput.value,
                hourlyRate: hourlyRateInput.value
            };
            
            // Save quotation data
            const quoteTitle = document.getElementById('quote-title');
            const quoteDate = document.getElementById('quote-date');
            const quoteValidity = document.getElementById('quote-validity');
            const quoteComments = document.getElementById('quote-comments');
            const customPercentage = document.getElementById('custom-percentage');
            
            if (quoteTitle) appData.quotation.title = quoteTitle.value;
            if (quoteDate) appData.quotation.date = quoteDate.value;
            if (quoteValidity) appData.quotation.validity = quoteValidity.value;
            if (quoteComments) appData.quotation.comments = quoteComments.innerHTML;
            if (customPercentage) appData.quotation.customPercentage = parseFloat(customPercentage.value) || 30;
            
            localStorage.setItem('calculadora-data', JSON.stringify(appData));
        }

        // Individual save functions (now use unified system)
        function saveCurrency() {
            updateCurrencySymbols();
            updateTotalFixedCosts();
            saveAllData();
        }

        function saveBusinessYears() {
            saveAllData();
        }

        function saveTaxes() {
            saveAllData();
        }

        function saveFixedCosts() {
            saveAllData();
        }

        function saveInvestments() {
            saveAllData();
        }

        function saveRawMaterials() {
            saveAllData();
        }

        // Update currency symbols throughout the interface
        function updateCurrencySymbols() {
            const currencySelect = document.getElementById('currency-select');
            const currency = currencySelect.value;
            let symbol = 'Q';
            
            switch(currency) {
                case 'USD':
                    symbol = '$';
                    break;
                case 'EUR':
                    symbol = '‚Ç¨';
                    break;
                case 'GTQ':
                default:
                    symbol = 'Q';
                    break;
            }
            
            // Update all currency symbols
            const fixedCostCurrency = document.getElementById('fixed-cost-currency');
            const hourlyRateCurrency = document.getElementById('hourly-rate-currency');
            const editInvestmentValueCurrency = document.getElementById('edit-investment-value-currency');
            
            if (fixedCostCurrency) fixedCostCurrency.textContent = symbol;
            if (hourlyRateCurrency) hourlyRateCurrency.textContent = symbol;
            if (editInvestmentValueCurrency) editInvestmentValueCurrency.textContent = symbol;
            
            // Re-render all lists to update currency symbols
            renderFixedCosts();
            renderInvestments();
        }

        // Get business years with default value of 1
        function getBusinessYears() {
            const businessYearsInput = document.getElementById('business-years');
            const value = businessYearsInput.value;
            return value && value.trim() !== '' ? parseInt(value) : 1;
        }

        // Generate unique ID for taxes
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Fixed Cost management functions
        function addFixedCostRow() {
            const newFixedCost = {
                id: generateId(),
                name: '',
                amount: 0,
                isHonorarios: false
            };

            fixedCosts.push(newFixedCost);
            renderFixedCosts();
            
            // Focus on the name input of the new row
            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-row-id="${newFixedCost.id}"]`);
                if (newRow) {
                    const nameInput = newRow.querySelector('.fixed-cost-name');
                    nameInput.focus();
                }
            }, 100);
        }

        function updateFixedCostFromRow(rowId, field, value) {
            const fixedCost = fixedCosts.find(fc => fc.id === rowId);
            if (!fixedCost) return;
            
            if (field === 'name') {
                fixedCost.name = value.trim();
            } else if (field === 'amount') {
                fixedCost.amount = parseFloat(value) || 0;
            }
            
            // Check if all fields are empty and delete the row if so (except honorarios)
            if (!fixedCost.isHonorarios && !fixedCost.name && fixedCost.amount === 0) {
                fixedCosts = fixedCosts.filter(fc => fc.id !== rowId);
                renderFixedCosts();
                saveFixedCosts();
                return;
            }
            
            saveFixedCosts();
            updateTotalFixedCosts();
            
            // Update project calculations if popup is open
            if (!document.getElementById('popup-project').classList.contains('hidden')) {
                calculateFixedCostPerHour();
                calculateProjectCosts();
            }
        }

        function deleteFixedCost(fixedCostId) {
            fixedCosts = fixedCosts.filter(fc => fc.id !== fixedCostId);
            saveFixedCosts();
            renderFixedCosts();
        }

        function renderFixedCosts() {
            const tbody = document.getElementById('fixed-costs-table-body');
            tbody.innerHTML = '';

            const currencySymbol = getCurrencySymbol();
            
            fixedCosts.forEach((fixedCost, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-orange-25';
                row.setAttribute('data-row-id', fixedCost.id);
                
                if (fixedCost.isHonorarios) {
                    // Special styling for honorarios (non-editable)
                    row.innerHTML = `
                        <td class="px-3 py-2 border-b border-orange-100">
                            <div class="flex items-center">
                                <span class="text-blue-600 text-lg mr-2">‚åö</span>
                                <span class="text-sm font-medium text-gray-700">${fixedCost.name}</span>
                            </div>
                        </td>
                        <td class="px-3 py-2 border-b border-orange-100 text-center">
                            <div class="text-sm font-medium text-gray-700">${currencySymbol} ${fixedCost.amount.toFixed(2)}</div>
                        </td>
                    `;
                } else {
                    // Regular fixed cost (editable)
                    row.innerHTML = `
                        <td class="px-3 py-2 border-b border-orange-100">
                            <input type="text" 
                                   class="fixed-cost-name w-full px-2 py-1 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-left" 
                                   value="${fixedCost.name}" 
                                   placeholder="Nombre del costo"
                                   onchange="updateFixedCostFromRow('${fixedCost.id}', 'name', this.value)"
                                   onblur="updateFixedCostFromRow('${fixedCost.id}', 'name', this.value)"
                                   oninput="updateFixedCostFromRow('${fixedCost.id}', 'name', this.value)">
                        </td>
                        <td class="px-3 py-2 border-b border-orange-100 text-center">
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center px-1 text-xs text-gray-500">${currencySymbol}</div>
                                <input type="number" 
                                       class="fixed-cost-amount w-full px-2 py-1 pl-6 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-center" 
                                       value="${fixedCost.amount || ''}" 
                                       placeholder="0"
                                       min="0" 
                                       step="0.01"
                                       onchange="updateFixedCostFromRow('${fixedCost.id}', 'amount', this.value)"
                                       onblur="updateFixedCostFromRow('${fixedCost.id}', 'amount', this.value)"
                                       oninput="updateFixedCostFromRow('${fixedCost.id}', 'amount', this.value)">
                            </div>
                        </td>
                    `;
                }
                tbody.appendChild(row);
            });

            updateTotalFixedCosts();
        }

        function updateTotalFixedCosts() {
            const totalAmount = fixedCosts.reduce((sum, fixedCost) => sum + fixedCost.amount, 0);
            const totalElement = document.getElementById('total-fixed-amount');
            const currencySymbol = getCurrencySymbol();
            totalElement.textContent = `${currencySymbol} ${totalAmount.toFixed(2)}`;
            
            // Update fixed cost per hour in project popup if it's open
            calculateFixedCostPerHour();
        }

        function getCurrencySymbol() {
            const currencySelect = document.getElementById('currency-select');
            const currency = currencySelect.value;
            
            switch(currency) {
                case 'USD':
                    return '$';
                case 'EUR':
                    return '‚Ç¨';
                case 'GTQ':
                default:
                    return 'Q';
            }
        }

        // Honorarios calculation
        function calculateHonorarios() {
            const dailyHours = parseFloat(document.getElementById('daily-hours').value) || 0;
            const hourlyRate = parseFloat(document.getElementById('hourly-rate').value) || 0;

            // Remove existing honorarios from fixedCosts
            fixedCosts = fixedCosts.filter(fc => !fc.isHonorarios);

            // Calculate and add honorarios if both fields are filled
            if (dailyHours > 0 && hourlyRate > 0) {
                // Assuming 22 working days per month as default
                const monthlyDays = 22;
                const monthlyHours = dailyHours * monthlyDays;
                const monthlyHonorarios = hourlyRate * monthlyHours;

                const honorariosFixedCost = {
                    id: 'honorarios-auto',
                    name: 'Honorarios',
                    amount: monthlyHonorarios,
                    isHonorarios: true
                };

                fixedCosts.push(honorariosFixedCost);
            }

            renderFixedCosts();
            updateTotalRawMaterials(); // Update raw materials when hourly rate changes
            saveAllData();
            
            // Update project calculations if popup is open
            if (!document.getElementById('popup-project').classList.contains('hidden')) {
                calculateProjectCosts();
            }
        }

        // Initialize raw materials array
        let rawMaterials = [];

        // Raw Materials management functions
        function addRawMaterialRow() {
            const newRawMaterial = {
                id: generateId(),
                description: '',
                cost: 0,
                quantity: 0,
                unit: 'U', // Default unit
                workHours: 0,
                unitCost: 0
            };

            rawMaterials.push(newRawMaterial);
            renderRawMaterials();
            
            // Focus on the description input of the new row
            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-raw-material-id="${newRawMaterial.id}"]`);
                if (newRow) {
                    const descriptionInput = newRow.querySelector('.raw-material-description');
                    descriptionInput.focus();
                }
            }, 100);
        }

        function updateRawMaterialFromRow(rowId, field, value) {
            const rawMaterial = rawMaterials.find(rm => rm.id === rowId);
            if (!rawMaterial) return;
            
            if (field === 'description') {
                rawMaterial.description = value.trim();
            } else if (field === 'cost') {
                rawMaterial.cost = parseFloat(value) || 0;
            } else if (field === 'quantity') {
                rawMaterial.quantity = parseFloat(value) || 0;
            } else if (field === 'unit') {
                rawMaterial.unit = value;
            } else if (field === 'workHours') {
                rawMaterial.workHours = parseFloat(value) || 0;
            }
            
            // Calculate unit cost: ((Work Hours * Hourly Rate) + Cost) / Quantity
            const hourlyRate = parseFloat(document.getElementById('hourly-rate').value) || 0;
            if (rawMaterial.quantity > 0) {
                rawMaterial.unitCost = ((rawMaterial.workHours * hourlyRate) + rawMaterial.cost) / rawMaterial.quantity;
            } else {
                rawMaterial.unitCost = 0;
            }
            
            // Check if all fields are empty and delete the row if so
            if (!rawMaterial.description && rawMaterial.cost === 0 && rawMaterial.quantity === 0 && rawMaterial.workHours === 0) {
                rawMaterials = rawMaterials.filter(rm => rm.id !== rowId);
                renderRawMaterials();
                saveRawMaterials();
                return;
            }
            
            // Update the unit cost display in the row
            const row = document.querySelector(`tr[data-raw-material-id="${rowId}"]`);
            if (row) {
                const unitCostCell = row.querySelector('.unit-cost-display');
                const currencySymbol = getCurrencySymbol();
                unitCostCell.textContent = `${currencySymbol} ${rawMaterial.unitCost.toFixed(2)}`;
            }
            
            saveRawMaterials();
            updateTotalRawMaterials();
        }

        function renderRawMaterials() {
            const tbody = document.getElementById('raw-materials-table-body');
            tbody.innerHTML = '';

            const currencySymbol = getCurrencySymbol();
            
            rawMaterials.forEach((rawMaterial, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-orange-25';
                row.setAttribute('data-raw-material-id', rawMaterial.id);
                
                row.innerHTML = `
                    <td class="px-3 py-2 border-b border-orange-100">
                        <input type="text" 
                               class="raw-material-description w-full px-2 py-1 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-left" 
                               value="${rawMaterial.description}" 
                               placeholder="Descripci√≥n"
                               onchange="updateRawMaterialFromRow('${rawMaterial.id}', 'description', this.value)"
                               onblur="updateRawMaterialFromRow('${rawMaterial.id}', 'description', this.value)"
                               oninput="updateRawMaterialFromRow('${rawMaterial.id}', 'description', this.value)">
                    </td>
                    <td class="px-3 py-2 border-b border-orange-100 text-center">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center px-1 text-xs text-gray-500">${currencySymbol}</div>
                            <input type="number" 
                                   class="raw-material-cost w-full px-2 py-1 pl-6 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-center" 
                                   value="${rawMaterial.cost || ''}" 
                                   placeholder="0"
                                   min="0" 
                                   step="0.01"
                                   onchange="updateRawMaterialFromRow('${rawMaterial.id}', 'cost', this.value)"
                                   onblur="updateRawMaterialFromRow('${rawMaterial.id}', 'cost', this.value)"
                                   oninput="updateRawMaterialFromRow('${rawMaterial.id}', 'cost', this.value)">
                        </div>
                    </td>
                    <td class="px-3 py-2 border-b border-orange-100 text-center">
                        <div class="flex items-center space-x-1">
                            <input type="number" 
                                   class="raw-material-quantity flex-1 px-2 py-1 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-center" 
                                   value="${rawMaterial.quantity || ''}" 
                                   placeholder="0"
                                   min="0" 
                                   step="0.01"
                                   onchange="updateRawMaterialFromRow('${rawMaterial.id}', 'quantity', this.value)"
                                   onblur="updateRawMaterialFromRow('${rawMaterial.id}', 'quantity', this.value)"
                                   oninput="updateRawMaterialFromRow('${rawMaterial.id}', 'quantity', this.value)">
                            <select class="raw-material-unit px-1 py-1 text-xs bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-center"
                                    onchange="updateRawMaterialFromRow('${rawMaterial.id}', 'unit', this.value)">
                                <option value="U" ${rawMaterial.unit === 'U' ? 'selected' : ''}>U</option>
                                <option value="Kg" ${rawMaterial.unit === 'Kg' ? 'selected' : ''}>Kg</option>
                                <option value="Lb" ${rawMaterial.unit === 'Lb' ? 'selected' : ''}>Lb</option>
                            </select>
                        </div>
                    </td>
                    <td class="px-3 py-2 border-b border-orange-100 text-center">
                        <input type="number" 
                               class="raw-material-work-hours w-full px-2 py-1 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-center" 
                               value="${rawMaterial.workHours || ''}" 
                               placeholder="0"
                               min="0" 
                               step="0.1"
                               onchange="updateRawMaterialFromRow('${rawMaterial.id}', 'workHours', this.value)"
                               onblur="updateRawMaterialFromRow('${rawMaterial.id}', 'workHours', this.value)"
                               oninput="updateRawMaterialFromRow('${rawMaterial.id}', 'workHours', this.value)">
                    </td>
                    <td class="px-3 py-2 border-b border-orange-100 text-center">
                        <div class="unit-cost-display text-sm font-medium text-gray-700">${currencySymbol} ${rawMaterial.unitCost.toFixed(2)}</div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateTotalRawMaterials();
        }

        function updateTotalRawMaterials() {
            const totalCost = rawMaterials.reduce((sum, rawMaterial) => {
                const hourlyRate = parseFloat(document.getElementById('hourly-rate').value) || 0;
                return sum + ((rawMaterial.workHours * hourlyRate) + rawMaterial.cost);
            }, 0);
            
            const totalElement = document.getElementById('total-raw-materials-amount');
            const currencySymbol = getCurrencySymbol();
            if (totalElement) {
                totalElement.textContent = `${currencySymbol} ${totalCost.toFixed(2)}`;
            }
        }

        function switchSection(section) {
            // Prevent unnecessary updates if already on the same section
            if (currentSection === section) {
                return;
            }
            
            // Hide all sections
            document.querySelectorAll('.section-content').forEach(el => el.classList.add('hidden'));
            
            // Show selected section
            document.getElementById(`section-${section}`).classList.remove('hidden');
            
            // Update body background
            document.body.className = `min-h-full transition-all section-bg-${section}`;
            
            // Update navigation container background
            const navContainer = document.getElementById('nav-container');
            const mobileNavContainer = document.getElementById('mobile-nav-container');
            navContainer.className = `nav-bg-${section} rounded-full p-2 transition-all`;
            mobileNavContainer.className = `nav-bg-${section} mx-4 mb-4 rounded-full p-2 transition-all`;
            
            // Update desktop navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.className = 'nav-btn rounded-full px-6 py-3 font-medium text-gray-700 transition-all';
                if (btn.dataset.section === section) {
                    btn.classList.add(`active-${section}`);
                }
            });
            
            // Update mobile navigation buttons - batch DOM updates
            const mobileButtons = document.querySelectorAll('.mobile-nav-btn');
            mobileButtons.forEach(btn => {
                const isActive = btn.dataset.section === section;
                const baseClasses = 'mobile-nav-btn rounded-full p-3 text-2xl transition-all flex-1 flex items-center justify-center';
                btn.className = isActive ? `${baseClasses} mobile-active` : baseClasses;
            });
            
            // Update floating menu buttons
            const manualBtn = document.getElementById('manual-btn');
            manualBtn.className = `float-bg-${section} w-12 h-12 md:w-14 md:h-14 rounded-full shadow-lg text-xl md:text-2xl transition-all hover:scale-110`;
            
            currentSection = section;
        }

        function togglePopup(type) {
            const popup = document.getElementById(`popup-${type}`);
            popup.classList.toggle('hidden');
        }

        // Tax management functions
        function openTaxPopup(taxId = null) {
            editingTaxId = taxId;
            const popup = document.getElementById('popup-tax');
            const title = document.getElementById('tax-popup-title');
            const addBtn = document.getElementById('tax-add-btn');
            const nameInput = document.getElementById('tax-name');
            const percentageInput = document.getElementById('tax-percentage');

            if (taxId) {
                // Editing existing tax
                const tax = taxes.find(t => t.id === taxId);
                title.textContent = 'üßæ Edici√≥n del impuesto';
                addBtn.textContent = 'Guardar';
                nameInput.value = tax.name;
                percentageInput.value = tax.percentage;
            } else {
                // Adding new tax
                title.textContent = 'üßæ Configuraci√≥n del impuesto';
                addBtn.textContent = 'Agregar';
                nameInput.value = '';
                percentageInput.value = '';
            }

            popup.classList.remove('hidden');
        }

        function closeTaxPopup() {
            const popup = document.getElementById('popup-tax');
            popup.classList.add('hidden');
            editingTaxId = null;
        }

        function addTax() {
            const nameInput = document.getElementById('tax-name');
            const percentageInput = document.getElementById('tax-percentage');
            
            const name = nameInput.value.trim();
            const percentage = parseFloat(percentageInput.value);

            // Validation
            if (!name || isNaN(percentage) || percentage < 0) {
                return; // Don't add if fields are empty or invalid
            }

            if (editingTaxId) {
                // Update existing tax
                const taxIndex = taxes.findIndex(t => t.id === editingTaxId);
                taxes[taxIndex] = {
                    ...taxes[taxIndex],
                    name: name,
                    percentage: percentage
                };
            } else {
                // Add new tax
                const newTax = {
                    id: generateId(),
                    name: name,
                    percentage: percentage
                };
                taxes.push(newTax);
            }

            saveTaxes();
            renderTaxes();
            closeTaxPopup();
        }

        function deleteTax(taxId) {
            taxes = taxes.filter(t => t.id !== taxId);
            saveTaxes();
            renderTaxes();
        }

        function renderTaxes() {
            const container = document.getElementById('impuestos-container');
            container.innerHTML = '';

            taxes.forEach(tax => {
                const taxElement = document.createElement('div');
                taxElement.className = 'bg-orange-50 border border-orange-200 rounded-lg p-3 flex justify-between items-center';
                taxElement.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-800">${tax.name}</div>
                        <div class="text-sm text-gray-600">${tax.percentage}%</div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="openTaxPopup('${tax.id}')" class="text-orange-600 hover:text-orange-800 text-lg transition-all">
                            ‚úèÔ∏è
                        </button>
                        <button onclick="deleteTax('${tax.id}')" class="text-red-600 hover:text-red-800 text-lg transition-all">
                            üóëÔ∏è
                        </button>
                    </div>
                `;
                container.appendChild(taxElement);
            });

            updateTotalTaxes();
        }

        function updateTotalTaxes() {
            const totalPercentage = taxes.reduce((sum, tax) => sum + tax.percentage, 0);
            const totalElement = document.getElementById('total-percentage');
            totalElement.textContent = `${totalPercentage.toFixed(2)}%`;
        }

        // Investment calculation functions
        function calculateRowCostPerHour(rowId) {
            const row = document.querySelector(`tr[data-row-id="${rowId}"]`);
            if (!row) return;
            
            const valueInput = row.querySelector('.investment-value');
            const lifespanInput = row.querySelector('.investment-lifespan');
            const costPerHourCell = row.querySelector('.cost-per-hour-display');
            
            const value = parseFloat(valueInput.value) || 0;
            const lifespan = parseFloat(lifespanInput.value) || 0;
            
            let costPerHour = 0;
            if (value > 0 && lifespan > 0) {
                costPerHour = value / lifespan / 365 / 8;
            }
            
            const currencySymbol = getCurrencySymbol();
            costPerHourCell.textContent = `${currencySymbol} ${costPerHour.toFixed(4)}`;
            
            // Update the investment in the array
            const investment = investments.find(inv => inv.id === rowId);
            if (investment) {
                investment.costPerHour = costPerHour;
                saveInvestments();
                updateTotalInvestments();
            }
        }

        function calculateEditCostPerHour() {
            const investmentValue = parseFloat(document.getElementById('edit-investment-value').value) || 0;
            const lifespan = parseFloat(document.getElementById('edit-investment-lifespan').value) || 0;
            
            let costPerHour = 0;
            if (investmentValue > 0 && lifespan > 0) {
                // Formula: Investment Value √∑ Lifespan √∑ 365 √∑ 8
                costPerHour = investmentValue / lifespan / 365 / 8;
            }
            
            const costPerHourElement = document.getElementById('edit-cost-per-hour');
            const currencySymbol = getCurrencySymbol();
            costPerHourElement.textContent = `${currencySymbol} ${costPerHour.toFixed(4)}`;
        }

        // Investment management functions
        function addInvestmentRow() {
            const newInvestment = {
                id: generateId(),
                name: '',
                value: 0,
                lifespan: 0,
                costPerHour: 0
            };

            investments.push(newInvestment);
            renderInvestments();
            
            // Focus on the name input of the new row
            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-row-id="${newInvestment.id}"]`);
                if (newRow) {
                    const nameInput = newRow.querySelector('.investment-name');
                    nameInput.focus();
                }
            }, 100);
        }

        function updateInvestmentFromRow(rowId, field, value) {
            const investment = investments.find(inv => inv.id === rowId);
            if (!investment) return;
            
            if (field === 'name') {
                investment.name = value.trim();
            } else if (field === 'value') {
                investment.value = parseFloat(value) || 0;
            } else if (field === 'lifespan') {
                investment.lifespan = parseFloat(value) || 0;
            }
            
            // Check if all fields are empty and delete the row if so
            if (!investment.name && investment.value === 0 && investment.lifespan === 0) {
                investments = investments.filter(inv => inv.id !== rowId);
                renderInvestments();
                saveInvestments();
                return;
            }
            
            // Recalculate cost per hour
            if (investment.value > 0 && investment.lifespan > 0) {
                investment.costPerHour = investment.value / investment.lifespan / 365 / 8;
            } else {
                investment.costPerHour = 0;
            }
            
            // Force immediate update of total investments
            setTimeout(() => {
                updateTotalInvestments();
                saveInvestments();
            }, 0);
            
            // Update project calculations if popup is open
            if (!document.getElementById('popup-project').classList.contains('hidden')) {
                renderEquipmentChecklist();
                calculateProjectCosts();
            }
        }

        function openInvestmentPopup(investmentId) {
            editingInvestmentId = investmentId;
            const popup = document.getElementById('popup-investment');
            const nameInput = document.getElementById('edit-investment-name');
            const valueInput = document.getElementById('edit-investment-value');
            const lifespanInput = document.getElementById('edit-investment-lifespan');

            updateCurrencySymbols(); // Update currency symbol in popup

            // Load existing investment data
            const investment = investments.find(inv => inv.id === investmentId);
            nameInput.value = investment.name;
            valueInput.value = investment.value;
            lifespanInput.value = investment.lifespan;
            
            calculateEditCostPerHour();
            popup.classList.remove('hidden');
        }

        function closeInvestmentPopup() {
            const popup = document.getElementById('popup-investment');
            popup.classList.add('hidden');
            editingInvestmentId = null;
        }

        function saveInvestment() {
            const nameInput = document.getElementById('edit-investment-name');
            const valueInput = document.getElementById('edit-investment-value');
            const lifespanInput = document.getElementById('edit-investment-lifespan');
            
            const name = nameInput.value.trim();
            const value = parseFloat(valueInput.value);
            const lifespan = parseFloat(lifespanInput.value);

            // Validation
            if (!name || isNaN(value) || value <= 0 || isNaN(lifespan) || lifespan <= 0) {
                return; // Don't save if fields are empty or invalid
            }

            // Calculate cost per hour
            const costPerHour = value / lifespan / 365 / 8;

            // Update existing investment
            const investmentIndex = investments.findIndex(inv => inv.id === editingInvestmentId);
            investments[investmentIndex] = {
                ...investments[investmentIndex],
                name: name,
                value: value,
                lifespan: lifespan,
                costPerHour: costPerHour
            };

            saveInvestments();
            renderInvestments();
            closeInvestmentPopup();
        }

        function deleteInvestment(investmentId) {
            investments = investments.filter(inv => inv.id !== investmentId);
            saveInvestments();
            renderInvestments();
        }

        function renderInvestments() {
            const tbody = document.getElementById('investments-table-body');
            tbody.innerHTML = '';

            const currencySymbol = getCurrencySymbol();
            
            investments.forEach((investment, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-orange-25';
                row.setAttribute('data-row-id', investment.id);
                
                row.innerHTML = `
                    <td class="px-3 py-2 border-b border-orange-100">
                        <input type="text" 
                               class="investment-name w-full px-2 py-1 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-left" 
                               value="${investment.name}" 
                               placeholder="Nombre del costo"
                               onchange="updateInvestmentFromRow('${investment.id}', 'name', this.value)"
                               onblur="updateInvestmentFromRow('${investment.id}', 'name', this.value)"
                               oninput="updateInvestmentFromRow('${investment.id}', 'name', this.value)">
                    </td>
                    <td class="px-3 py-2 border-b border-orange-100 text-center">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 flex items-center px-1 text-xs text-gray-500">${currencySymbol}</div>
                            <input type="number" 
                                   class="investment-value w-full px-2 py-1 pl-6 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-center" 
                                   value="${investment.value || ''}" 
                                   placeholder="0"
                                   min="0" 
                                   step="0.01"
                                   onchange="updateInvestmentFromRow('${investment.id}', 'value', this.value)"
                                   onblur="updateInvestmentFromRow('${investment.id}', 'value', this.value)"
                                   oninput="updateInvestmentFromRow('${investment.id}', 'value', this.value)">
                        </div>
                    </td>
                    <td class="px-3 py-2 border-b border-orange-100 text-center">
                        <input type="number" 
                               class="investment-lifespan w-full px-2 py-1 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-orange-300 focus:rounded text-center" 
                               value="${investment.lifespan || ''}" 
                               placeholder="0"
                               min="0" 
                               step="0.1"
                               onchange="updateInvestmentFromRow('${investment.id}', 'lifespan', this.value)"
                               onblur="updateInvestmentFromRow('${investment.id}', 'lifespan', this.value)"
                               oninput="updateInvestmentFromRow('${investment.id}', 'lifespan', this.value)">
                    </td>
                    <td class="px-3 py-2 border-b border-orange-100 text-center">
                        <div class="cost-per-hour-display text-sm font-medium text-gray-700">${currencySymbol} ${investment.costPerHour.toFixed(4)}</div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updateTotalInvestments();
        }

        function updateTotalInvestments() {
            const totalValue = investments.reduce((sum, investment) => sum + investment.value, 0);
            const totalElement = document.getElementById('total-investment-amount');
            const currencySymbol = getCurrencySymbol();
            if (totalElement) {
                totalElement.textContent = `${currencySymbol} ${totalValue.toFixed(2)}`;
            }
        }

        // Text formatting functions for rich text editor
        function formatText(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('project-description').focus();
        }

        // Get description content (HTML for rich text)
        function getDescriptionContent() {
            const editor = document.getElementById('project-description');
            return editor.innerHTML.trim();
        }

        // Set description content (HTML for rich text)
        function setDescriptionContent(content) {
            const editor = document.getElementById('project-description');
            editor.innerHTML = content || '';
        }

        // Show placeholder when editor is empty
        function updateDescriptionPlaceholder() {
            const editor = document.getElementById('project-description');
            const placeholder = editor.getAttribute('data-placeholder');
            
            if (editor.innerHTML.trim() === '' || editor.innerHTML === '<br>') {
                editor.innerHTML = '';
                editor.style.color = '#9CA3AF';
                editor.textContent = placeholder;
            }
        }

        // Handle focus and blur events for placeholder
        document.addEventListener('DOMContentLoaded', function() {
            const editor = document.getElementById('project-description');
            if (editor) {
                editor.addEventListener('focus', function() {
                    if (this.textContent === this.getAttribute('data-placeholder')) {
                        this.innerHTML = '';
                        this.style.color = '#000';
                    }
                });

                editor.addEventListener('blur', function() {
                    if (this.innerHTML.trim() === '' || this.innerHTML === '<br>') {
                        updateDescriptionPlaceholder();
                    } else {
                        this.style.color = '#000';
                    }
                });

                // Initialize placeholder
                updateDescriptionPlaceholder();
            }
        });

        // Project management functions
        function openProjectPopup(projectId = null) {
            // Check if projectId is actually the project type for new projects
            if (projectId === 'product') {
                currentProjectType = 'product';
                editingProjectId = null;
            } else if (typeof projectId === 'string' && projectId !== 'product') {
                // Editing existing project
                editingProjectId = projectId;
                const project = projects.find(p => p.id === projectId);
                currentProjectType = project.type || 'service';
            } else {
                // Adding new service (default)
                currentProjectType = 'service';
                editingProjectId = projectId;
            }

            const popup = document.getElementById('popup-project');
            const title = document.getElementById('project-popup-title');
            const actionBtn = document.getElementById('project-action-btn');
            const nameInput = document.getElementById('project-name');
            const hoursInput = document.getElementById('project-hours');
            const rawMaterialsCard = document.getElementById('raw-materials-card');
            const hoursField = document.getElementById('hours-field');
            const nameLabel = document.getElementById('project-name-label');

            // Show/hide fields based on project type
            const projectCardsContainer = document.getElementById('project-cards-container');
            if (currentProjectType === 'product') {
                rawMaterialsCard.classList.remove('hidden');
                hoursField.classList.add('hidden');
                nameLabel.textContent = 'Nombre del producto';
                // Set hours to 0 for products since they don't use hours
                hoursInput.value = '0';
                // Change to 3 columns for products
                projectCardsContainer.className = 'grid grid-cols-1 lg:grid-cols-3 gap-6';
            } else {
                rawMaterialsCard.classList.add('hidden');
                hoursField.classList.add('hidden'); // Always hide hours field for services too
                nameLabel.textContent = 'Nombre del servicio';
                // Set hours to 0 for services too since we're removing the field
                hoursInput.value = '0';
                // Keep 2 columns for services
                projectCardsContainer.className = 'grid grid-cols-1 lg:grid-cols-2 gap-6';
            }

            if (editingProjectId) {
                // Editing existing project
                const project = projects.find(p => p.id === editingProjectId);
                title.textContent = `${project.type === 'product' ? 'Producto' : 'Servicio'} ${projects.indexOf(project) + 1}`;
                actionBtn.textContent = 'Guardar';
                nameInput.value = project.name;
                hoursInput.value = project.hours;
                setDescriptionContent(project.description);
                currentProjectVariableCosts = [...project.variableCosts];
                currentProjectRawMaterials = [...(project.rawMaterials || [])];
                currentProjectEquipment = [...(project.equipment || [])];
            } else {
                // Adding new project
                const projectNumber = projects.length + 1;
                title.textContent = `${currentProjectType === 'product' ? 'Producto' : 'Servicio'} ${projectNumber}`;
                actionBtn.textContent = 'Agregar';
                nameInput.value = '';
                hoursInput.value = '';
                setDescriptionContent('');
                updateDescriptionPlaceholder();
                currentProjectVariableCosts = [];
                currentProjectRawMaterials = [];
                currentProjectEquipment = [];
            }

            renderEquipmentChecklist();
            renderRawMaterialsChecklist();
            renderVariableCosts();
            calculateFixedCostPerHour();
            calculateProjectCosts();
            popup.classList.remove('hidden');
        }

        function closeProjectPopup() {
            const popup = document.getElementById('popup-project');
            popup.classList.add('hidden');
            editingProjectId = null;
            currentProjectVariableCosts = [];
            currentProjectRawMaterials = [];
            currentProjectEquipment = [];
            currentProjectType = 'service';
        }

        function calculateFixedCostPerHour() {
            const totalFixedCosts = fixedCosts.reduce((sum, fc) => sum + fc.amount, 0);
            
            // Calculate total hours from equipment
            let totalHours = 0;
            currentProjectEquipment.forEach(projectEquipment => {
                totalHours += projectEquipment.hours;
            });
            
            // Formula: (Total de Costos Fijos √∑ 30 √∑ 8) √ó Total de horas
            const fixedCostPerHour = (totalFixedCosts / 30 / 8) * totalHours;
            
            const fixedCostElement = document.getElementById('fixed-cost-per-hour');
            const currencySymbol = getCurrencySymbol();
            if (fixedCostElement) {
                fixedCostElement.textContent = `${currencySymbol} ${fixedCostPerHour.toFixed(2)}`;
            }
            
            return fixedCostPerHour;
        }

        function renderEquipmentChecklist() {
            const container = document.getElementById('equipment-checklist');
            container.innerHTML = '';
            
            const currencySymbol = getCurrencySymbol();
            
            investments.forEach(investment => {
                if (investment.name && investment.costPerHour > 0) {
                    // Find current project equipment data
                    const projectEquipment = currentProjectEquipment.find(pe => pe.id === investment.id) || {
                        id: investment.id,
                        hours: 0
                    };
                    
                    const equipmentItem = document.createElement('div');
                    equipmentItem.className = 'bg-white border border-blue-200 rounded-lg p-3';
                    equipmentItem.innerHTML = `
                        <div class="flex items-center mb-2">
                            <input type="checkbox" 
                                   data-equipment-id="${investment.id}" 
                                   onchange="toggleEquipment('${investment.id}')" 
                                   ${projectEquipment.hours > 0 ? 'checked' : ''}
                                   class="mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">${investment.name}</span>
                        </div>
                        <div class="ml-7 space-y-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-600 w-16">Horas:</span>
                                <input type="number" 
                                       data-hours-input="${investment.id}"
                                       value="${projectEquipment.hours || ''}"
                                       min="0"
                                       step="0.1"
                                       placeholder="0"
                                       onchange="updateEquipmentHours('${investment.id}', this.value)"
                                       oninput="updateEquipmentHours('${investment.id}', this.value)"
                                       class="w-20 px-2 py-1 text-xs border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <span class="text-xs text-gray-600">hrs</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <div>Costo: ${currencySymbol} ${investment.costPerHour.toFixed(4)}/hora</div>
                                <div class="font-medium">Subtotal: <span data-subtotal="${investment.id}">${currencySymbol} ${(investment.costPerHour * projectEquipment.hours).toFixed(2)}</span></div>
                            </div>
                        </div>
                    `;
                    container.appendChild(equipmentItem);
                }
            });
            
            calculateEquipmentTotalCost();
        }

        function renderRawMaterialsChecklist() {
            const container = document.getElementById('raw-materials-checklist');
            container.innerHTML = '';
            
            const currencySymbol = getCurrencySymbol();
            
            rawMaterials.forEach(rawMaterial => {
                if (rawMaterial.description && rawMaterial.quantity > 0) {
                    const rawMaterialItem = document.createElement('div');
                    rawMaterialItem.className = 'bg-white border border-blue-200 rounded-lg p-3';
                    
                    // Find current project raw material data
                    const projectRawMaterial = currentProjectRawMaterials.find(prm => prm.id === rawMaterial.id) || {
                        id: rawMaterial.id,
                        quantity: 0
                    };
                    
                    rawMaterialItem.innerHTML = `
                        <div class="flex items-center mb-2">
                            <input type="checkbox" 
                                   data-raw-material-id="${rawMaterial.id}" 
                                   onchange="toggleRawMaterial('${rawMaterial.id}')" 
                                   ${projectRawMaterial.quantity > 0 ? 'checked' : ''}
                                   class="mr-3 w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                            <span class="text-sm font-medium text-gray-700">${rawMaterial.description}</span>
                        </div>
                        <div class="ml-7 space-y-2">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-600 w-16">Cantidad:</span>
                                <input type="number" 
                                       data-quantity-input="${rawMaterial.id}"
                                       value="${projectRawMaterial.quantity || ''}"
                                       max="${rawMaterial.quantity}"
                                       min="0"
                                       step="0.01"
                                       placeholder="0"
                                       onchange="updateRawMaterialQuantity('${rawMaterial.id}', this.value)"
                                       oninput="updateRawMaterialQuantity('${rawMaterial.id}', this.value)"
                                       class="w-20 px-2 py-1 text-xs border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <span class="text-xs text-gray-600">${rawMaterial.unit}</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-600">
                                <div>Disponible: ${rawMaterial.quantity} ${rawMaterial.unit}</div>
                                <div class="font-bold">Subtotal: <span data-raw-material-subtotal="${rawMaterial.id}">${currencySymbol} ${(rawMaterial.unitCost * projectRawMaterial.quantity).toFixed(2)}</span></div>
                            </div>
                        </div>
                    `;
                    container.appendChild(rawMaterialItem);
                }
            });
            
            calculateRawMaterialsTotalCost();
        }

        function toggleEquipment(equipmentId) {
            const checkbox = document.querySelector(`input[data-equipment-id="${equipmentId}"]`);
            const hoursInput = document.querySelector(`input[data-hours-input="${equipmentId}"]`);
            
            if (checkbox.checked) {
                // If checked, set minimum hours of 0.1 if empty
                if (!hoursInput.value || parseFloat(hoursInput.value) <= 0) {
                    hoursInput.value = '0.1';
                    updateEquipmentHours(equipmentId, '0.1');
                }
            } else {
                // If unchecked, set hours to 0
                hoursInput.value = '';
                updateEquipmentHours(equipmentId, '0');
            }
        }

        function updateEquipmentHours(equipmentId, value) {
            const hours = parseFloat(value) || 0;
            const investment = investments.find(inv => inv.id === equipmentId);
            
            if (!investment) return;
            
            // Update or add to current project equipment
            const existingIndex = currentProjectEquipment.findIndex(pe => pe.id === equipmentId);
            if (existingIndex >= 0) {
                if (hours > 0) {
                    currentProjectEquipment[existingIndex].hours = hours;
                } else {
                    currentProjectEquipment.splice(existingIndex, 1);
                }
            } else if (hours > 0) {
                currentProjectEquipment.push({
                    id: equipmentId,
                    hours: hours
                });
            }
            
            // Update checkbox state
            const checkbox = document.querySelector(`input[data-equipment-id="${equipmentId}"]`);
            checkbox.checked = hours > 0;
            
            // Update subtotal display
            const subtotalElement = document.querySelector(`span[data-subtotal="${equipmentId}"]`);
            const currencySymbol = getCurrencySymbol();
            const subtotal = investment.costPerHour * hours;
            subtotalElement.textContent = `${currencySymbol} ${subtotal.toFixed(2)}`;
            
            calculateEquipmentTotalCost();
            calculateProjectCosts();
        }

        function calculateEquipmentTotalCost() {
            let totalCost = 0;
            let totalHours = 0;
            
            currentProjectEquipment.forEach(projectEquipment => {
                const investment = investments.find(inv => inv.id === projectEquipment.id);
                if (investment) {
                    totalCost += investment.costPerHour * projectEquipment.hours;
                    totalHours += projectEquipment.hours;
                }
            });
            
            const totalElement = document.getElementById('equipment-total-cost');
            const totalHoursElement = document.getElementById('total-equipment-hours');
            const currencySymbol = getCurrencySymbol();
            totalElement.textContent = `${currencySymbol} ${totalCost.toFixed(2)}`;
            if (totalHoursElement) {
                totalHoursElement.textContent = `${totalHours.toFixed(1)} hrs`;
            }
            
            return totalCost;
        }

        function toggleRawMaterial(rawMaterialId) {
            const checkbox = document.querySelector(`input[data-raw-material-id="${rawMaterialId}"]`);
            const quantityInput = document.querySelector(`input[data-quantity-input="${rawMaterialId}"]`);
            
            if (checkbox.checked) {
                // If checked, set minimum quantity of 0.01 if empty
                if (!quantityInput.value || parseFloat(quantityInput.value) <= 0) {
                    quantityInput.value = '0.01';
                    updateRawMaterialQuantity(rawMaterialId, '0.01');
                }
            } else {
                // If unchecked, set quantity to 0
                quantityInput.value = '';
                updateRawMaterialQuantity(rawMaterialId, '0');
            }
        }

        function updateRawMaterialQuantity(rawMaterialId, value) {
            const quantity = parseFloat(value) || 0;
            const rawMaterial = rawMaterials.find(rm => rm.id === rawMaterialId);
            
            if (!rawMaterial) return;
            
            // Validate quantity doesn't exceed available
            const maxQuantity = rawMaterial.quantity;
            const validQuantity = Math.min(quantity, maxQuantity);
            
            // Update the input if it was corrected
            const quantityInput = document.querySelector(`input[data-quantity-input="${rawMaterialId}"]`);
            if (validQuantity !== quantity) {
                quantityInput.value = validQuantity;
            }
            
            // Update or add to current project raw materials
            const existingIndex = currentProjectRawMaterials.findIndex(prm => prm.id === rawMaterialId);
            if (existingIndex >= 0) {
                if (validQuantity > 0) {
                    currentProjectRawMaterials[existingIndex].quantity = validQuantity;
                } else {
                    currentProjectRawMaterials.splice(existingIndex, 1);
                }
            } else if (validQuantity > 0) {
                currentProjectRawMaterials.push({
                    id: rawMaterialId,
                    quantity: validQuantity
                });
            }
            
            // Update checkbox state
            const checkbox = document.querySelector(`input[data-raw-material-id="${rawMaterialId}"]`);
            checkbox.checked = validQuantity > 0;
            
            // Update subtotal display
            const subtotalElement = document.querySelector(`span[data-raw-material-subtotal="${rawMaterialId}"]`);
            const currencySymbol = getCurrencySymbol();
            const subtotal = rawMaterial.unitCost * validQuantity;
            if (subtotalElement) {
                subtotalElement.textContent = `${currencySymbol} ${subtotal.toFixed(2)}`;
            }
            
            calculateRawMaterialsTotalCost();
            calculateProjectCosts();
        }

        function calculateRawMaterialsTotalCost() {
            let totalCost = 0;
            
            currentProjectRawMaterials.forEach(projectRawMaterial => {
                const rawMaterial = rawMaterials.find(rm => rm.id === projectRawMaterial.id);
                if (rawMaterial) {
                    totalCost += rawMaterial.unitCost * projectRawMaterial.quantity;
                }
            });
            
            const totalElement = document.getElementById('raw-materials-total-cost');
            const currencySymbol = getCurrencySymbol();
            if (totalElement) {
                totalElement.textContent = `${currencySymbol} ${totalCost.toFixed(2)}`;
            }
            
            return totalCost;
        }

        function addVariableCostRow() {
            const newVariableCost = {
                id: generateId(),
                name: '',
                amount: 0
            };

            currentProjectVariableCosts.push(newVariableCost);
            renderVariableCosts();
            
            // Focus on the name input of the new row
            setTimeout(() => {
                const newRow = document.querySelector(`tr[data-variable-cost-id="${newVariableCost.id}"]`);
                if (newRow) {
                    const nameInput = newRow.querySelector('.variable-cost-name');
                    nameInput.focus();
                }
            }, 100);
        }

        function updateVariableCostFromRow(rowId, field, value) {
            const variableCost = currentProjectVariableCosts.find(vc => vc.id === rowId);
            if (!variableCost) return;
            
            if (field === 'name') {
                variableCost.name = value.trim();
            } else if (field === 'amount') {
                variableCost.amount = parseFloat(value) || 0;
            }
            
            // Check if all fields are empty and delete the row if so
            if (!variableCost.name && variableCost.amount === 0) {
                currentProjectVariableCosts = currentProjectVariableCosts.filter(vc => vc.id !== rowId);
                renderVariableCosts();
                return;
            }
            
            calculateProjectCosts();
        }

        function renderVariableCosts() {
            const tbody = document.getElementById('variable-costs-table-body');
            tbody.innerHTML = '';

            const currencySymbol = getCurrencySymbol();
            
            currentProjectVariableCosts.forEach((variableCost, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-blue-25';
                row.setAttribute('data-variable-cost-id', variableCost.id);
                
                row.innerHTML = `
                    <td class="px-3 py-2 border-b border-blue-100">
                        <input type="text" 
                               class="variable-cost-name w-full px-2 py-1 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-blue-300 focus:rounded text-left" 
                               value="${variableCost.name}" 
                               placeholder="Nombre del costo"
                               onchange="updateVariableCostFromRow('${variableCost.id}', 'name', this.value)"
                               onblur="updateVariableCostFromRow('${variableCost.id}', 'name', this.value)"
                               oninput="updateVariableCostFromRow('${variableCost.id}', 'name', this.value)">
                    </td>
                    <td class="px-3 py-2 border-b border-blue-100 text-center">
                        <div class="relative">
                            <div class="absolute inset-y-0 flex items-center px-1 text-xs text-gray-500">${currencySymbol}</div>
                            <input type="number" 
                                   class="variable-cost-amount w-full px-2 py-1 pl-6 text-sm bg-transparent border-0 focus:outline-none focus:bg-white focus:border focus:border-blue-300 focus:rounded text-center" 
                                   value="${variableCost.amount || ''}" 
                                   placeholder="0"
                                   min="0" 
                                   step="0.01"
                                   onchange="updateVariableCostFromRow('${variableCost.id}', 'amount', this.value)"
                                   onblur="updateVariableCostFromRow('${variableCost.id}', 'amount', this.value)"
                                   oninput="updateVariableCostFromRow('${variableCost.id}', 'amount', this.value)">
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });

            calculateProjectCosts();
        }

        function calculateProjectCosts() {
            const currencySymbol = getCurrencySymbol();
            const projectHours = parseFloat(document.getElementById('project-hours').value) || 0;
            
            // Calculate components
            const fixedCostTotal = calculateFixedCostPerHour(); // This now returns the total fixed cost for the project
            const equipmentTotalCost = calculateEquipmentTotalCost();
            const totalVariableCosts = currentProjectVariableCosts.reduce((sum, vc) => sum + vc.amount, 0);
            const totalRawMaterialsCost = calculateRawMaterialsTotalCost();
            
            // Calculate total project cost (fixed cost is now total, not per hour)
            const totalProjectCost = fixedCostTotal + equipmentTotalCost + totalVariableCosts + totalRawMaterialsCost;
            
            // Calculate safety margin (30%)
            const safetyMargin = totalProjectCost * 0.30;
            
            // Calculate taxes
            const totalTaxPercentage = taxes.reduce((sum, tax) => sum + tax.percentage, 0) / 100;
            const taxesToPay = (totalProjectCost + safetyMargin) * totalTaxPercentage;
            
            // Calculate suggested price
            const suggestedPrice = totalProjectCost + safetyMargin + taxesToPay;
            
            // Update UI
            document.getElementById('total-variable-costs').textContent = `${currencySymbol} ${totalVariableCosts.toFixed(2)}`;
            document.getElementById('total-project-cost').textContent = `${currencySymbol} ${totalProjectCost.toFixed(2)}`;
            document.getElementById('safety-margin').textContent = `${currencySymbol} ${safetyMargin.toFixed(2)}`;
            document.getElementById('taxes-to-pay').textContent = `${currencySymbol} ${taxesToPay.toFixed(2)}`;
            document.getElementById('suggested-price').textContent = `${currencySymbol} ${suggestedPrice.toFixed(2)}`;
            document.getElementById('tax-percentage-display').textContent = `${(totalTaxPercentage * 100).toFixed(1)}%`;
        }

        function saveProject() {
            const nameInput = document.getElementById('project-name');
            const hoursInput = document.getElementById('project-hours');
            
            const name = nameInput.value.trim();
            const hours = parseFloat(hoursInput.value) || 0;
            const description = getDescriptionContent();

            // Validation - only check name since hours are always 0 now
            if (!name) {
                return; // Don't save if name is empty
            }

            // Get selected equipment
            const selectedEquipment = [];
            const checkboxes = document.querySelectorAll('#equipment-checklist input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                selectedEquipment.push(checkbox.getAttribute('data-equipment-id'));
            });

            // Calculate final values
            const currencySymbol = getCurrencySymbol();
            const fixedCostTotal = calculateFixedCostPerHour(); // This now returns the total fixed cost for the project
            const equipmentTotalCost = calculateEquipmentTotalCost();
            const totalVariableCosts = currentProjectVariableCosts.reduce((sum, vc) => sum + vc.amount, 0);
            const totalRawMaterialsCost = calculateRawMaterialsTotalCost();
            const totalProjectCost = fixedCostTotal + equipmentTotalCost + totalVariableCosts + totalRawMaterialsCost;
            const safetyMargin = totalProjectCost * 0.30;
            const totalTaxPercentage = taxes.reduce((sum, tax) => sum + tax.percentage, 0) / 100;
            const taxesToPay = (totalProjectCost + safetyMargin) * totalTaxPercentage;
            const suggestedPrice = totalProjectCost + safetyMargin + taxesToPay;

            if (editingProjectId) {
                // Update existing project
                const projectIndex = projects.findIndex(p => p.id === editingProjectId);
                projects[projectIndex] = {
                    ...projects[projectIndex],
                    name: name,
                    type: currentProjectType,
                    hours: hours,
                    description: description,
                    selectedEquipment: selectedEquipment,
                    equipment: [...currentProjectEquipment],
                    variableCosts: [...currentProjectVariableCosts],
                    rawMaterials: [...currentProjectRawMaterials],
                    calculations: {
                        fixedCostTotal,
                        equipmentTotalCost,
                        totalVariableCosts,
                        totalRawMaterialsCost,
                        totalProjectCost,
                        safetyMargin,
                        taxesToPay,
                        suggestedPrice
                    }
                };
            } else {
                // Add new project
                const newProject = {
                    id: generateId(),
                    name: name,
                    type: currentProjectType,
                    hours: hours,
                    description: description,
                    selectedEquipment: selectedEquipment,
                    equipment: [...currentProjectEquipment],
                    variableCosts: [...currentProjectVariableCosts],
                    rawMaterials: [...currentProjectRawMaterials],
                    calculations: {
                        fixedCostTotal,
                        equipmentTotalCost,
                        totalVariableCosts,
                        totalRawMaterialsCost,
                        totalProjectCost,
                        safetyMargin,
                        taxesToPay,
                        suggestedPrice
                    }
                };
                projects.push(newProject);
            }

            saveAllData();
            renderProjects();
            closeProjectPopup();
        }

        function renderProjects() {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '';

            const currencySymbol = getCurrencySymbol();
            
            // Define colors for different projects
            const projectColors = [
                'bg-blue-100 border-blue-200',
                'bg-green-100 border-green-200',
                'bg-purple-100 border-purple-200',
                'bg-yellow-100 border-yellow-200',
                'bg-pink-100 border-pink-200',
                'bg-indigo-100 border-indigo-200'
            ];

            projects.forEach((project, index) => {
                const colorClass = projectColors[index % projectColors.length];
                const projectCard = document.createElement('div');
                projectCard.className = `${colorClass} border rounded-lg p-4`;
                
                // Add type indicator
                const typeIcon = project.type === 'product' ? 'üì¶' : 'üõ†Ô∏è';
                const typeLabel = project.type === 'product' ? 'Producto' : 'Servicio';
                
                projectCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="flex items-center mb-1">
                                <span class="text-lg mr-2">${typeIcon}</span>
                                <span class="text-xs font-medium text-gray-600 bg-white px-2 py-1 rounded-full">${typeLabel}</span>
                            </div>
                            <h4 class="text-lg font-medium text-gray-800">${project.name}</h4>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="openProjectPopup('${project.id}')" class="text-blue-600 hover:text-blue-800 text-lg transition-all">
                                ‚úèÔ∏è
                            </button>
                            <button onclick="openDeleteProjectPopup('${project.id}')" class="text-red-600 hover:text-red-800 text-lg transition-all">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-gray-800 mb-1">${currencySymbol} ${project.calculations.suggestedPrice.toFixed(2)}</div>
                    <div class="text-sm text-gray-600">${project.hours} horas ‚Ä¢ ${project.description.replace(/<[^>]*>/g, '').substring(0, 50)}${project.description.replace(/<[^>]*>/g, '').length > 50 ? '...' : ''}</div>
                `;
                grid.appendChild(projectCard);
            });
        }

        function openDeleteProjectPopup(projectId) {
            deletingProjectId = projectId;
            const popup = document.getElementById('popup-delete-project');
            popup.classList.remove('hidden');
        }

        function closeDeleteProjectPopup() {
            const popup = document.getElementById('popup-delete-project');
            popup.classList.add('hidden');
            deletingProjectId = null;
        }

        function confirmDeleteProject() {
            if (deletingProjectId) {
                projects = projects.filter(p => p.id !== deletingProjectId);
                saveAllData();
                renderProjects();
                closeDeleteProjectPopup();
            }
        }

        // Close popups when clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('popup-overlay')) {
                e.target.classList.add('hidden');
                if (e.target.id === 'popup-tax') {
                    editingTaxId = null;
                } else if (e.target.id === 'popup-fixed-cost') {
                    editingFixedCostId = null;
                } else if (e.target.id === 'popup-investment') {
                    editingInvestmentId = null;
                } else if (e.target.id === 'popup-project') {
                    editingProjectId = null;
                    currentProjectVariableCosts = [];
                    currentProjectRawMaterials = [];
                    currentProjectEquipment = [];
                    currentProjectType = 'service';
                } else if (e.target.id === 'popup-delete-project') {
                    deletingProjectId = null;
                }
            }
        });

        // Set floating menu position consistently
        function adjustFloatingMenu() {
            const floatingMenu = document.getElementById('floating-menu');
            // On mobile (below md breakpoint), position above mobile nav
            // On desktop (md and above), position at bottom right corner
            if (window.innerWidth >= 768) {
                floatingMenu.style.bottom = '32px';
                floatingMenu.style.right = '32px';
            } else {
                floatingMenu.style.bottom = '105px';
                floatingMenu.style.right = '16px';
            }
        }

        window.addEventListener('resize', adjustFloatingMenu);
        adjustFloatingMenu();

        // Handle desktop navigation spacing on scroll
        let lastScrollTop = 0;
        window.addEventListener('scroll', function() {
            const desktopNav = document.getElementById('desktop-nav');
            const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
            
            if (scrollTop > 50) {
                // Add top margin when scrolled down to separate from screen edge
                desktopNav.style.top = '16px';
            } else {
                // Remove top margin when at top
                desktopNav.style.top = '0px';
            }
            
            lastScrollTop = scrollTop;
        });

        // Quotation management functions
        let selectedPricingStrategy = 'regular';
        let currentPricingPercentage = 30;

        function loadQuotationData() {
            const quoteTitle = document.getElementById('quote-title');
            const quoteDate = document.getElementById('quote-date');
            const quoteValidity = document.getElementById('quote-validity');
            const quoteComments = document.getElementById('quote-comments');
            const customPercentage = document.getElementById('custom-percentage');
            
            if (quoteTitle) quoteTitle.value = appData.quotation.title;
            if (quoteDate) quoteDate.value = appData.quotation.date || new Date().toISOString().split('T')[0];
            if (quoteValidity) quoteValidity.value = appData.quotation.validity;
            if (quoteComments) quoteComments.innerHTML = appData.quotation.comments;
            if (customPercentage) customPercentage.value = appData.quotation.customPercentage;
            
            selectedPricingStrategy = appData.quotation.pricingStrategy || 'regular';
            currentPricingPercentage = getPricingPercentage(selectedPricingStrategy);
            
            // Update pricing strategy buttons
            updatePricingStrategyButtons();
            updateQuoteDisplay();
            renderQuoteTable();
        }

        function selectPricingStrategy(strategy, percentage) {
            selectedPricingStrategy = strategy;
            currentPricingPercentage = parseFloat(percentage) || 0;
            
            appData.quotation.pricingStrategy = strategy;
            if (strategy === 'custom') {
                appData.quotation.customPercentage = currentPricingPercentage;
            }
            
            updatePricingStrategyButtons();
            renderQuoteTable();
            saveAllData();
        }

        function updatePricingStrategyButtons() {
            // Reset all buttons
            document.querySelectorAll('.pricing-strategy-btn').forEach(btn => {
                btn.classList.remove('bg-lime-200', 'border-lime-400', 'shadow-lg');
                btn.classList.add('bg-white', 'border-lime-200');
            });
            
            // Highlight selected button
            const selectedBtn = document.getElementById(`pricing-${selectedPricingStrategy}`);
            if (selectedBtn) {
                selectedBtn.classList.remove('bg-white', 'border-lime-200');
                selectedBtn.classList.add('bg-lime-200', 'border-lime-400', 'shadow-lg');
            }
            
            // Handle custom selection
            if (selectedPricingStrategy === 'custom') {
                const customContainer = document.getElementById('custom-percentage').parentElement.parentElement;
                customContainer.classList.remove('bg-white', 'border-lime-200');
                customContainer.classList.add('bg-lime-200', 'border-lime-400', 'shadow-lg');
            }
        }

        function getPricingPercentage(strategy) {
            switch(strategy) {
                case 'minimum': return 10;
                case 'regular': return 30;
                case 'ideal': return 130;
                case 'custom': return appData.quotation.customPercentage || 30;
                default: return 30;
            }
        }

        function formatQuoteText(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('quote-comments').focus();
            updateQuoteDisplay();
        }

        function updateQuoteDisplay() {
            const title = document.getElementById('quote-title').value || 'Cotizaci√≥n';
            const date = document.getElementById('quote-date').value;
            const validity = document.getElementById('quote-validity').value;
            const comments = document.getElementById('quote-comments').innerHTML;
            
            // Update display elements
            document.getElementById('display-quote-title').textContent = title;
            
            if (date) {
                const formattedDate = new Date(date).toLocaleDateString('es-ES', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                document.getElementById('display-quote-date').innerHTML = `<strong>${formattedDate}</strong>`;
            } else {
                document.getElementById('display-quote-date').innerHTML = '';
            }
            
            if (validity && validity.trim() !== '') {
                document.getElementById('display-quote-validity').textContent = `V√°lida por ${validity} d√≠as`;
            } else {
                document.getElementById('display-quote-validity').textContent = '';
            }
            
            if (comments && comments.trim() !== '' && comments !== '<br>') {
                document.getElementById('display-quote-comments').innerHTML = comments;
            } else {
                document.getElementById('display-quote-comments').innerHTML = '';
            }
            
            saveAllData();
        }

        function renderQuoteTable() {
            const tbody = document.getElementById('quote-table-body');
            tbody.innerHTML = '';
            
            const currencySymbol = getCurrencySymbol();
            let total = 0;
            
            projects.forEach((project, index) => {
                const basePrice = project.calculations.suggestedPrice;
                const markup = currentPricingPercentage / 100;
                const unitPrice = basePrice * (1 + markup);
                const quantity = appData.quotation.items[index]?.quantity || 1;
                const subtotal = unitPrice * quantity;
                total += subtotal;
                
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-lime-25';
                
                // Clean description text (remove HTML tags)
                const cleanDescription = project.description.replace(/<[^>]*>/g, '').substring(0, 100);
                
                row.innerHTML = `
                    <td class="px-4 py-3 border-b border-lime-100">
                        <div class="font-medium text-gray-800">${project.name}</div>
                        <div class="text-sm text-gray-600">${project.type === 'product' ? 'Producto' : 'Servicio'}</div>
                    </td>
                    <td class="px-4 py-3 border-b border-lime-100 text-center">
                        <input type="number" 
                               value="${quantity}" 
                               min="1" 
                               step="1"
                               onchange="updateQuoteItemQuantity(${index}, this.value)"
                               class="w-20 px-2 py-1 text-center border border-lime-300 rounded focus:outline-none focus:ring-1 focus:ring-lime-500">
                    </td>
                    <td class="px-4 py-3 border-b border-lime-100 text-center font-medium">
                        ${currencySymbol} ${unitPrice.toFixed(2)}
                    </td>
                    <td class="px-4 py-3 border-b border-lime-100 text-center font-bold">
                        ${currencySymbol} ${subtotal.toFixed(2)}
                    </td>
                    <td class="px-4 py-3 border-b border-lime-100 text-sm text-gray-600">
                        ${cleanDescription}${cleanDescription.length >= 100 ? '...' : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update total
            document.getElementById('quote-total').textContent = `${currencySymbol} ${total.toFixed(2)}`;
        }

        function updateQuoteItemQuantity(projectIndex, quantity) {
            const qty = parseInt(quantity) || 1;
            
            // Ensure quotation items array exists and has enough elements
            while (appData.quotation.items.length <= projectIndex) {
                appData.quotation.items.push({ quantity: 1 });
            }
            
            appData.quotation.items[projectIndex].quantity = qty;
            renderQuoteTable();
            saveAllData();
        }

        function printQuote() {
            const title = document.getElementById('display-quote-title').textContent;
            const date = document.getElementById('display-quote-date').innerHTML;
            const validity = document.getElementById('display-quote-validity').textContent;
            const comments = document.getElementById('display-quote-comments').innerHTML;
            
            // Create a clean table for printing (without input fields)
            const tbody = document.getElementById('quote-table-body');
            const currencySymbol = getCurrencySymbol();
            let total = 0;
            let printTableRows = '';
            
            projects.forEach((project, index) => {
                const basePrice = project.calculations.suggestedPrice;
                const markup = currentPricingPercentage / 100;
                const unitPrice = basePrice * (1 + markup);
                const quantity = appData.quotation.items[index]?.quantity || 1;
                const subtotal = unitPrice * quantity;
                total += subtotal;
                
                const cleanDescription = project.description.replace(/<[^>]*>/g, '').substring(0, 100);
                const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-lime-25';
                
                printTableRows += `
                    <tr class="${rowClass}">
                        <td class="px-4 py-3 border-b border-lime-100">
                            <div class="font-medium text-gray-800">${project.name}</div>
                            <div class="text-sm text-gray-600">${project.type === 'product' ? 'Producto' : 'Servicio'}</div>
                        </td>
                        <td class="px-4 py-3 border-b border-lime-100 text-center font-medium">
                            ${quantity}
                        </td>
                        <td class="px-4 py-3 border-b border-lime-100 text-center font-medium">
                            ${currencySymbol} ${unitPrice.toFixed(2)}
                        </td>
                        <td class="px-4 py-3 border-b border-lime-100 text-center font-bold">
                            ${currencySymbol} ${subtotal.toFixed(2)}
                        </td>
                        <td class="px-4 py-3 border-b border-lime-100 text-sm text-gray-600">
                            ${cleanDescription}${cleanDescription.length >= 100 ? '...' : ''}
                        </td>
                    </tr>
                `;
            });
            
            const tableHTML = `
                <table class="min-w-full w-full">
                    <thead class="bg-lime-100">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b border-lime-200">Producto/Servicio</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 border-b border-lime-200">Cantidad</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 border-b border-lime-200">Precio Unitario</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-700 border-b border-lime-200">Subtotal</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700 border-b border-lime-200">Descripci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${printTableRows}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td colspan="3" class="px-4 py-3 text-right font-semibold text-gray-700 border-t border-lime-200">Total:</td>
                            <td class="px-4 py-3 text-center font-bold text-lg text-gray-800 border-t border-lime-200">${currencySymbol} ${total.toFixed(2)}</td>
                            <td class="border-t border-lime-200"></td>
                        </tr>
                    </tfoot>
                </table>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>${title}</title>
                    <meta charset="UTF-8">
                    <style>
                        @page {
                            margin: 2cm;
                            size: A4;
                        }
                        
                        * {
                            box-sizing: border-box;
                        }
                        
                        body { 
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
                            margin: 0;
                            padding: 20px;
                            line-height: 1.6;
                            color: #333;
                            background: white;
                        }
                        
                        .header {
                            text-align: center;
                            margin-bottom: 40px;
                            padding-bottom: 20px;
                            border-bottom: 3px solid #84cc16;
                        }
                        
                        h1 { 
                            color: #365314;
                            margin: 0 0 15px 0;
                            font-size: 28px;
                            font-weight: 700;
                            text-transform: uppercase;
                            letter-spacing: 1px;
                        }
                        
                        .quote-info {
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 30px;
                            padding: 15px;
                            background: linear-gradient(135deg, #f7fee7 0%, #ecfccb 100%);
                            border-radius: 8px;
                            border-left: 4px solid #84cc16;
                        }
                        
                        .date { 
                            font-weight: 600;
                            color: #365314;
                            font-size: 16px;
                        }
                        
                        .validity { 
                            font-weight: 500;
                            color: #65a30d;
                            font-size: 14px;
                        }
                        
                        .comments { 
                            margin-bottom: 30px; 
                            padding: 20px; 
                            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
                            border-radius: 8px;
                            border-left: 4px solid #64748b;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        
                        .comments h3 {
                            margin: 0 0 10px 0;
                            color: #475569;
                            font-size: 16px;
                            font-weight: 600;
                        }
                        
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            border-radius: 8px;
                            overflow: hidden;
                        }
                        
                        th { 
                            background: #84cc16;
                            color: white;
                            font-weight: 600;
                            padding: 15px 12px;
                            text-align: left;
                            font-size: 14px;
                            text-transform: uppercase;
                            letter-spacing: 0.5px;
                        }
                        
                        th:nth-child(2) {
                            width: auto;
                            text-align: center;
                        }
                        
                        td { 
                            border-bottom: 1px solid #e5e7eb;
                            padding: 12px;
                            font-size: 14px;
                        }
                        
                        tbody tr:nth-child(even) {
                            background-color: #f9fafb;
                        }
                        
                        tbody tr:hover {
                            background-color: #f3f4f6;
                        }
                        
                        .text-center { 
                            text-align: center; 
                        }
                        
                        .font-bold { 
                            font-weight: 700; 
                        }
                        
                        tfoot td { 
                            background: #84cc16;
                            font-weight: 700;
                            font-size: 16px;
                            color: white;
                            border-top: 2px solid #65a30d;
                            padding: 15px 12px;
                        }
                        
                        .footer {
                            margin-top: 40px;
                            text-align: center;
                            padding-top: 20px;
                            border-top: 2px solid #e5e7eb;
                            color: #6b7280;
                            font-size: 12px;
                        }
                        
                        .company-info {
                            margin-bottom: 20px;
                            text-align: center;
                            color: #6b7280;
                            font-size: 14px;
                        }
                        
                        /* Print-specific styles */
                        @media print {
                            body {
                                -webkit-print-color-adjust: exact;
                                print-color-adjust: exact;
                            }
                            
                            .header {
                                page-break-after: avoid;
                            }
                            
                            table {
                                page-break-inside: avoid;
                            }
                            
                            tr {
                                page-break-inside: avoid;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>${title}</h1>

                    </div>
                    
                    <div class="quote-info">
                        <div class="date">${date}</div>
                        <div class="validity">${validity}</div>
                    </div>
                    
                    ${comments ? `<div class="comments"><h3>üìù Comentarios:</h3>${comments}</div>` : ''}
                    
                    ${tableHTML}
                    

                </body>
                </html>
            `);
            
            printWindow.document.close();
            
            // Wait for content to load, then print
            printWindow.onload = function() {
                printWindow.print();
                
                // Close window after print dialog is closed
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
                
                // Alternative method for browsers that don't support onafterprint
                const checkClosed = setInterval(() => {
                    if (printWindow.closed) {
                        clearInterval(checkClosed);
                        return;
                    }
                    
                    // Check if print dialog was cancelled by monitoring focus
                    try {
                        if (printWindow.document && printWindow.document.hasFocus && printWindow.document.hasFocus()) {
                            // Print dialog was likely cancelled, close the window
                            setTimeout(() => {
                                if (!printWindow.closed) {
                                    printWindow.close();
                                }
                            }, 1000);
                            clearInterval(checkClosed);
                        }
                    } catch (e) {
                        // Cross-origin or other error, fallback to timeout
                        clearInterval(checkClosed);
                        setTimeout(() => {
                            if (!printWindow.closed) {
                                printWindow.close();
                            }
                        }, 2000);
                    }
                }, 500);
                
                // Ultimate fallback: close window after 10 seconds
                setTimeout(() => {
                    clearInterval(checkClosed);
                    if (!printWindow.closed) {
                        printWindow.close();
                    }
                }, 10000);
            };
        }

        // Load all data when page loads
        window.addEventListener('load', function() {
            loadAllData();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98e153b5a7e1cc7a',t:'MTc2MDM4NDYxNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
